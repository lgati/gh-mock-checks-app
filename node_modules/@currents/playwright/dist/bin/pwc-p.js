#! /usr/bin/env node
"use strict";var uo=Object.create;var q=Object.defineProperty;var lo=Object.getOwnPropertyDescriptor;var go=Object.getOwnPropertyNames;var mo=Object.getPrototypeOf,fo=Object.prototype.hasOwnProperty;var a=(e,t)=>()=>(e&&(t=e(e=0)),t);var se=(e,t)=>{for(var r in t)q(e,r,{get:t[r],enumerable:!0})},ht=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of go(t))!fo.call(e,s)&&s!==r&&q(e,s,{get:()=>t[s],enumerable:!(o=lo(t,s))||o.enumerable});return e};var c=(e,t,r)=>(r=e!=null?uo(mo(e)):{},ht(t||!e||!e.__esModule?q(r,"default",{value:e,enumerable:!0}):r,e)),ho=e=>ht(q({},"__esModule",{value:!0}),e);var n=a(()=>{"use strict"});var B,yt=a(()=>{"use strict";n();B=class extends Error{}});var wt,xt=a(()=>{"use strict";n();wt={guide:{ciBuildId:"https://docs.currents.dev/guides/ci-build-id",integration:"https://docs.currents.dev/integration-with-playwright/currents-playwright"}}});function Ct(e){yo.push(e)}var yo,ie=a(()=>{"use strict";n();yo=[]});var Rt,bt,St=a(()=>{"use strict";n();Rt=[],bt=[]});var w,G,ae,h,g,x,H,wo,P,pn,un,ln,dn,gn,mn,fn,hn,yn,l,wn,It=a(()=>{"use strict";n();w=c(require("chalk")),G=c(require("util"));f();ie();St();ae=(...e)=>{let t=G.default.format(...e);Ct(t),console.log(t)},h=ae,g=(...e)=>{let t=G.default.format(...e);return bt.push(t),p("WARNING: ",t),ae(w.default.bgYellow.black(" WARNING "),t)},x=(...e)=>{let t=G.default.format(...e);return Rt.push(t),p("ERROR: ",t),ae(w.default.bgRed.white(" ERROR "),t)},H=()=>console.log(`
`+wo()+`
`),wo=()=>w.default.dim(Array(64).fill("=").join("")),P=(e=2)=>console.log(Array(e).fill("").join(`
`)),pn=w.default.cyan,un=w.default.blueBright,ln=w.default.red,dn=w.default.yellow,gn=w.default.green,mn=w.default.gray,fn=w.default.white,hn=w.default.black,yn=w.default.magenta,l=w.default.dim,wn=w.default.bold});var C=a(()=>{"use strict";n();ie();It()});function J(e){if(!e)return;if(e==="false")return!1;let t=parseInt(e,10);if(isNaN(t)||t<1)throw new ce.CommanderError(255,"Invalid argument provided.","--pwc-cancel-after-failures must be a positive integer or 'false', provided: "+e);return t}function Et(e){if(!e)return;let t=["SIGUSR1","SIGUSR2"];if(!t.includes(e.toUpperCase().trim()))throw new ce.CommanderError(255,"Invalid argument provided.","--pwc-reset-signal must be one of ("+t.join(", ")+"), provided: "+e);return e.toUpperCase().trim()}var ce,pe=a(()=>{"use strict";n();ce=require("commander")});function S(e){return R[e]?.env}function vt(e){return R[e].cli}function Ot(e){return R[e].name}function kt(){return{projectId:process.env[R.projectId.env],recordKey:process.env[R.recordKey.env],ciBuildId:process.env[R.ciBuildId.env],tag:process.env[R.tag.env]?process.env[R.tag.env]?.split(",").map(e=>e.trim()):void 0,cancelAfterFailures:J(process.env[R.cancelAfterFailures.env]),disableTitleTags:process.env[R.disableTitleTags.env],testSuiteFile:process.env[R.testSuiteFile.env],machineId:process.env[R.machineId.env],orchestrationId:process.env[R.orchestrationId.env]}}var R,ue=a(()=>{"use strict";n();pe();R={currentsConfigFile:{name:"Currents Config File Path",env:"CURRENTS_CONFIG_FILE_PATH",cli:"--pwc-config"},ciBuildId:{name:"CI Build ID",env:"CURRENTS_CI_BUILD_ID",cli:"--ci-build-id"},recordKey:{name:"Record Key",env:"CURRENTS_RECORD_KEY",cli:"--key"},projectId:{name:"Project ID",env:"CURRENTS_PROJECT_ID",cli:"--project-id"},tag:{name:"Currents Tag",env:"CURRENTS_TAG",cli:"--tag"},cancelAfterFailures:{name:"Currents Cancel After Failures",env:"CURRENTS_CANCEL_AFTER_FAILURES",cli:"--pwc-cancel-after-failures"},disableTitleTags:{name:"Disable Title Tags",env:"CURRENTS_DISABLE_TITLE_TAGS",cli:"--pwc-disable-title-tags"},testSuiteFile:{name:"Test Suite File",env:"CURRENTS_TEST_SUITE_FILE",cli:"--pwc-test-suite-file"},machineId:{name:"Machine ID",env:"CURRENTS_MACHINE_ID",cli:"--pwc-machine-id"},orchestrationId:{name:"Orchestration ID",env:"CURRENTS_ORCHESTRATION_ID",cli:"--pwc-orchestration-id"},outputFile:{name:"Output File",env:"CURRENTS_OUTPUT_FILE",cli:"--pwc-output-file"}}});function Dt(e){return{ciBuildId:e.ciBuildId,projectId:e.projectId,recordKey:e.key,tag:e.tag,removeTitleTags:e.pwcRemoveTitleTags,cancelAfterFailures:e.pwcCancelAfterFailures,disableTitleTags:e.pwcDisableTitleTags,testSuiteFile:e.pwcTestSuiteFile,machineId:e.pwcMachineId,outputFile:e.pwcOutputFile,pwcConfigPath:e.pwcConfig,orchestration:{resetSignal:e.pwcResetSignal,skipReporterInjection:e.pwcSkipReporterInjection},coverage:{projects:e.pwcCoverage,dir:e.pwcCoverageDir}}}function K(){if(le)return le;if(process.env.CURRENTS_PWC_CLI_CONFIG_PATH)try{let e=JSON.parse(Nt.default.readFileSync(process.env.CURRENTS_PWC_CLI_CONFIG_PATH).toString());return _t("Options from serialized CLI config file: %o",e),le=e,e}catch(e){return _t("Could not read CLI config file: %o",e),{}}return{}}var Nt,_t,le,de=a(()=>{"use strict";n();Nt=c(require("fs"));f();_t=p.extend("cli-options-serializer");le=null});function Ft(e,t,r={validationFn:Co}){ge("reporter options: %o",e),ge("config file options: %o",t);let o={...b(me),...b(t),...b(e),...b(K()),...b(kt()),orchestration:{...b(me.orchestration),...b(t?.orchestration),...b(e?.orchestration),...b(K().orchestration)},coverage:{...b(me.coverage),...b(t?.coverage),...b(e?.coverage),...b(K().coverage)}};r.validationFn(o),fe=o,ge("resolved currents config: %o",fe)}function Co(e){xo.forEach(t=>{if(!e[t])throw x(`${Ot(t)} is required for Currents Reporter. Use the following methods:
  - as environment variable: ${l(S(t))}
  - as CLI flag of pwc command: ${l(vt(t))}
  - as reporter configuration option ${l(t)} in ${l("playwright.config.ts")}
  
  \u{1F4D6} ${wt.guide.integration}`),new B("Missing required config variable")})}function b(e){return Object.entries(e??{}).reduce((t,[r,o])=>o===void 0?t:{...t,[r]:o},{})}function E(){return fe}var ge,xo,me,fe,Pt=a(()=>{"use strict";n();f();yt();xt();C();ue();de();ge=p.extend("config"),xo=["projectId","recordKey"],me={removeTitleTags:!1,disableTitleTags:!1,orchestration:{skipReporterInjection:!1},coverage:{projects:!1}},fe=null});function Ut(e,t){return e.reduceRight(([r,o],s)=>(o.includes(s,-1)?o.splice(o.lastIndexOf(s)):r.unshift(s),[r,o]),[[],[...t]])[0]}var Ro,Lt=a(()=>{"use strict";n();Ro=require("lodash");C()});var v=a(()=>{"use strict";n();Pt();ue();de();Lt()});var jt,At=a(()=>{jt={name:"@currents/playwright",version:"1.12.1",main:"./dist/index.js",author:{name:"Currents Software Inc",email:"hello@currents.dev",url:"https://currents.dev"},license:"MIT",homepage:"https://currents.dev",repository:{type:"git",url:"https://github.com/currents-dev/currents-playwright-changelog.git"},scripts:{test:"vitest",rm:"rimraf dist",lint:'TIMING=1 eslint "**/*.ts*"',build:"tsup-node --minify --dts",dev:"tsup-node --watch --dts",release:"release-it --verbose","publish:npm":"npm run rm  && npm run build && ./publish.js","release-ci":"npm run rm && npm run build && ./publish.js -t latest"},bin:{pwc:"./dist/bin/pwc.js","pwc-p":"./dist/bin/pwc-p.js"},devDependencies:{"@playwright/test":"^1.44.0","@release-it/conventional-changelog":"^7.0.2","@types/async-retry":"^1.4.5","@types/babel__code-frame":"^7.0.3","@types/debug":"^4.1.12","@types/getos":"^3.0.4","@types/json-stringify-safe":"^5.0.3","@types/lodash":"^4.17.15","@types/pluralize":"^0.0.33","@types/proxy-from-env":"^1.0.4","@types/randomstring":"^1.3.0","@types/shelljs":"^0.8.15","@types/stack-utils":"^2.0.3","@types/tmp":"^0.2.6","@types/ws":"^8.18.0",eslint:"^9.23.0","eslint-config-custom":"*",msw:"^2.7.1","release-it":"^18.1.2",rimraf:"^6.0.1",tsconfig:"*",tsup:"^8.3.5",typescript:"^5.8.2",vitest:"^3.0.9",wtfnode:"^0.10.0"},dependencies:{"@babel/code-frame":"^7.18.6","@commander-js/extra-typings":"^12.1.0","@currents/commit-info":"1.0.1-beta.0","async-retry":"^1.3.3",axios:"^1.8.3","axios-retry":"^4.5.0",c12:"^1.11.2",chalk:"^4.1.2",commander:"^12.1.0","date-fns":"^4.1.0",debug:"^4.3.7",dotenv:"^16.0.3",execa:"^9.5.2",getos:"^3.2.1","https-proxy-agent":"^7.0.5","istanbul-lib-coverage":"^3.2.2","json-stringify-safe":"^5.0.1","lil-http-terminator":"^1.2.3",lodash:"^4.17.21",nanoid:"^3.3.8","object-sizeof":"^2.6.5","p-debounce":"^2.1.0","p-map":"^4.0.0","p-queue":"6.6.2",pino:"^9.6.0",pluralize:"^8.0.0","pretty-ms":"^7.0.1","proxy-from-env":"^1.1.0","source-map-support":"^0.5.21","stack-utils":"^2.0.6",tmp:"^0.2.3","tmp-promise":"^3.0.3","ts-pattern":"^5.7.0",ws:"^8.18.1"},files:["dist","!**/*.map","!**/*/*.map","**/*.LEGAL.txt","LICENSE.md","README.md","CHANGELOG.md"],keywords:["playwright","playwright dashboard","cloud dashboard","reporter","currents","tests reporter","sorry cypress","ci"],exports:{".":{import:"./dist/index.js",require:"./dist/index.js"},"./discovery":{import:"./dist/reporters/discovery.js",require:"./dist/reporters/discovery.js"},"./orchestration":{import:"./dist/orchestration/index.js",require:"./dist/orchestration/index.js"},"./package.json":"./package.json"},publishConfig:{access:"public",registry:"https://registry.npmjs.org"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"../../CHANGELOG.md"}},git:{commitMessage:"chore: release v${version}",tagName:"v${version}"},hooks:{"before:github:release":"npm run --prefix ../../ update-public-changelog"}}}});var z,he=a(()=>{"use strict";n();At();z=jt.version});function V(e={}){let t=$t.default.create(e);return t.interceptors.request.use(r=>{let o={...r},s=t.getUri(r),u=Wt.default.getProxyForUrl(s);return u&&(So("Using HTTP proxy %s for %s ",u,s),o.proxy=!1,o.httpsAgent=Io(u)),o}),t}function Io(e){return X||(X=new Mt.HttpsProxyAgent(e),X)}var $t,Mt,Wt,So,X,ye=a(()=>{"use strict";n();$t=c(require("axios")),Mt=require("https-proxy-agent"),Wt=c(require("proxy-from-env"));f();So=p.extend("axios");X=null});var we,qt,Bt=a(()=>{"use strict";n();we=()=>process.env.CURRENTS_API_URL??"https://cy.currents.dev",qt=()=>3e4});var Gt,Ht,Jt=a(()=>{"use strict";n();Gt=c(require("events"));f();xe();Ht=new Gt.default});var Ce,zt,Kt,Xt,Vt=a(()=>{"use strict";n();C();Jt();Ce={cancellationReason:null},zt=e=>{Ce.cancellationReason||(Ce.cancellationReason=e)},Kt=()=>Ce.cancellationReason,Xt=({showWarning:e=!0}={})=>{let t=Kt();t&&(e&&g("%s",t),Ht.emit("runCancelled",t))}});var xe=a(()=>{"use strict";n();Vt()});var Yt,ys,To,Zt,Qt=a(()=>{"use strict";n();Yt=require("async_hooks"),ys=new Yt.AsyncLocalStorage,To=new Map,Zt=e=>{let t=To.get(e);return t?t.getStore():null}});var er,U,Re=a(()=>{"use strict";n();er=require("nanoid"),U=(0,er.customAlphabet)("abcdefghijklmnopqrstuvwxyz",10)});function sr(e){(0,y.match)(e).when(rr.isAxiosError,Eo).otherwise(()=>{g("Unexpected error while sending network request: %s",e)})}function Eo(e){return(0,y.match)(e).with({code:"ECONNABORTED"},()=>{g("Network connection aborted")}).with({code:"ECONNREFUSED"},()=>{g("Network connection aborted")}).with({code:"ECONNRESET"},()=>{g("Network connection reset")}).with({code:"ETIMEDOUT"},()=>{g("Network connection timeout")}).with({response:y.P.not(y.P.nullish)},t=>{vo(t,{status:t.response.status,data:t.response.data})}).otherwise(t=>{g(`[currents] Unexpected network error: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,payload:e.response?.config.data,requestId:L(e)})})}function vo(e,{status:t,data:r}){(0,y.match)(t).with(401,()=>{g(`[currents] ${e.response?.config.method} ${e.response?.config.url}} - 401 Unauthorized Request from cloud service`)}).with(400,()=>{g(`[currents] ${e.response?.config.method} ${e.response?.config.url} - 400 Bad Request from cloud service:
%o`,r)}).with(429,()=>{g(`[currents] ${e.response?.config.method} ${e.response?.config.url} - 429 Too Many Requests from cloud service`)}).with(422,()=>{Oo(e,r)}).otherwise(()=>{g(`[currents] Unexpected network response: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,requestId:L(e)})})}function Oo(e,t){(0,y.match)(t).with({code:be.MISSING_SUITE,message:y.P.string,errors:y.P.array(y.P.string)},async r=>{let{message:o,errors:s}=r,u=Zt("discovery");P(1),x(...tr(o,s)),Y({id:U(),text:(0,or.default)(u,null,2)}).then(d=>{x(`Please share this URL with Currents support for further investigation:
${d}`)}).catch(d=>{g("Failed to upload debug artifact: %s",d)}),P(1)}).with({code:be.RUN_CANCELLED,message:y.P.string},r=>{zt(r.message),Xt()}).with({code:be.RUN_EXPIRED,message:y.P.string},r=>{g(r.message)}).with({message:y.P.string,errors:y.P.array(y.P.string)},r=>{let{message:o,errors:s}=r;P(1),g(...tr(o,s)),P(1)}).otherwise(()=>{g(`[currents] Unexpected network response: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,requestId:L(e)})})}function tr(e,t){return nr.default.isString(e)?t?.length===0?[e]:[e,`
${(t??[]).map(r=>`  - ${r}`).join(`
`)}
`]:["Unexpected network error"]}function L(e){return e?.response?.headers["apigw-requestid"]}var rr,or,nr,y,be,Se=a(()=>{"use strict";n();rr=require("axios"),or=c(require("json-stringify-safe")),nr=c(require("lodash")),y=require("ts-pattern");xe();Qt();Re();C();Ie();be={RUN_CANCELLED:"RUN_CANCELLED",RUN_EXPIRED:"RUN_EXPIRED",MISSING_SUITE:"MISSING_SUITE"}});function pr(e,t,r){let o=r.method?.toUpperCase(),s=r.url,u=L(t),d=(0,ir.default)(Ee(e)),I=`Network request '${o} ${s}' failed: '${t.message}'.${u?` Request ID: ${u}.`:""} Next attempt is in ${d} (${e}/${r["axios-retry"]?.retries||ve()}).`;ar(I),g(I)}var Te,ir,ar,Ee,cr,ve,ur=a(()=>{"use strict";n();Te=require("axios"),ir=c(require("pretty-ms"));f();C();Se();ar=p.extend("http"),Ee=e=>[3*1e3,15*1e3,30*1e3][e-1],cr=e=>(ar("isRetriableError: %o",{message:e.message,code:"code"in e?e.code:void 0,status:"response"in e?e.response?.status:void 0,headers:"response"in e?e.response?.headers:void 0,data:"response"in e?e.response?.data:void 0,isAxiosError:(0,Te.isAxiosError)(e)}),"code"in e&&e.code&&["ECONNABORTED","ECONNREFUSED","ECONNRESET","ETIMEDOUT","ENETRESET","ENOTFOUND","EAI_AGAIN"].includes(e.code)?!0:(0,Te.isAxiosError)(e)?[429,500,502,503,504].includes(e.response?.status??0):!1),ve=()=>3});function Fo(){let e=V({baseURL:we(),timeout:qt(),transitional:{clarifyTimeoutError:!0}});return e.interceptors.request.use(async t=>{let{currentsOptions:r}=t,o={...Do,...r};return o.enableCompression&&(0,yr.default)(t.data)>o.compressThresholdBytes?(t.headers["Content-Encoding"]="gzip",{...t,data:await No((0,mr.default)(t.data))}):t}),e.interceptors.request.use(t=>{let r=t["axios-retry"]?.retryCount??0,o=E();t.headers.set({..._o,"Accept-Encoding":"gzip, deflate, br","x-currents-idempotency-key":t.headers["x-currents-idempotency-key"]??(0,hr.nanoid)(),"x-pwc-request-attempt":r,"x-currents-key":o?.recordKey??null}),o?.orchestrationId&&t.headers.set("x-currents-orchestration-id",o.orchestrationId),o?.machineId&&t.headers.set("x-currents-machine-id",o.machineId),t.headers.get("Content-Type")||t.headers.set("Content-Type","application/json");let s={...fr.default.pick(t,"method","url","headers"),data:Buffer.isBuffer(t.data)?"buffer":t.data};return r?lr("network request retry: %o",dr({...s,isRetry:!0})):lr("network request: %o",dr(s)),t}),(0,gr.default)(e,{retries:ve(),retryCondition:cr,retryDelay:Ee,shouldResetTimeout:!0,onRetry:pr}),e}function Cr(){return Z||(Z=Fo(),Z)}function dr(e){return{method:e.method,baseUrl:we(),url:e.url,data:e.isRetry?"<retry>":Po(e.data),headers:{...e.headers,"x-currents-key":"***"}}}function Po(e){return e?.results?.raw?{...e,results:{...e.results,raw:"***"}}:e}var gr,mr,fr,hr,yr,wr,xr,lr,ko,_o,No,Z,Do,Rr=a(()=>{"use strict";n();gr=c(require("axios-retry")),mr=c(require("json-stringify-safe")),fr=c(require("lodash")),hr=require("nanoid"),yr=c(require("object-sizeof")),wr=require("util"),xr=c(require("zlib"));v();f();he();ye();Bt();ur();lr=p.extend("http"),ko=1024*1024*1,_o={"x-pw-version":"0.0.0","x-pwc-version":z},No=(0,wr.promisify)(xr.default.gzip),Z=null,Do={enableCompression:!1,compressThresholdBytes:ko}});async function k(e,t=Cr){try{let r=await t().request(e);return br("network response: %o",{...Sr.default.omit(r,"request","config"),url:r.config.url,method:r.config.method}),r}catch(r){let o=r;throw br("network error: %o",{code:o.code,message:o.message,url:o.config?.url,method:o.config?.method,status:o.response?.status,headers:o.response?.headers,data:o.response?.data}),sr(o),o}}var Sr,br,Ir=a(()=>{"use strict";n();Sr=c(require("lodash"));f();Rr();Se();br=p.extend("http")});var Oe=a(()=>{"use strict";n();Ir()});var Tr={};se(Tr,{getDebugUrl:()=>Uo});var Uo,Er=a(()=>{"use strict";n();Oe();Uo=({runId:e,type:t})=>k({method:"POST",url:"runs/debug-logs",data:{type:t,runId:e}}).then(r=>r.data)});function Lo(e,t){return _r({path:e,name:null,uploadUrl:t,contentType:"text/plain"},"text/plain",void 0)}async function _r(e,t,r){let o=await Or.default.readFile(e.path);return ke("Uploading file %s",e.uploadUrl,{buffer:Buffer.byteLength(o)}),Nr(o,e.uploadUrl,t,r)}async function Ao(e,t,r){return ke("Uploading buffer %s",e.name,{buffer:Buffer.byteLength(e.buffer)}),Nr(e.buffer,e.uploadUrl,t,r)}async function jo(e,t,r,o){return V().request({method:"put",url:t,data:e,onUploadProgress:o,headers:{"Content-Disposition":"inline","Content-Type":r}})}async function Nr(...e){await(0,vr.default)(async()=>{await jo(...e)},{retries:5,onRetry:(t,r)=>{if(ke("Upload failed %d out of 5 attempts: %s",r,t.message),r===5){x(`Cannot upload after ${r} times: ${t.message}`);return}g(`Upload failed ${r} out of 5 attempts: ${t.message}`)}})}var vr,Or,ke,kr,Dr=a(()=>{"use strict";n();vr=c(require("async-retry")),Or=c(require("fs/promises"));f();ye();C();ke=p.extend("upload"),kr=(s=>(s.PNG="image/png",s.WEBM="video/webm",s.TEXT="text/plain",s.ZIP="application/zip",s))(kr||{})});var Fr={};se(Fr,{ContentType:()=>kr,sendBuffer:()=>Ao,sendPath:()=>_r,uploadText:()=>Lo});var Pr=a(()=>{"use strict";n();Dr()});async function Y(e){let{getDebugUrl:t}=await Promise.resolve().then(()=>(Er(),Tr));try{let{readUrl:r,uploadUrl:o}=await t({runId:e.id,type:"pw-debug"}),{uploadText:s,sendBuffer:u}=await Promise.resolve().then(()=>(Pr(),Fr));return"text"in e&&await u({name:`${e.id}-discovery-debug.log`,buffer:Buffer.from(e.text,"utf-8"),contentType:"text/plain",uploadUrl:o},"text/plain",void 0),"path"in e&&await s(e.path,o),r}catch{return null}}var _e,Ne=a(()=>{"use strict";n();_e=c(require("debug"))});function $o(e){return e==="false"?!1:e==="remote"?"remote":e==="full"?"full":!!e}var Ur,_,De=a(()=>{"use strict";n();Ur=require("@commander-js/extra-typings"),_=new Ur.Option("--pwc-debug [boolean | 'remote' | 'full']","enable debug logs for the reporter. Specify 'remote' to upload logs to Currents. Specify 'full' to dump the debug logs to stdout and upload to Currents.").argParser($o).env("CURRENTS_DEBUG")});var Lr,Ar,jr=a(()=>{"use strict";n();Lr=require("@commander-js/extra-typings");De();Ar=()=>new Lr.Command().allowUnknownOption().addOption(_).helpOption(!1)});var T,$r,Pe,Mr,Wr,Fe,O,Q=a(()=>{"use strict";n();T=c(require("debug")),$r=c(require("fs")),Pe=c(require("path")),Mr=c(require("util")),Wr=require("fs/promises");Re();C();jr();Ne();T.default.useColors=function(){return!1};Fe=T.default.log,O=class e{constructor(t="core"){this.source=t;this.pipelines={};if(this.mode=Ar().parse().opts().pwcDebug??!1,this.debug=(0,T.default)(`currents:remote-debug:${this.source}`),!this.mode)return this;if(!this.shouldEnableDebug())return this;let r=process.env.DEBUG?`${process.env.DEBUG},currents*`:"currents*";if(T.default.enable(r),!this.shouldUploadRemoteDebug())return this;let o=U(),s=Pe.default.resolve(".currents-debug"),u=Pe.default.resolve(s,`${o}.log`);(0,Wr.mkdir)(s,{recursive:!0}),h(l(`\u{1F47E} Initiated remote ${this.source} debug log collection:`),l(u));let d=$r.default.createWriteStream(u,{flags:"a"});return T.default.log=(...I)=>{this.mode&&(d.write(`${Mr.default.formatWithOptions({colors:!1},...I)}
`),this.shouldMuteLocalStdout()||Fe(...I))},this.pipelines[o]={id:o,writeStream:d,type:this.source,tempFilePath:u},this}static factory(t="core"){return this.instance||(this.instance=new e(t)),this.instance}getDebugMode(){return this.mode}async finalize({runId:t}={runId:void 0}){try{let r=Object.keys(this.pipelines);r.length===0&&(this.debug("No debug pipelines found"),T.default.log=Fe);for(let o of r)await this.uploadDebug(o,t??U())}catch{}finally{T.default.log=Fe}}async uploadDebug(t,r){let o=this.pipelines[t];if(!o){this.debug("No debug pipeline found for id %s",t);return}h(l(`\u{1F47E} ${o.type} debug log written:`),l(o?.tempFilePath));try{let s=await Y({id:r,path:o.tempFilePath});o?.writeStream.end(),h(l(`\u{1F47E} ${o.type} debug log uploaded:`),l(s))}catch(s){g(`Failed to upload ${o.type}} debug log ${l(o.tempFilePath)}: ${s.message}`)}}shouldEnableDebug(){return this.mode==="full"||this.mode==="remote"||this.mode===!0}shouldUploadRemoteDebug(){return this.mode==="full"||this.mode==="remote"}shouldMuteLocalStdout(){return this.mode==="remote"}}});var Ie=a(()=>{"use strict";n();Ne();Q()});var p,f=a(()=>{"use strict";n();Ie();p=(0,_e.default)("currents")});var zo={};se(zo,{runScript:()=>po});module.exports=ho(zo);n();var rc=require("source-map-support/register"),mt=require("commander");f();C();Q();n();n();n();var Mo=c(require("ws"));f();var Di=p.extend("ws");n();var qr=c(require("http"));f();var Br=c(require("lil-http-terminator")),ee=require("ts-pattern"),Gr=c(require("ws")),$=p.extend("wss"),j=null,A=null,Ue=null,N=()=>(0,ee.match)(j?.address()).with({port:ee.P.number},e=>e.port).otherwise(()=>0),Hr=async()=>{if($("terminating wss server: %d",N()),!Ue){$("no wss server");return}let{success:e,code:t,message:r,error:o}=await Ue.terminate();e||(t==="TIMED_OUT"&&o(r),t==="SERVER_ERROR"&&o(r,o),t==="INTERNAL_ERROR"&&o(r,o)),$("terminated wss server: %d",N())},Jr=e=>{A||(j=qr.default.createServer().on("listening",()=>{if(!j)throw new Error("Server not initialized");A=new Gr.WebSocketServer({server:j}),$("starting wss on port %d",N()),A.on("connection",function(r){r.on("message",function(s){e.forEach(u=>u(s.toString()))})}),A.on("close",()=>{$("wss closed"),A=null})}).listen(),Ue=(0,Br.default)({server:j}))};n();var Qr=c(require("fs"));v();f();n();var Le=c(require("fs")),Kr=require("tmp-promise"),zr=async()=>{let{path:e}=await(0,Kr.file)();return e};n();var et=require("@commander-js/extra-typings"),tt=c(require("chalk"));he();C();n();var m=require("@commander-js/extra-typings");v();pe();De();var Ae=new m.Option("--pwc-config <path>","path to currents config file (currents.config.[ts|js])").env(S("currentsConfigFile")),je=new m.Option("--ci-build-id <id>","the unique identifier for a run").env(S("ciBuildId")),$e=new m.Option("-k, --key <record-key>","your secret Record Key obtained from Currents").env(S("recordKey")),Me=new m.Option("-p, --project-id <project>","the project ID for results reporting obtained from Currents").env(S("projectId")),We=new m.Option("-t, --tag <tag>","comma-separated tag(s) for recorded runs in Currents").argParser(Ye),qe=new m.Option("--pwc-remove-title-tags","remove tags from test names in Currents, e.g. `Test name @smoke` becomes `Test name` in the dashboard"),Be=new m.Option("--pwc-disable-title-tags","disable parsing tags from test title, e.g. `Test name @smoke` would not be tagged with `smoke` in the dashboard"),Ge=new m.Option("--pwc-cancel-after-failures <number | false>","abort the cloud run after the specified number of failed tests detected. Overrides the default Currents Project settings. If set, must be a positive integer or 'false' to disable automatic cancellations").env(S("cancelAfterFailures")).argParser(J),He=new m.Option("--pwc-output-file <string>","path to the file where the run summary output will be written.").env(S("outputFile")),Je=new m.Option("--pwc-test-suite-file <path>","path to the full test suite file for orchestration and reporting").env(S("testSuiteFile")).hideHelp(),Ke=new m.Option("--pwc-machine-id <string>","unique identifier of the machine running the tests. If not provided, it will be generated automatically. See: https://docs.currents.dev/?q=machineId").env(S("machineId")),ze=new m.Option("--pwc-orchestration-id <string>","unique identifier of the orchestration session this run belongs to. See: https://docs.currents.dev/?q=orchestrationId").env(S("orchestrationId")).hideHelp();var Xe=new m.Option("--pwc-inspect","enable inspect mode, run playwright with --inspect-brk flag or developments and debugging").default(!1).hideHelp(),Xr=new m.Option("--pwc-reset-signal <'SIGUSR1' | 'SIGUSR2'>","specify a process signal to listen for to trigger a reset of the current in progress tests. Only avaiable on OSes with POSIX signal support.").argParser(Et),Ve=new m.Option("--reporter <reporter>","Reporter to use, comma-separated").argParser(Ye).hideHelp(),Vr=new m.Option("--last-failed","Run last failed tests").default(!1).hideHelp(),Yr=new m.Option("--pwc-skip-reporter-injection","Do no inject @currents/playwright reporter via CLI, use the reporter specified in the playwright config");function Ye(e,t=[]){return e?t.concat(e.split(",").map(r=>r.trim())):t}var Ze=new m.Option("--pwc-coverage [projects...]","Comma-separated list of projects to collect coverage for, e.g. `project1,project2`. If no projects are specified, coverage will be collected for all projects.").argParser(Ye),Qe=new m.Option("--pwc-coverage-dir <path>","Path to the directory where coverage reports will be read from");var rt=(e=ot())=>e.version(z),Wo=`
----------------------------------------------------
\u{1F4D6} Documentation: https://docs.currents.dev
\u{1F919} Support:       support@currents.dev
----------------------------------------------------

${tt.default.bold("Examples")}

Run all tests in the current directory:
${l("pwc --key <record-key> --project-id <id> --ci-build-id <build-id>")}

Run only tests filtered by the tag "@smoke":
${l("pwc --key <record-key> --project-id <id> --ci-build-id <build-id> --grep smoke")}

Run playwright tests and add tags "tagA", "tagB" to the recorded run:
${l("pwc --key <record-key> --project-id <id> --ci-build-id <build-id> --tag tagA --tag tagB")}

Provide playwright arguments and flags:
${l("pwc --key <record-key> --project-id <id> --ci-build-id <build-id> -- --workers 2 --timeout 10000 --shard 1/2")}
`,qo=`
----------------------------------------------------
\u{1F4D6} Documentation: https://docs.currents.dev
\u{1F919} Support:       support@currents.dev
----------------------------------------------------

${tt.default.bold("Examples")}

Orchestrate all tests in the current directory:
${l("pwc-p --key <record-key> --project-id <id> --ci-build-id <build-id>")}

Orchestrate only tests filtered by the tag "@smoke":
${l("pwc-p --key <record-key> --project-id <id> --ci-build-id <build-id> --grep smoke")}

Orchestrate playwright tests and add tags "tagA", "tagB" to the recorded run:
${l("pwc-p --key <record-key> --project-id <id> --ci-build-id <build-id> --tag tagA --tag tagB")}

Add additional playwright arguments and flags:
${l("pwc-p --key <record-key> --project-id <id> --ci-build-id <build-id> -- --workers 2 --timeout 10000")}
`,ot=()=>new et.Command().name("pwc").usage("[options] [playwright arguments and flags]").allowUnknownOption().showHelpAfterError("(add --help for additional information)").description(`\u{1F3AD} Run Playwright tests on CI using https://currents.dev
${Wo}`).addOption(je).addOption($e).addOption(Me).addOption(We).addOption(Ae).addOption(qe).addOption(Be).addOption(Ge).addOption(He).addOption(Je).addOption(Ke).addOption(ze).addOption(Xe).addOption(_).addOption(Ze).addOption(Qe).addOption(Ve),Zr=()=>new et.Command().name("pwc-p").usage("[options] [playwright arguments and flags]").allowUnknownOption().showHelpAfterError("(add --help for additional information)").description(`\u2728 Orchestrate \u{1F3AD} Playwright tests on CI using https://currents.dev
${qo}`).addOption(je).addOption($e).addOption(Me).addOption(We).addOption(Ae).addOption(qe).addOption(Be).addOption(Ge).addOption(He).addOption(Je).addOption(Ke).addOption(ze).addOption(Xr).addOption(Xe).addOption(_).addOption(Ve).addOption(Vr).addOption(Yr).addOption(Ze).addOption(Qe);var nt=p.extend("cli-manager"),te=class{constructor(t={isOrchestration:!1}){this.configFilePath=null;this.program=t.isOrchestration?rt(Zr()):rt(ot()),this.cliOptions=this.program.parse().opts(),nt("CLI options: %o",this.cliOptions),this.parsedConfig=Dt(this.cliOptions),nt("Parsed config from CLI options: %o",this.parsedConfig)}getCLIReporters(){return this.cliOptions.reporter?.filter(t=>!/@currents/.test(t))||[]}async getConfigFilePath(){if(this.configFilePath)return this.configFilePath;let t=await zr();return Qr.default.writeFileSync(t,JSON.stringify(this.parsedConfig)),nt("CLI options temp file path: %s",t),this.configFilePath=t,t}};var lt=require("ts-pattern");v();n();var eo=require("c12");function to(e){return(0,eo.loadConfig)({name:"currents",configFile:e})}f();C();n();var ro=c(require("fs"));f();C();var fa=p.extend("output");async function oo(e){let t=" ".repeat(e.options?.ident??2);h(`${t}\u{1F4BE} JSON output file: ${l(e.outputFile)}`);try{ro.default.writeFileSync(e.outputFile,JSON.stringify(e.summary,null,2))}catch(r){x("Error writing JSON summary",r.message)}}n();var io=c(require("fs")),ct=c(require("tmp")),pt=require("ts-pattern");v();f();n();var no=c(require("fs")),Bo=require("path");v();f();var D=p.extend("last-failed");function so({suite:e,task:t,lastRunData:r}){let o=Go({suite:e,task:t,lastRunData:r});if(!o)return D("No updated data generated for task %s",t.groupId),!1;try{return Ho(o),D("Successfully updated last run file for task %s",t.groupId),!0}catch(s){return D("Failed to update last run file for task %s: %O",t.groupId,s),!1}}function Go({suite:e,task:t,lastRunData:r}){let o=e.find(d=>d.name===t.groupId);if(!o)return D("No group suite found for task %s",t.groupId),null;let s=r.find(d=>d.project===t.groupId);if(!s?.data)return D("No last run data found for group %s",t.groupId),null;let u=o.tests.filter(d=>d.spec===t.spec&&s.data.failedTests.includes(d.testId)).map(d=>d.testId);return u.length?{data:{status:s.data.status,failedTests:u},path:s.path,project:s.project}:(D("No failed test IDs found for task %s",t.groupId),null)}function Ho(e){return no.default.writeFileSync(e.path,JSON.stringify(e.data,null,2))}n();var st={OR8N_SUITE_FILE_PREFIX:"currents-or8n-",FIXTURES_DIR_PREFIX:"currents-fixtures-",FIXTURES_CONFIG_ERR_FILE:"config_fixture_error.log",FIXTURES_WARNING_FILE_PREFIX:"config_fixture_warning"};C();n();Oe();var M=class{async create(t){return k({url:"/orchestration",method:"POST",data:JSON.stringify(t)})}async createTask(t){return k({url:`/orchestration/${t.id}/task`,method:"POST",data:JSON.stringify({machineId:t.machineId,runId:t.runId})})}async resetRun(t){return k({url:`/runs/v1/${t.runId}/reset`,method:"PUT",data:JSON.stringify(t)})}};Q();n();var it;async function at(){if(it)return it;let{execa:e}=await import("execa");return it=e,e}var F=p.extend("or8n-task-executor"),ut=class{constructor(t,r,o,s,u,d,I=null,W,ne){this.cliManager=t;this.or8nId=r;this.runId=o;this.machineId=s;this.cliArgs=u;this.suite=d;this.lastRunData=I;this.resolve=W;this.reject=ne;this.taskResultList=[];this.orchestrationStatus=Jo}async runTaskLoop(){try{let t=ct.default.fileSync({prefix:st.OR8N_SUITE_FILE_PREFIX,postfix:".json"});io.default.writeFileSync(t.name,JSON.stringify(this.suite,null,2));let r=ct.default.dirSync({prefix:st.FIXTURES_DIR_PREFIX,unsafeCleanup:!0});for(;;){let o=new M;if(this.machineResetRequested){H(),h(`\u{1F6A5} Machine ${l(this.machineId)} has stopped processing tasks due to a reset signal.`),this.resolveTaskLoop();break}let{data:s}=await o.createTask({machineId:this.machineId,id:this.or8nId,runId:this.runId});if(s.run&&(this.orchestrationStatus.specs=s.run.progress.specs,this.orchestrationStatus.tests=s.run.progress.tests,H(),h([`  Orchestration progress: ${l(`${s.run?.progress?.specs?.completed??"-"}/${s.run?.progress?.specs?.overall??"-"} spec files completed`)}`].join(`
`))),!s.task){H(),h("\u{1F3C1} Orchestration session finished"),this.resolveTaskLoop();break}let u=s.task;h(["",`\u{1F310} Executing orchestrated task: ${l(`[${u.groupId}] ${u.spec} `)}`].join(`
`));let d=this.lastRunData?so({suite:this.suite,task:u,lastRunData:this.lastRunData}):!1;F('"Last failed" flag: %o',d);let I=await this.runPWTask(this.cliManager,this.cliArgs,this.machineId,u,t.name,r.name,d);this.taskResultList.push({task:u,exitStatus:I.exitCode??1})}}catch(t){this.reject(t)}}async runPWTask(t,r,o,s,u,d,I=!1){let W=E(),ne=["test",...W?.orchestration?.skipReporterInjection?[]:["--reporter",["@currents/playwright",...t.getCLIReporters()].join(",")],`--project=${s.groupId}`,...Ut(t.program.args,r),...I?["--last-failed"]:[],"--",s.spec],ft={...process.env,CURRENTS_PWCP_WSS_PORT:N().toString(),CURRENTS_MACHINE_ID:o,CURRENTS_ORCHESTRATION_ID:this.or8nId,CURRENTS_PWC_CLI_CONFIG_PATH:await t.getConfigFilePath(),CURRENTS_TEST_SUITE_FILE:u,CURRENTS_FIXTURES_TMP_DIR:d,CURRENTS_CI_BUILD_ID:W?.ciBuildId,CURRENTS_DEBUG:String(O.factory("pwc-p").getDebugMode()),NODE_OPTIONS:t.cliOptions.pwcInspect?"--inspect-brk=9440":""};return W?.outputFile&&(ft.CURRENTS_OR8N_SEND_RESULTS_TO_WSS="true"),F("Running task %o",ne),(await at())("playwright",ne,{stdio:"inherit",reject:!1,env:ft})}resolveTaskLoop(){this.resolve({runId:this.runId,machineId:this.machineId,orchestrationId:this.or8nId,orchestrationStatus:this.orchestrationStatus,taskResultList:this.taskResultList})}async machineReset(){let t=new M;try{this.machineResetRequested=!0,h(`\u{1F6A5} Resetting tests: ${l(`machineId: ${this.machineId}, runId: ${this.runId}`)}`),await t.resetRun({machineId:this.machineId,runId:this.runId}),h(`\u{1F6A5} Success resetting tests: ${l(`machineId: ${this.machineId}, runId: ${this.runId}`)}`)}catch{g("Reset request failed.")}}},re=class{constructor(t){this.cliManager=t;this.CREATE_TIMEOUT_MS=60*1e3;this.orchestrationSessionProgress=new Promise((r,o)=>{this.resolveOrchestrationSession=r,this.rejectOrchestrationSession=o})}eventsHandler(t){let r=JSON.parse(t);F("Received ws event",r),(0,pt.match)(r.type).when(o=>o.startsWith("discovery"),o=>(0,pt.match)(o).with("discovery:creation-success",()=>{(this.taskExecutor=new ut(this.cliManager,r.payload.id,r.payload.runId,r.payload.machineId,r.payload.cliArgs??[],r.payload.suite,r.payload.lastRunData,this.resolveOrchestrationSession,this.rejectOrchestrationSession)).runTaskLoop()}).with("discovery:creation-failure",()=>{this.rejectOrchestrationSession(new Error("Failed to create orchestration session"))}).otherwise(()=>{this.rejectOrchestrationSession(new Error(`Unknown discovery event ${r.type} received from orchestration service`))})).otherwise(()=>{})}async initOrchestration(t){let r=["test","--list","--reporter","@currents/playwright/orchestration",...t.cliOptions.lastFailed?["--last-failed"]:[],...t.program.args];F("Orchestration discovery args: %o",r),F(`Debug discovery command:
%s`,`DEBUG=*,-babel* CURRENTS_PWCP_DRY_RUN=1 CURRENTS_CI_BUILD_ID=debug CURRENTS_PROJECT_ID=debug CURRENTS_RECORD_KEY=debug npx playwright ${r.join(" ")}`);let s=await(await at())("playwright",r,{stdio:"inherit",reject:!1,timeout:this.CREATE_TIMEOUT_MS,env:{CURRENTS_CI_BUILD_ID:E()?.ciBuildId,CURRENTS_PWC_CLI_CONFIG_PATH:await t.getConfigFilePath(),CURRENTS_PWCP_WSS_PORT:N().toString(),...process.env,CURRENTS_DEBUG:String(O.factory("pwc-p").getDebugMode())}});if(F("Orchestration discovery result: %O",s),s.timedOut)throw new Error(`Failed to start orchestration within ${this.CREATE_TIMEOUT_MS}ms`);if(!s||s.exitCode!==0)throw new Error("Failed discovery for orchestration session");return s}},Jo={specs:{overall:-1,claimed:-1,completed:-1,passes:-1,failures:-1},tests:{overall:-1,failures:-1,passes:-1,ignored:-1,flaky:-1}};var Ko=p.extend("pwc-p-runner");async function ao(){try{let e=new te({isOrchestration:!0}),t=await to(e.cliOptions.pwcConfig);Object.keys(t.config).length>0&&h("   Using config file:",l(t.configFile)),Ft(e.parsedConfig,t.config);let r=E(),o=new re(e),s=new dt;if(r?.orchestration?.resetSignal){let d=r?.orchestration?.resetSignal;h(`\u{1F6A5} Will reset tests on ${d}. PID: ${process.pid}`),process.on(d,async()=>{o.taskExecutor&&(h(`\u{1F6A5} Received ${d}`),await o.taskExecutor.machineReset())})}await Jr([o.eventsHandler.bind(o),s.eventsHandler.bind(s)]);let[u]=await Promise.all([o.orchestrationSessionProgress,o.initOrchestration(e)]);if(r?.outputFile&&await oo({outputFile:r?.outputFile,summary:s.getSummary(),options:{ident:0}}),Ko("orchestration session raw result: %o",u),typeof r?.orchestration?.onFinish=="function")try{await r.orchestration.onFinish(u.orchestrationStatus)}catch{}return{...u,success:u.taskResultList.every(d=>d.exitStatus===0)}}finally{await Hr()}}var dt=class{constructor(){this.results=[]}eventsHandler(t){let r=JSON.parse(t);(0,lt.match)(r.type).when(o=>o.startsWith("execution:"),o=>(0,lt.match)(o).with("execution:summary",s=>{this.results.push(r.payload)}).otherwise(()=>{g("Unknown execution event received from orchestrated task",{event:r})})).otherwise(()=>{})}getSummary(){if(!this.results.length)return{runId:null,ciBuildId:null,url:null,results:{tests:{passed:0,failed:0,skipped:0,overall:0,flaky:0}},details:[]};let t=this.results.flatMap(o=>o.details),r=this.results.reduce((o,s)=>({passed:o.passed+s.results.tests.passed,failed:o.failed+s.results.tests.failed,skipped:o.skipped+s.results.tests.skipped,overall:o.overall+s.results.tests.overall,flaky:o.flaky+s.results.tests.flaky}),{passed:0,failed:0,skipped:0,overall:0,flaky:0});return{...this.results[0],results:{tests:r},details:t}}};var co=require("axios"),oe=p.extend("pwc-p");require("dotenv").config();var gt=O.factory("pwc-p");async function po(){try{let e=await ao();return oe("orchestration session result: %o",e),await gt.finalize({runId:e.runId}),{exitCode:e.success===!0?0:1}}catch(e){return oe("orchestration session error: %o",e),e instanceof mt.CommanderError?(x(e.message),{exitCode:e.exitCode}):(0,co.isAxiosError)(e)?{exitCode:1}:(x(e),{exitCode:1})}}po().then(e=>{oe("execa result: %o",e),process.exit(e.exitCode??0)}).catch(async e=>{e instanceof mt.CommanderError&&(x(e.message),await gt.finalize(),process.exit(e.exitCode)),oe("execa failed: %o",e),x(e),await gt.finalize(),process.exit(1)});0&&(module.exports={runScript});
/*! For license information please see pwc-p.js.LEGAL.txt */
//# sourceMappingURL=pwc-p.js.map