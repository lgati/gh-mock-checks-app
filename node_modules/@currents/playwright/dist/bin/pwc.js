#! /usr/bin/env node
"use strict";var dr=Object.create;var L=Object.defineProperty;var lr=Object.getOwnPropertyDescriptor;var gr=Object.getOwnPropertyNames;var mr=Object.getPrototypeOf,fr=Object.prototype.hasOwnProperty;var s=(e,t)=>()=>(e&&(t=e(e=0)),t);var Fe=(e,t)=>{for(var o in t)L(e,o,{get:t[o],enumerable:!0})},hr=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of gr(t))!fr.call(e,a)&&a!==o&&L(e,a,{get:()=>t[a],enumerable:!(n=lr(t,a))||n.enumerable});return e};var p=(e,t,o)=>(o=e!=null?dr(mr(e)):{},hr(t||!e||!e.__esModule?L(o,"default",{value:e,enumerable:!0}):o,e));var r=s(()=>{"use strict"});var _e=s(()=>{"use strict";r()});var je=s(()=>{"use strict";r()});function Le(e){yr.push(e)}var yr,$=s(()=>{"use strict";r();yr=[]});var $e,qe,Me=s(()=>{"use strict";r();$e=[],qe=[]});var f,T,q,S,c,C,v,oo,no,io,so,ao,po,co,uo,lo,l,go,Be=s(()=>{"use strict";r();f=p(require("chalk")),T=p(require("util"));h();$();Me();q=(...e)=>{let t=T.default.format(...e);Le(t),console.log(t)},S=q,c=(...e)=>{let t=T.default.format(...e);return qe.push(t),u("WARNING: ",t),q(f.default.bgYellow.black(" WARNING "),t)},C=(...e)=>{let t=T.default.format(...e);return $e.push(t),u("ERROR: ",t),q(f.default.bgRed.white(" ERROR "),t)},v=(e=2)=>console.log(Array(e).fill("").join(`
`)),oo=f.default.cyan,no=f.default.blueBright,io=f.default.red,so=f.default.yellow,ao=f.default.green,po=f.default.gray,co=f.default.white,uo=f.default.black,lo=f.default.magenta,l=f.default.dim,go=f.default.bold});var x=s(()=>{"use strict";r();$();Be()});function B(e){if(!e)return;if(e==="false")return!1;let t=parseInt(e,10);if(isNaN(t)||t<1)throw new M.CommanderError(255,"Invalid argument provided.","--pwc-cancel-after-failures must be a positive integer or 'false', provided: "+e);return t}function Ge(e){if(!e)return;let t=["SIGUSR1","SIGUSR2"];if(!t.includes(e.toUpperCase().trim()))throw new M.CommanderError(255,"Invalid argument provided.","--pwc-reset-signal must be one of ("+t.join(", ")+"), provided: "+e);return e.toUpperCase().trim()}var M,G=s(()=>{"use strict";r();M=require("commander")});function y(e){return wr[e]?.env}var wr,W=s(()=>{"use strict";r();G();wr={currentsConfigFile:{name:"Currents Config File Path",env:"CURRENTS_CONFIG_FILE_PATH",cli:"--pwc-config"},ciBuildId:{name:"CI Build ID",env:"CURRENTS_CI_BUILD_ID",cli:"--ci-build-id"},recordKey:{name:"Record Key",env:"CURRENTS_RECORD_KEY",cli:"--key"},projectId:{name:"Project ID",env:"CURRENTS_PROJECT_ID",cli:"--project-id"},tag:{name:"Currents Tag",env:"CURRENTS_TAG",cli:"--tag"},cancelAfterFailures:{name:"Currents Cancel After Failures",env:"CURRENTS_CANCEL_AFTER_FAILURES",cli:"--pwc-cancel-after-failures"},disableTitleTags:{name:"Disable Title Tags",env:"CURRENTS_DISABLE_TITLE_TAGS",cli:"--pwc-disable-title-tags"},testSuiteFile:{name:"Test Suite File",env:"CURRENTS_TEST_SUITE_FILE",cli:"--pwc-test-suite-file"},machineId:{name:"Machine ID",env:"CURRENTS_MACHINE_ID",cli:"--pwc-machine-id"},orchestrationId:{name:"Orchestration ID",env:"CURRENTS_ORCHESTRATION_ID",cli:"--pwc-orchestration-id"},outputFile:{name:"Output File",env:"CURRENTS_OUTPUT_FILE",cli:"--pwc-output-file"}}});function We(e){return{ciBuildId:e.ciBuildId,projectId:e.projectId,recordKey:e.key,tag:e.tag,removeTitleTags:e.pwcRemoveTitleTags,cancelAfterFailures:e.pwcCancelAfterFailures,disableTitleTags:e.pwcDisableTitleTags,testSuiteFile:e.pwcTestSuiteFile,machineId:e.pwcMachineId,outputFile:e.pwcOutputFile,pwcConfigPath:e.pwcConfig,orchestration:{resetSignal:e.pwcResetSignal,skipReporterInjection:e.pwcSkipReporterInjection},coverage:{projects:e.pwcCoverage,dir:e.pwcCoverageDir}}}var Cr,Io,H=s(()=>{"use strict";r();Cr=p(require("fs"));h();Io=u.extend("cli-options-serializer")});function He(){return br}var qo,br,Ke=s(()=>{"use strict";r();h();_e();je();x();W();H();qo=u.extend("config"),br=null});var Rr,ze=s(()=>{"use strict";r();Rr=require("lodash");x()});var k=s(()=>{"use strict";r();Ke();W();H();ze()});var Ye,Ve=s(()=>{Ye={name:"@currents/playwright",version:"1.12.1",main:"./dist/index.js",author:{name:"Currents Software Inc",email:"hello@currents.dev",url:"https://currents.dev"},license:"MIT",homepage:"https://currents.dev",repository:{type:"git",url:"https://github.com/currents-dev/currents-playwright-changelog.git"},scripts:{test:"vitest",rm:"rimraf dist",lint:'TIMING=1 eslint "**/*.ts*"',build:"tsup-node --minify --dts",dev:"tsup-node --watch --dts",release:"release-it --verbose","publish:npm":"npm run rm  && npm run build && ./publish.js","release-ci":"npm run rm && npm run build && ./publish.js -t latest"},bin:{pwc:"./dist/bin/pwc.js","pwc-p":"./dist/bin/pwc-p.js"},devDependencies:{"@playwright/test":"^1.44.0","@release-it/conventional-changelog":"^7.0.2","@types/async-retry":"^1.4.5","@types/babel__code-frame":"^7.0.3","@types/debug":"^4.1.12","@types/getos":"^3.0.4","@types/json-stringify-safe":"^5.0.3","@types/lodash":"^4.17.15","@types/pluralize":"^0.0.33","@types/proxy-from-env":"^1.0.4","@types/randomstring":"^1.3.0","@types/shelljs":"^0.8.15","@types/stack-utils":"^2.0.3","@types/tmp":"^0.2.6","@types/ws":"^8.18.0",eslint:"^9.23.0","eslint-config-custom":"*",msw:"^2.7.1","release-it":"^18.1.2",rimraf:"^6.0.1",tsconfig:"*",tsup:"^8.3.5",typescript:"^5.8.2",vitest:"^3.0.9",wtfnode:"^0.10.0"},dependencies:{"@babel/code-frame":"^7.18.6","@commander-js/extra-typings":"^12.1.0","@currents/commit-info":"1.0.1-beta.0","async-retry":"^1.3.3",axios:"^1.8.3","axios-retry":"^4.5.0",c12:"^1.11.2",chalk:"^4.1.2",commander:"^12.1.0","date-fns":"^4.1.0",debug:"^4.3.7",dotenv:"^16.0.3",execa:"^9.5.2",getos:"^3.2.1","https-proxy-agent":"^7.0.5","istanbul-lib-coverage":"^3.2.2","json-stringify-safe":"^5.0.1","lil-http-terminator":"^1.2.3",lodash:"^4.17.21",nanoid:"^3.3.8","object-sizeof":"^2.6.5","p-debounce":"^2.1.0","p-map":"^4.0.0","p-queue":"6.6.2",pino:"^9.6.0",pluralize:"^8.0.0","pretty-ms":"^7.0.1","proxy-from-env":"^1.1.0","source-map-support":"^0.5.21","stack-utils":"^2.0.6",tmp:"^0.2.3","tmp-promise":"^3.0.3","ts-pattern":"^5.7.0",ws:"^8.18.1"},files:["dist","!**/*.map","!**/*/*.map","**/*.LEGAL.txt","LICENSE.md","README.md","CHANGELOG.md"],keywords:["playwright","playwright dashboard","cloud dashboard","reporter","currents","tests reporter","sorry cypress","ci"],exports:{".":{import:"./dist/index.js",require:"./dist/index.js"},"./discovery":{import:"./dist/reporters/discovery.js",require:"./dist/reporters/discovery.js"},"./orchestration":{import:"./dist/orchestration/index.js",require:"./dist/orchestration/index.js"},"./package.json":"./package.json"},publishConfig:{access:"public",registry:"https://registry.npmjs.org"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"../../CHANGELOG.md"}},git:{commitMessage:"chore: release v${version}",tagName:"v${version}"},hooks:{"before:github:release":"npm run --prefix ../../ update-public-changelog"}}}});var A,K=s(()=>{"use strict";r();Ve();A=Ye.version});function P(e={}){let t=Je.default.create(e);return t.interceptors.request.use(o=>{let n={...o},a=t.getUri(o),m=Ze.default.getProxyForUrl(a);return m&&(vr("Using HTTP proxy %s for %s ",m,a),n.proxy=!1,n.httpsAgent=Ir(m)),n}),t}function Ir(e){return D||(D=new Xe.HttpsProxyAgent(e),D)}var Je,Xe,Ze,vr,D,z=s(()=>{"use strict";r();Je=p(require("axios")),Xe=require("https-proxy-agent"),Ze=p(require("proxy-from-env"));h();vr=u.extend("axios");D=null});var V,Qe,et=s(()=>{"use strict";r();V=()=>process.env.CURRENTS_API_URL??"https://cy.currents.dev",Qe=()=>3e4});var tt,rt,ot=s(()=>{"use strict";r();tt=p(require("events"));h();Y();rt=new tt.default});var J,it,nt,st,at=s(()=>{"use strict";r();x();ot();J={cancellationReason:null},it=e=>{J.cancellationReason||(J.cancellationReason=e)},nt=()=>J.cancellationReason,st=({showWarning:e=!0}={})=>{let t=nt();t&&(e&&c("%s",t),rt.emit("runCancelled",t))}});var Y=s(()=>{"use strict";r();at()});var pt,bn,Or,ct,ut=s(()=>{"use strict";r();pt=require("async_hooks"),bn=new pt.AsyncLocalStorage,Or=new Map,ct=e=>{let t=Or.get(e);return t?t.getStore():null}});var dt,I,X=s(()=>{"use strict";r();dt=require("nanoid"),I=(0,dt.customAlphabet)("abcdefghijklmnopqrstuvwxyz",10)});function ht(e){(0,g.match)(e).when(gt.isAxiosError,Tr).otherwise(()=>{c("Unexpected error while sending network request: %s",e)})}function Tr(e){return(0,g.match)(e).with({code:"ECONNABORTED"},()=>{c("Network connection aborted")}).with({code:"ECONNREFUSED"},()=>{c("Network connection aborted")}).with({code:"ECONNRESET"},()=>{c("Network connection reset")}).with({code:"ETIMEDOUT"},()=>{c("Network connection timeout")}).with({response:g.P.not(g.P.nullish)},t=>{Sr(t,{status:t.response.status,data:t.response.data})}).otherwise(t=>{c(`[currents] Unexpected network error: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,payload:e.response?.config.data,requestId:O(e)})})}function Sr(e,{status:t,data:o}){(0,g.match)(t).with(401,()=>{c(`[currents] ${e.response?.config.method} ${e.response?.config.url}} - 401 Unauthorized Request from cloud service`)}).with(400,()=>{c(`[currents] ${e.response?.config.method} ${e.response?.config.url} - 400 Bad Request from cloud service:
%o`,o)}).with(429,()=>{c(`[currents] ${e.response?.config.method} ${e.response?.config.url} - 429 Too Many Requests from cloud service`)}).with(422,()=>{kr(e,o)}).otherwise(()=>{c(`[currents] Unexpected network response: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,requestId:O(e)})})}function kr(e,t){(0,g.match)(t).with({code:Z.MISSING_SUITE,message:g.P.string,errors:g.P.array(g.P.string)},async o=>{let{message:n,errors:a}=o,m=ct("discovery");v(1),C(...lt(n,a)),N({id:I(),text:(0,mt.default)(m,null,2)}).then(w=>{C(`Please share this URL with Currents support for further investigation:
${w}`)}).catch(w=>{c("Failed to upload debug artifact: %s",w)}),v(1)}).with({code:Z.RUN_CANCELLED,message:g.P.string},o=>{it(o.message),st()}).with({code:Z.RUN_EXPIRED,message:g.P.string},o=>{c(o.message)}).with({message:g.P.string,errors:g.P.array(g.P.string)},o=>{let{message:n,errors:a}=o;v(1),c(...lt(n,a)),v(1)}).otherwise(()=>{c(`[currents] Unexpected network response: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,requestId:O(e)})})}function lt(e,t){return ft.default.isString(e)?t?.length===0?[e]:[e,`
${(t??[]).map(o=>`  - ${o}`).join(`
`)}
`]:["Unexpected network error"]}function O(e){return e?.response?.headers["apigw-requestid"]}var gt,mt,ft,g,Z,Q=s(()=>{"use strict";r();gt=require("axios"),mt=p(require("json-stringify-safe")),ft=p(require("lodash")),g=require("ts-pattern");Y();ut();X();x();ee();Z={RUN_CANCELLED:"RUN_CANCELLED",RUN_EXPIRED:"RUN_EXPIRED",MISSING_SUITE:"MISSING_SUITE"}});function Ct(e,t,o){let n=o.method?.toUpperCase(),a=o.url,m=O(t),w=(0,yt.default)(re(e)),E=`Network request '${n} ${a}' failed: '${t.message}'.${m?` Request ID: ${m}.`:""} Next attempt is in ${w} (${e}/${o["axios-retry"]?.retries||oe()}).`;xt(E),c(E)}var te,yt,xt,re,wt,oe,bt=s(()=>{"use strict";r();te=require("axios"),yt=p(require("pretty-ms"));h();x();Q();xt=u.extend("http"),re=e=>[3*1e3,15*1e3,30*1e3][e-1],wt=e=>(xt("isRetriableError: %o",{message:e.message,code:"code"in e?e.code:void 0,status:"response"in e?e.response?.status:void 0,headers:"response"in e?e.response?.headers:void 0,data:"response"in e?e.response?.data:void 0,isAxiosError:(0,te.isAxiosError)(e)}),"code"in e&&e.code&&["ECONNABORTED","ECONNREFUSED","ECONNRESET","ETIMEDOUT","ENETRESET","ENOTFOUND","EAI_AGAIN"].includes(e.code)?!0:(0,te.isAxiosError)(e)?[429,500,502,503,504].includes(e.response?.status??0):!1),oe=()=>3});function Ur(){let e=P({baseURL:V(),timeout:Qe(),transitional:{clarifyTimeoutError:!0}});return e.interceptors.request.use(async t=>{let{currentsOptions:o}=t,n={...Nr,...o};return n.enableCompression&&(0,St.default)(t.data)>n.compressThresholdBytes?(t.headers["Content-Encoding"]="gzip",{...t,data:await Pr((0,It.default)(t.data))}):t}),e.interceptors.request.use(t=>{let o=t["axios-retry"]?.retryCount??0,n=He();t.headers.set({...Dr,"Accept-Encoding":"gzip, deflate, br","x-currents-idempotency-key":t.headers["x-currents-idempotency-key"]??(0,Tt.nanoid)(),"x-pwc-request-attempt":o,"x-currents-key":n?.recordKey??null}),n?.orchestrationId&&t.headers.set("x-currents-orchestration-id",n.orchestrationId),n?.machineId&&t.headers.set("x-currents-machine-id",n.machineId),t.headers.get("Content-Type")||t.headers.set("Content-Type","application/json");let a={...Ot.default.pick(t,"method","url","headers"),data:Buffer.isBuffer(t.data)?"buffer":t.data};return o?Rt("network request retry: %o",Et({...a,isRetry:!0})):Rt("network request: %o",Et(a)),t}),(0,vt.default)(e,{retries:oe(),retryCondition:wt,retryDelay:re,shouldResetTimeout:!0,onRetry:Ct}),e}function Dt(){return U||(U=Ur(),U)}function Et(e){return{method:e.method,baseUrl:V(),url:e.url,data:e.isRetry?"<retry>":Fr(e.data),headers:{...e.headers,"x-currents-key":"***"}}}function Fr(e){return e?.results?.raw?{...e,results:{...e.results,raw:"***"}}:e}var vt,It,Ot,Tt,St,kt,At,Rt,Ar,Dr,Pr,U,Nr,Pt=s(()=>{"use strict";r();vt=p(require("axios-retry")),It=p(require("json-stringify-safe")),Ot=p(require("lodash")),Tt=require("nanoid"),St=p(require("object-sizeof")),kt=require("util"),At=p(require("zlib"));k();h();K();z();et();bt();Rt=u.extend("http"),Ar=1024*1024*1,Dr={"x-pw-version":"0.0.0","x-pwc-version":A},Pr=(0,kt.promisify)(At.default.gzip),U=null,Nr={enableCompression:!1,compressThresholdBytes:Ar}});async function Ft(e,t=Dt){try{let o=await t().request(e);return Nt("network response: %o",{...Ut.default.omit(o,"request","config"),url:o.config.url,method:o.config.method}),o}catch(o){let n=o;throw Nt("network error: %o",{code:n.code,message:n.message,url:n.config?.url,method:n.config?.method,status:n.response?.status,headers:n.response?.headers,data:n.response?.data}),ht(n),n}}var Ut,Nt,_t=s(()=>{"use strict";r();Ut=p(require("lodash"));h();Pt();Q();Nt=u.extend("http")});var jt=s(()=>{"use strict";r();_t()});var Lt={};Fe(Lt,{getDebugUrl:()=>_r});var _r,$t=s(()=>{"use strict";r();jt();_r=({runId:e,type:t})=>Ft({method:"POST",url:"runs/debug-logs",data:{type:t,runId:e}}).then(o=>o.data)});function jr(e,t){return Gt({path:e,name:null,uploadUrl:t,contentType:"text/plain"},"text/plain",void 0)}async function Gt(e,t,o){let n=await Mt.default.readFile(e.path);return ne("Uploading file %s",e.uploadUrl,{buffer:Buffer.byteLength(n)}),Wt(n,e.uploadUrl,t,o)}async function Lr(e,t,o){return ne("Uploading buffer %s",e.name,{buffer:Buffer.byteLength(e.buffer)}),Wt(e.buffer,e.uploadUrl,t,o)}async function $r(e,t,o,n){return P().request({method:"put",url:t,data:e,onUploadProgress:n,headers:{"Content-Disposition":"inline","Content-Type":o}})}async function Wt(...e){await(0,qt.default)(async()=>{await $r(...e)},{retries:5,onRetry:(t,o)=>{if(ne("Upload failed %d out of 5 attempts: %s",o,t.message),o===5){C(`Cannot upload after ${o} times: ${t.message}`);return}c(`Upload failed ${o} out of 5 attempts: ${t.message}`)}})}var qt,Mt,ne,Bt,Ht=s(()=>{"use strict";r();qt=p(require("async-retry")),Mt=p(require("fs/promises"));h();z();x();ne=u.extend("upload"),Bt=(a=>(a.PNG="image/png",a.WEBM="video/webm",a.TEXT="text/plain",a.ZIP="application/zip",a))(Bt||{})});var Kt={};Fe(Kt,{ContentType:()=>Bt,sendBuffer:()=>Lr,sendPath:()=>Gt,uploadText:()=>jr});var zt=s(()=>{"use strict";r();Ht()});async function N(e){let{getDebugUrl:t}=await Promise.resolve().then(()=>($t(),Lt));try{let{readUrl:o,uploadUrl:n}=await t({runId:e.id,type:"pw-debug"}),{uploadText:a,sendBuffer:m}=await Promise.resolve().then(()=>(zt(),Kt));return"text"in e&&await m({name:`${e.id}-discovery-debug.log`,buffer:Buffer.from(e.text,"utf-8"),contentType:"text/plain",uploadUrl:n},"text/plain",void 0),"path"in e&&await a(e.path,n),o}catch{return null}}var ie,se=s(()=>{"use strict";r();ie=p(require("debug"))});function qr(e){return e==="false"?!1:e==="remote"?"remote":e==="full"?"full":!!e}var Vt,R,ae=s(()=>{"use strict";r();Vt=require("@commander-js/extra-typings"),R=new Vt.Option("--pwc-debug [boolean | 'remote' | 'full']","enable debug logs for the reporter. Specify 'remote' to upload logs to Currents. Specify 'full' to dump the debug logs to stdout and upload to Currents.").argParser(qr).env("CURRENTS_DEBUG")});var Yt,Jt,Xt=s(()=>{"use strict";r();Yt=require("@commander-js/extra-typings");ae();Jt=()=>new Yt.Command().allowUnknownOption().addOption(R).helpOption(!1)});var b,Zt,ce,Qt,er,pe,F,ue=s(()=>{"use strict";r();b=p(require("debug")),Zt=p(require("fs")),ce=p(require("path")),Qt=p(require("util")),er=require("fs/promises");X();x();Xt();se();b.default.useColors=function(){return!1};pe=b.default.log,F=class e{constructor(t="core"){this.source=t;this.pipelines={};if(this.mode=Jt().parse().opts().pwcDebug??!1,this.debug=(0,b.default)(`currents:remote-debug:${this.source}`),!this.mode)return this;if(!this.shouldEnableDebug())return this;let o=process.env.DEBUG?`${process.env.DEBUG},currents*`:"currents*";if(b.default.enable(o),!this.shouldUploadRemoteDebug())return this;let n=I(),a=ce.default.resolve(".currents-debug"),m=ce.default.resolve(a,`${n}.log`);(0,er.mkdir)(a,{recursive:!0}),S(l(`\u{1F47E} Initiated remote ${this.source} debug log collection:`),l(m));let w=Zt.default.createWriteStream(m,{flags:"a"});return b.default.log=(...E)=>{this.mode&&(w.write(`${Qt.default.formatWithOptions({colors:!1},...E)}
`),this.shouldMuteLocalStdout()||pe(...E))},this.pipelines[n]={id:n,writeStream:w,type:this.source,tempFilePath:m},this}static factory(t="core"){return this.instance||(this.instance=new e(t)),this.instance}getDebugMode(){return this.mode}async finalize({runId:t}={runId:void 0}){try{let o=Object.keys(this.pipelines);o.length===0&&(this.debug("No debug pipelines found"),b.default.log=pe);for(let n of o)await this.uploadDebug(n,t??I())}catch{}finally{b.default.log=pe}}async uploadDebug(t,o){let n=this.pipelines[t];if(!n){this.debug("No debug pipeline found for id %s",t);return}S(l(`\u{1F47E} ${n.type} debug log written:`),l(n?.tempFilePath));try{let a=await N({id:o,path:n.tempFilePath});n?.writeStream.end(),S(l(`\u{1F47E} ${n.type} debug log uploaded:`),l(a))}catch(a){c(`Failed to upload ${n.type}} debug log ${l(n.tempFilePath)}: ${a.message}`)}}shouldEnableDebug(){return this.mode==="full"||this.mode==="remote"||this.mode===!0}shouldUploadRemoteDebug(){return this.mode==="full"||this.mode==="remote"}shouldMuteLocalStdout(){return this.mode==="remote"}}});var ee=s(()=>{"use strict";r();se();ue()});var u,h=s(()=>{"use strict";r();ee();u=(0,ie.default)("currents")});r();var os=require("source-map-support/register"),ur=require("commander");h();x();ue();r();var ar=p(require("fs"));k();h();r();var de=p(require("fs")),tr=require("tmp-promise"),rr=async()=>{let{path:e}=await(0,tr.file)();return e};r();var ke=require("@commander-js/extra-typings"),Ae=p(require("chalk"));K();x();r();var d=require("@commander-js/extra-typings");k();G();ae();var le=new d.Option("--pwc-config <path>","path to currents config file (currents.config.[ts|js])").env(y("currentsConfigFile")),ge=new d.Option("--ci-build-id <id>","the unique identifier for a run").env(y("ciBuildId")),me=new d.Option("-k, --key <record-key>","your secret Record Key obtained from Currents").env(y("recordKey")),fe=new d.Option("-p, --project-id <project>","the project ID for results reporting obtained from Currents").env(y("projectId")),he=new d.Option("-t, --tag <tag>","comma-separated tag(s) for recorded runs in Currents").argParser(Oe),ye=new d.Option("--pwc-remove-title-tags","remove tags from test names in Currents, e.g. `Test name @smoke` becomes `Test name` in the dashboard"),xe=new d.Option("--pwc-disable-title-tags","disable parsing tags from test title, e.g. `Test name @smoke` would not be tagged with `smoke` in the dashboard"),we=new d.Option("--pwc-cancel-after-failures <number | false>","abort the cloud run after the specified number of failed tests detected. Overrides the default Currents Project settings. If set, must be a positive integer or 'false' to disable automatic cancellations").env(y("cancelAfterFailures")).argParser(B),Ce=new d.Option("--pwc-output-file <string>","path to the file where the run summary output will be written.").env(y("outputFile")),be=new d.Option("--pwc-test-suite-file <path>","path to the full test suite file for orchestration and reporting").env(y("testSuiteFile")).hideHelp(),Re=new d.Option("--pwc-machine-id <string>","unique identifier of the machine running the tests. If not provided, it will be generated automatically. See: https://docs.currents.dev/?q=machineId").env(y("machineId")),Ee=new d.Option("--pwc-orchestration-id <string>","unique identifier of the orchestration session this run belongs to. See: https://docs.currents.dev/?q=orchestrationId").env(y("orchestrationId")).hideHelp();var ve=new d.Option("--pwc-inspect","enable inspect mode, run playwright with --inspect-brk flag or developments and debugging").default(!1).hideHelp(),or=new d.Option("--pwc-reset-signal <'SIGUSR1' | 'SIGUSR2'>","specify a process signal to listen for to trigger a reset of the current in progress tests. Only avaiable on OSes with POSIX signal support.").argParser(Ge),Ie=new d.Option("--reporter <reporter>","Reporter to use, comma-separated").argParser(Oe).hideHelp(),nr=new d.Option("--last-failed","Run last failed tests").default(!1).hideHelp(),ir=new d.Option("--pwc-skip-reporter-injection","Do no inject @currents/playwright reporter via CLI, use the reporter specified in the playwright config");function Oe(e,t=[]){return e?t.concat(e.split(",").map(o=>o.trim())):t}var Te=new d.Option("--pwc-coverage [projects...]","Comma-separated list of projects to collect coverage for, e.g. `project1,project2`. If no projects are specified, coverage will be collected for all projects.").argParser(Oe),Se=new d.Option("--pwc-coverage-dir <path>","Path to the directory where coverage reports will be read from");var De=(e=Pe())=>e.version(A),Mr=`
----------------------------------------------------
\u{1F4D6} Documentation: https://docs.currents.dev
\u{1F919} Support:       support@currents.dev
----------------------------------------------------

${Ae.default.bold("Examples")}

Run all tests in the current directory:
${l("pwc --key <record-key> --project-id <id> --ci-build-id <build-id>")}

Run only tests filtered by the tag "@smoke":
${l("pwc --key <record-key> --project-id <id> --ci-build-id <build-id> --grep smoke")}

Run playwright tests and add tags "tagA", "tagB" to the recorded run:
${l("pwc --key <record-key> --project-id <id> --ci-build-id <build-id> --tag tagA --tag tagB")}

Provide playwright arguments and flags:
${l("pwc --key <record-key> --project-id <id> --ci-build-id <build-id> -- --workers 2 --timeout 10000 --shard 1/2")}
`,Br=`
----------------------------------------------------
\u{1F4D6} Documentation: https://docs.currents.dev
\u{1F919} Support:       support@currents.dev
----------------------------------------------------

${Ae.default.bold("Examples")}

Orchestrate all tests in the current directory:
${l("pwc-p --key <record-key> --project-id <id> --ci-build-id <build-id>")}

Orchestrate only tests filtered by the tag "@smoke":
${l("pwc-p --key <record-key> --project-id <id> --ci-build-id <build-id> --grep smoke")}

Orchestrate playwright tests and add tags "tagA", "tagB" to the recorded run:
${l("pwc-p --key <record-key> --project-id <id> --ci-build-id <build-id> --tag tagA --tag tagB")}

Add additional playwright arguments and flags:
${l("pwc-p --key <record-key> --project-id <id> --ci-build-id <build-id> -- --workers 2 --timeout 10000")}
`,Pe=()=>new ke.Command().name("pwc").usage("[options] [playwright arguments and flags]").allowUnknownOption().showHelpAfterError("(add --help for additional information)").description(`\u{1F3AD} Run Playwright tests on CI using https://currents.dev
${Mr}`).addOption(ge).addOption(me).addOption(fe).addOption(he).addOption(le).addOption(ye).addOption(xe).addOption(we).addOption(Ce).addOption(be).addOption(Re).addOption(Ee).addOption(ve).addOption(R).addOption(Te).addOption(Se).addOption(Ie),sr=()=>new ke.Command().name("pwc-p").usage("[options] [playwright arguments and flags]").allowUnknownOption().showHelpAfterError("(add --help for additional information)").description(`\u2728 Orchestrate \u{1F3AD} Playwright tests on CI using https://currents.dev
${Br}`).addOption(ge).addOption(me).addOption(fe).addOption(he).addOption(le).addOption(ye).addOption(xe).addOption(we).addOption(Ce).addOption(be).addOption(Re).addOption(Ee).addOption(or).addOption(ve).addOption(R).addOption(Ie).addOption(nr).addOption(ir).addOption(Te).addOption(Se);var Ne=u.extend("cli-manager"),_=class{constructor(t={isOrchestration:!1}){this.configFilePath=null;this.program=t.isOrchestration?De(sr()):De(Pe()),this.cliOptions=this.program.parse().opts(),Ne("CLI options: %o",this.cliOptions),this.parsedConfig=We(this.cliOptions),Ne("Parsed config from CLI options: %o",this.parsedConfig)}getCLIReporters(){return this.cliOptions.reporter?.filter(t=>!/@currents/.test(t))||[]}async getConfigFilePath(){if(this.configFilePath)return this.configFilePath;let t=await rr();return ar.default.writeFileSync(t,JSON.stringify(this.parsedConfig)),Ne("CLI options temp file path: %s",t),this.configFilePath=t,t}};r();var Ue;async function pr(){if(Ue)return Ue;let{execa:e}=await import("execa");return Ue=e,e}var cr=u.extend("pwc");require("dotenv").config();var j=F.factory("pwc");async function Gr(){let e=new _;return await(await pr())("playwright",["test","--reporter",["@currents/playwright",...e.getCLIReporters()].join(","),...e.program.args],{stdio:"inherit",reject:!1,env:{...process.env,CURRENTS_DEBUG:String(j.getDebugMode()),CURRENTS_PWC_CLI_CONFIG_PATH:await e.getConfigFilePath(),NODE_OPTIONS:e.cliOptions.pwcInspect?"--inspect-brk=9440":""}})}Gr().then(async e=>{cr("execa result: %o",e),await j.finalize(),process.exit(e.exitCode??0)}).catch(async e=>{e instanceof ur.CommanderError&&(C(e.message),await j.finalize(),process.exit(e.exitCode)),cr("execa failed: %o",e),await j.finalize(),process.exit(1)});
/*! For license information please see pwc.js.LEGAL.txt */
//# sourceMappingURL=pwc.js.map