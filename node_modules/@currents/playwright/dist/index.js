"use strict";var fi=Object.create;var qe=Object.defineProperty;var hi=Object.getOwnPropertyDescriptor;var Ei=Object.getOwnPropertyNames;var Ci=Object.getPrototypeOf,Ii=Object.prototype.hasOwnProperty;var f=(t,e)=>()=>(t&&(e=t(t=0)),e);var kt=(t,e)=>{for(var r in e)qe(t,r,{get:e[r],enumerable:!0})},Qr=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ei(e))!Ii.call(t,s)&&s!==r&&qe(t,s,{get:()=>e[s],enumerable:!(n=hi(e,s))||n.enumerable});return t};var g=(t,e,r)=>(r=t!=null?fi(Ci(t)):{},Qr(e||!t||!t.__esModule?qe(r,"default",{value:t,enumerable:!0}):r,t)),Ri=t=>Qr(qe({},"__esModule",{value:!0}),t);var o=f(()=>{"use strict"});var pe,jt=f(()=>{"use strict";o();pe=class extends Error{}});var Je,$t=f(()=>{"use strict";o();Je={guide:{ciBuildId:"https://docs.currents.dev/guides/ci-build-id",integration:"https://docs.currents.dev/integration-with-playwright/currents-playwright"}}});function Xr(t){Ti.push(t)}var Ti,Gt=f(()=>{"use strict";o();Ti=[]});var ve,ee,Ke=f(()=>{"use strict";o();ve=[],ee=[]});var x,ge,Oe,w,d,de,Zr,y,me,fe,en,tn,Ne,K,rn,he,te,Le,Ue,mu,fu,De,m,hu,nn=f(()=>{"use strict";o();x=g(require("chalk")),ge=g(require("util"));E();Gt();Ke();Oe=(...t)=>{let e=ge.default.format(...t);Xr(e),console.log(e)},w=Oe,d=(...t)=>{let e=ge.default.format(...t);return ee.push(e),l("WARNING: ",e),Oe(x.default.bgYellow.black(" WARNING "),e)},de=(...t)=>{let e=ge.default.format(...t);return l("WARNING: ",e),Oe(x.default.bgYellow.black(" WARNING "),e)},Zr=(...t)=>{let e=ge.default.format(...t);return l("ERRRO: ",e),Oe(x.default.bgRed.white(" ERROR "),e)},y=(...t)=>{let e=ge.default.format(...t);return ve.push(e),l("ERROR: ",e),Oe(x.default.bgRed.white(" ERROR "),e)},me=()=>console.log(`
`+fe()+`
`),fe=()=>x.default.dim(Array(64).fill("=").join("")),en=(t="",e=64)=>{let r=` start of ${t??"block"} `,n=Math.max(e-r.length,0)/2,s=Math.floor(n),i=Math.ceil(n);return x.default.dim(`${Array(s).fill("-").join("")}${r}${Array(i).fill("-").join("")}`)},tn=(t="",e=64)=>{let r=` end of ${t??"block"} `,n=Math.max(e-r.length,0)/2,s=Math.floor(n),i=Math.ceil(n);return x.default.dim(`${Array(s).fill("-").join("")}${r}${Array(i).fill("-").join("")}`)},Ne=(t=2)=>console.log(Array(t).fill("").join(`
`)),K=x.default.cyan,rn=x.default.blueBright,he=x.default.red,te=x.default.yellow,Le=x.default.green,Ue=x.default.gray,mu=x.default.white,fu=x.default.black,De=x.default.magenta,m=x.default.dim,hu=x.default.bold});var T=f(()=>{"use strict";o();Gt();nn()});function on(t){if(!t)return;if(t==="false")return!1;let e=parseInt(t,10);if(isNaN(e)||e<1)throw new sn.CommanderError(255,"Invalid argument provided.","--pwc-cancel-after-failures must be a positive integer or 'false', provided: "+t);return e}var sn,an=f(()=>{"use strict";o();sn=require("commander")});function un(t){return F[t]?.env}function cn(t){return F[t].cli}function ln(t){return F[t].name}function pn(){return{projectId:process.env[F.projectId.env],recordKey:process.env[F.recordKey.env],ciBuildId:process.env[F.ciBuildId.env],tag:process.env[F.tag.env]?process.env[F.tag.env]?.split(",").map(t=>t.trim()):void 0,cancelAfterFailures:on(process.env[F.cancelAfterFailures.env]),disableTitleTags:process.env[F.disableTitleTags.env],testSuiteFile:process.env[F.testSuiteFile.env],machineId:process.env[F.machineId.env],orchestrationId:process.env[F.orchestrationId.env]}}var F,Ht=f(()=>{"use strict";o();an();F={currentsConfigFile:{name:"Currents Config File Path",env:"CURRENTS_CONFIG_FILE_PATH",cli:"--pwc-config"},ciBuildId:{name:"CI Build ID",env:"CURRENTS_CI_BUILD_ID",cli:"--ci-build-id"},recordKey:{name:"Record Key",env:"CURRENTS_RECORD_KEY",cli:"--key"},projectId:{name:"Project ID",env:"CURRENTS_PROJECT_ID",cli:"--project-id"},tag:{name:"Currents Tag",env:"CURRENTS_TAG",cli:"--tag"},cancelAfterFailures:{name:"Currents Cancel After Failures",env:"CURRENTS_CANCEL_AFTER_FAILURES",cli:"--pwc-cancel-after-failures"},disableTitleTags:{name:"Disable Title Tags",env:"CURRENTS_DISABLE_TITLE_TAGS",cli:"--pwc-disable-title-tags"},testSuiteFile:{name:"Test Suite File",env:"CURRENTS_TEST_SUITE_FILE",cli:"--pwc-test-suite-file"},machineId:{name:"Machine ID",env:"CURRENTS_MACHINE_ID",cli:"--pwc-machine-id"},orchestrationId:{name:"Orchestration ID",env:"CURRENTS_ORCHESTRATION_ID",cli:"--pwc-orchestration-id"},outputFile:{name:"Output File",env:"CURRENTS_OUTPUT_FILE",cli:"--pwc-output-file"}}});function Ce(){if(Wt)return Wt;if(process.env.CURRENTS_PWC_CLI_CONFIG_PATH)try{let t=JSON.parse(dn.default.readFileSync(process.env.CURRENTS_PWC_CLI_CONFIG_PATH).toString());return gn("Options from serialized CLI config file: %o",t),Wt=t,t}catch(t){return gn("Could not read CLI config file: %o",t),{}}return{}}var dn,gn,Wt,Vt=f(()=>{"use strict";o();dn=g(require("fs"));E();gn=l.extend("cli-options-serializer"),Wt=null});function mn(t,e,r={validationFn:Kt}){qt("reporter options: %o",t),qt("config file options: %o",e);let n={...M(Jt),...M(e),...M(t),...M(Ce()),...M(pn()),orchestration:{...M(Jt.orchestration),...M(e?.orchestration),...M(t?.orchestration),...M(Ce().orchestration)},coverage:{...M(Jt.coverage),...M(e?.coverage),...M(t?.coverage),...M(Ce().coverage)}};r.validationFn(n),Ye=n,qt("resolved currents config: %o",Ye)}function Kt(t){_i.forEach(e=>{if(!t[e])throw y(`${ln(e)} is required for Currents Reporter. Use the following methods:
  - as environment variable: ${m(un(e))}
  - as CLI flag of pwc command: ${m(cn(e))}
  - as reporter configuration option ${m(e)} in ${m("playwright.config.ts")}
  
  \u{1F4D6} ${Je.guide.integration}`),new pe("Missing required config variable")})}function M(t){return Object.entries(t??{}).reduce((e,[r,n])=>n===void 0?e:{...e,[r]:n},{})}function Y(){return!!Ye?.orchestrationId}function P(){return Ye}function fn(t){t.preserveOutput!=="always"&&d(`The "preserveOutput" property in your Playwright config is set to ${t.preserveOutput}. This may cause artifacts to be removed before they are uploaded to Currents. We recommend setting it to "always".`)}function hn(t){return t?Object.values(t).map(e=>e.name):[]}function ze(t,e){return e?.projects===!0?t:Array.isArray(e?.projects)?e?.projects.length===0?t:e?.projects.filter(r=>t.includes(r)):[]}var qt,_i,Jt,Ye,Yt=f(()=>{"use strict";o();E();jt();$t();T();Ht();Vt();qt=l.extend("config"),_i=["projectId","recordKey"],Jt={removeTitleTags:!1,disableTitleTags:!1,orchestration:{skipReporterInjection:!1},coverage:{projects:!1}},Ye=null});function Cn(t){let e=new WeakMap;function r(n){if(typeof n=="object"&&n!==null){if(e.has(n))return"[Circular]";e.set(n,!0)}}return(0,En.cloneDeepWith)(t,r)}function In(t){let r=Object.getOwnPropertySymbols(t).find(s=>s.toString().match(/configInternalSymbol/))??Object.getOwnPropertyNames(t).find(s=>s.match(/_internal/));return r?t[r]:(d("Could not extract internal playwright configuration"),null)}var En,Rn=f(()=>{"use strict";o();En=require("lodash");T()});var j=f(()=>{"use strict";o();Yt();Ht();Vt();Rn()});var _n,Tn=f(()=>{_n={name:"@currents/playwright",version:"1.12.1",main:"./dist/index.js",author:{name:"Currents Software Inc",email:"hello@currents.dev",url:"https://currents.dev"},license:"MIT",homepage:"https://currents.dev",repository:{type:"git",url:"https://github.com/currents-dev/currents-playwright-changelog.git"},scripts:{test:"vitest",rm:"rimraf dist",lint:'TIMING=1 eslint "**/*.ts*"',build:"tsup-node --minify --dts",dev:"tsup-node --watch --dts",release:"release-it --verbose","publish:npm":"npm run rm  && npm run build && ./publish.js","release-ci":"npm run rm && npm run build && ./publish.js -t latest"},bin:{pwc:"./dist/bin/pwc.js","pwc-p":"./dist/bin/pwc-p.js"},devDependencies:{"@playwright/test":"^1.44.0","@release-it/conventional-changelog":"^7.0.2","@types/async-retry":"^1.4.5","@types/babel__code-frame":"^7.0.3","@types/debug":"^4.1.12","@types/getos":"^3.0.4","@types/json-stringify-safe":"^5.0.3","@types/lodash":"^4.17.15","@types/pluralize":"^0.0.33","@types/proxy-from-env":"^1.0.4","@types/randomstring":"^1.3.0","@types/shelljs":"^0.8.15","@types/stack-utils":"^2.0.3","@types/tmp":"^0.2.6","@types/ws":"^8.18.0",eslint:"^9.23.0","eslint-config-custom":"*",msw:"^2.7.1","release-it":"^18.1.2",rimraf:"^6.0.1",tsconfig:"*",tsup:"^8.3.5",typescript:"^5.8.2",vitest:"^3.0.9",wtfnode:"^0.10.0"},dependencies:{"@babel/code-frame":"^7.18.6","@commander-js/extra-typings":"^12.1.0","@currents/commit-info":"1.0.1-beta.0","async-retry":"^1.3.3",axios:"^1.8.3","axios-retry":"^4.5.0",c12:"^1.11.2",chalk:"^4.1.2",commander:"^12.1.0","date-fns":"^4.1.0",debug:"^4.3.7",dotenv:"^16.0.3",execa:"^9.5.2",getos:"^3.2.1","https-proxy-agent":"^7.0.5","istanbul-lib-coverage":"^3.2.2","json-stringify-safe":"^5.0.1","lil-http-terminator":"^1.2.3",lodash:"^4.17.21",nanoid:"^3.3.8","object-sizeof":"^2.6.5","p-debounce":"^2.1.0","p-map":"^4.0.0","p-queue":"6.6.2",pino:"^9.6.0",pluralize:"^8.0.0","pretty-ms":"^7.0.1","proxy-from-env":"^1.1.0","source-map-support":"^0.5.21","stack-utils":"^2.0.6",tmp:"^0.2.3","tmp-promise":"^3.0.3","ts-pattern":"^5.7.0",ws:"^8.18.1"},files:["dist","!**/*.map","!**/*/*.map","**/*.LEGAL.txt","LICENSE.md","README.md","CHANGELOG.md"],keywords:["playwright","playwright dashboard","cloud dashboard","reporter","currents","tests reporter","sorry cypress","ci"],exports:{".":{import:"./dist/index.js",require:"./dist/index.js"},"./discovery":{import:"./dist/reporters/discovery.js",require:"./dist/reporters/discovery.js"},"./orchestration":{import:"./dist/orchestration/index.js",require:"./dist/orchestration/index.js"},"./package.json":"./package.json"},publishConfig:{access:"public",registry:"https://registry.npmjs.org"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"../../CHANGELOG.md"}},git:{commitMessage:"chore: release v${version}",tagName:"v${version}"},hooks:{"before:github:release":"npm run --prefix ../../ update-public-changelog"}}}});var Qe,zt=f(()=>{"use strict";o();Tn();Qe=_n.version});function Ze(t={}){let e=yn.default.create(t);return e.interceptors.request.use(r=>{let n={...r},s=e.getUri(r),i=xn.default.getProxyForUrl(s);return i&&(Si("Using HTTP proxy %s for %s ",i,s),n.proxy=!1,n.httpsAgent=xi(i)),n}),e}function xi(t){return Xe||(Xe=new Sn.HttpsProxyAgent(t),Xe)}var yn,Sn,xn,Si,Xe,Qt=f(()=>{"use strict";o();yn=g(require("axios")),Sn=require("https-proxy-agent"),xn=g(require("proxy-from-env"));E();Si=l.extend("axios");Xe=null});var Xt,An,wn=f(()=>{"use strict";o();Xt=()=>process.env.CURRENTS_API_URL??"https://cy.currents.dev",An=()=>3e4});function bn(){et.addListener("runCancelled",On)}function vn(){et.removeListener("runCancelled",On)}function On(){l("Run cancelled: %s",er()),process.exit(1)}var Pn,et,Zt=f(()=>{"use strict";o();Pn=g(require("events"));E();tt();et=new Pn.default});var tr,rt,er,nt,Nn=f(()=>{"use strict";o();T();Zt();tr={cancellationReason:null},rt=t=>{tr.cancellationReason||(tr.cancellationReason=t)},er=()=>tr.cancellationReason,nt=({showWarning:t=!0}={})=>{let e=er();e&&(t&&d("%s",e),et.emit("runCancelled",e))}});var tt=f(()=>{"use strict";o();Nn()});var rr,fc,Ln,Un,st,ot=f(()=>{"use strict";o();rr=require("async_hooks"),fc=new rr.AsyncLocalStorage,Ln=new Map,Un=(t,e,r)=>{let n=new rr.AsyncLocalStorage;return Ln.set(t,n),async(...s)=>n.run(e,r,...s)},st=t=>{let e=Ln.get(t);return e?e.getStore():null}});var Dn,re,it=f(()=>{"use strict";o();Dn=require("nanoid"),re=(0,Dn.customAlphabet)("abcdefghijklmnopqrstuvwxyz",10)});function $n(t){(0,O.match)(t).when(Bn.isAxiosError,Ai).otherwise(()=>{d("Unexpected error while sending network request: %s",t)})}function Ai(t){return(0,O.match)(t).with({code:"ECONNABORTED"},()=>{d("Network connection aborted")}).with({code:"ECONNREFUSED"},()=>{d("Network connection aborted")}).with({code:"ECONNRESET"},()=>{d("Network connection reset")}).with({code:"ETIMEDOUT"},()=>{d("Network connection timeout")}).with({response:O.P.not(O.P.nullish)},e=>{wi(e,{status:e.response.status,data:e.response.data})}).otherwise(e=>{d(`[currents] Unexpected network error: %s
%O`,t.message,{method:t.response?.config.method,url:t.response?.config.url,status:t.response?.status,payload:t.response?.config.data,requestId:Fe(t)})})}function wi(t,{status:e,data:r}){(0,O.match)(e).with(401,()=>{d(`[currents] ${t.response?.config.method} ${t.response?.config.url}} - 401 Unauthorized Request from cloud service`)}).with(400,()=>{d(`[currents] ${t.response?.config.method} ${t.response?.config.url} - 400 Bad Request from cloud service:
%o`,r)}).with(429,()=>{d(`[currents] ${t.response?.config.method} ${t.response?.config.url} - 429 Too Many Requests from cloud service`)}).with(422,()=>{Pi(t,r)}).otherwise(()=>{d(`[currents] Unexpected network response: %s
%O`,t.message,{method:t.response?.config.method,url:t.response?.config.url,status:t.response?.status,requestId:Fe(t)})})}function Pi(t,e){(0,O.match)(e).with({code:nr.MISSING_SUITE,message:O.P.string,errors:O.P.array(O.P.string)},async r=>{let{message:n,errors:s}=r,i=st("discovery");Ne(1),y(...Fn(n,s)),at({id:re(),text:(0,kn.default)(i,null,2)}).then(a=>{y(`Please share this URL with Currents support for further investigation:
${a}`)}).catch(a=>{d("Failed to upload debug artifact: %s",a)}),Ne(1)}).with({code:nr.RUN_CANCELLED,message:O.P.string},r=>{rt(r.message),nt()}).with({code:nr.RUN_EXPIRED,message:O.P.string},r=>{d(r.message)}).with({message:O.P.string,errors:O.P.array(O.P.string)},r=>{let{message:n,errors:s}=r;Ne(1),d(...Fn(n,s)),Ne(1)}).otherwise(()=>{d(`[currents] Unexpected network response: %s
%O`,t.message,{method:t.response?.config.method,url:t.response?.config.url,status:t.response?.status,requestId:Fe(t)})})}function Fn(t,e){return jn.default.isString(t)?e?.length===0?[t]:[t,`
${(e??[]).map(r=>`  - ${r}`).join(`
`)}
`]:["Unexpected network error"]}function Fe(t){return t?.response?.headers["apigw-requestid"]}var Bn,kn,jn,O,nr,sr=f(()=>{"use strict";o();Bn=require("axios"),kn=g(require("json-stringify-safe")),jn=g(require("lodash")),O=require("ts-pattern");tt();ot();it();T();or();nr={RUN_CANCELLED:"RUN_CANCELLED",RUN_EXPIRED:"RUN_EXPIRED",MISSING_SUITE:"MISSING_SUITE"}});function Vn(t,e,r){let n=r.method?.toUpperCase(),s=r.url,i=Fe(e),a=(0,Gn.default)(ar(t)),c=`Network request '${n} ${s}' failed: '${e.message}'.${i?` Request ID: ${i}.`:""} Next attempt is in ${a} (${t}/${r["axios-retry"]?.retries||ur()}).`;Hn(c),d(c)}var ir,Gn,Hn,ar,Wn,ur,qn=f(()=>{"use strict";o();ir=require("axios"),Gn=g(require("pretty-ms"));E();T();sr();Hn=l.extend("http"),ar=t=>[3*1e3,15*1e3,30*1e3][t-1],Wn=t=>(Hn("isRetriableError: %o",{message:t.message,code:"code"in t?t.code:void 0,status:"response"in t?t.response?.status:void 0,headers:"response"in t?t.response?.headers:void 0,data:"response"in t?t.response?.data:void 0,isAxiosError:(0,ir.isAxiosError)(t)}),"code"in t&&t.code&&["ECONNABORTED","ECONNREFUSED","ECONNRESET","ETIMEDOUT","ENETRESET","ENOTFOUND","EAI_AGAIN"].includes(t.code)?!0:(0,ir.isAxiosError)(t)?[429,500,502,503,504].includes(t.response?.status??0):!1),ur=()=>3});function ns(t){rs["x-pw-version"]=t??"0.0.0"}function Ni(){let t=Ze({baseURL:Xt(),timeout:An(),transitional:{clarifyTimeoutError:!0}});return t.interceptors.request.use(async e=>{let{currentsOptions:r}=e,n={...Oi,...r};return n.enableCompression&&(0,Zn.default)(e.data)>n.compressThresholdBytes?(e.headers["Content-Encoding"]="gzip",{...e,data:await vi((0,zn.default)(e.data))}):e}),t.interceptors.request.use(e=>{let r=e["axios-retry"]?.retryCount??0,n=P();e.headers.set({...rs,"Accept-Encoding":"gzip, deflate, br","x-currents-idempotency-key":e.headers["x-currents-idempotency-key"]??(0,Xn.nanoid)(),"x-pwc-request-attempt":r,"x-currents-key":n?.recordKey??null}),n?.orchestrationId&&e.headers.set("x-currents-orchestration-id",n.orchestrationId),n?.machineId&&e.headers.set("x-currents-machine-id",n.machineId),e.headers.get("Content-Type")||e.headers.set("Content-Type","application/json");let s={...Qn.default.pick(e,"method","url","headers"),data:Buffer.isBuffer(e.data)?"buffer":e.data};return r?Jn("network request retry: %o",Kn({...s,isRetry:!0})):Jn("network request: %o",Kn(s)),e}),(0,Yn.default)(t,{retries:ur(),retryCondition:Wn,retryDelay:ar,shouldResetTimeout:!0,onRetry:Vn}),t}function ss(){return ut||(ut=Ni(),ut)}function Kn(t){return{method:t.method,baseUrl:Xt(),url:t.url,data:t.isRetry?"<retry>":Li(t.data),headers:{...t.headers,"x-currents-key":"***"}}}function Li(t){return t?.results?.raw?{...t,results:{...t.results,raw:"***"}}:t}var Yn,zn,Qn,Xn,Zn,es,ts,Jn,bi,rs,vi,ut,Oi,cr=f(()=>{"use strict";o();Yn=g(require("axios-retry")),zn=g(require("json-stringify-safe")),Qn=g(require("lodash")),Xn=require("nanoid"),Zn=g(require("object-sizeof")),es=require("util"),ts=g(require("zlib"));j();E();zt();Qt();wn();qn();Jn=l.extend("http"),bi=1024*1024*1,rs={"x-pw-version":"0.0.0","x-pwc-version":Qe},vi=(0,es.promisify)(ts.default.gzip);ut=null,Oi={enableCompression:!1,compressThresholdBytes:bi}});async function U(t,e=ss){try{let r=await e().request(t);return os("network response: %o",{...is.default.omit(r,"request","config"),url:r.config.url,method:r.config.method}),r}catch(r){let n=r;throw os("network error: %o",{code:n.code,message:n.message,url:n.config?.url,method:n.config?.method,status:n.response?.status,headers:n.response?.headers,data:n.response?.data}),$n(n),n}}var is,os,as=f(()=>{"use strict";o();is=g(require("lodash"));E();cr();sr();os=l.extend("http")});var ne=f(()=>{"use strict";o();as()});var us={};kt(us,{getDebugUrl:()=>Ui});var Ui,cs=f(()=>{"use strict";o();ne();Ui=({runId:t,type:e})=>U({method:"POST",url:"runs/debug-logs",data:{type:e,runId:t}}).then(r=>r.data)});function Di(t,e){return ct({path:t,name:null,uploadUrl:e,contentType:"text/plain"},"text/plain",void 0)}async function ct(t,e,r){let n=await ps.default.readFile(t.path);return lr("Uploading file %s",t.uploadUrl,{buffer:Buffer.byteLength(n)}),ds(n,t.uploadUrl,e,r)}async function pr(t,e,r){return lr("Uploading buffer %s",t.name,{buffer:Buffer.byteLength(t.buffer)}),ds(t.buffer,t.uploadUrl,e,r)}async function Fi(t,e,r,n){return Ze().request({method:"put",url:e,data:t,onUploadProgress:n,headers:{"Content-Disposition":"inline","Content-Type":r}})}async function ds(...t){await(0,ls.default)(async()=>{await Fi(...t)},{retries:5,onRetry:(e,r)=>{if(lr("Upload failed %d out of 5 attempts: %s",r,e.message),r===5){y(`Cannot upload after ${r} times: ${e.message}`);return}d(`Upload failed ${r} out of 5 attempts: ${e.message}`)}})}var ls,ps,lr,gs,ms=f(()=>{"use strict";o();ls=g(require("async-retry")),ps=g(require("fs/promises"));E();Qt();T();lr=l.extend("upload"),gs=(s=>(s.PNG="image/png",s.WEBM="video/webm",s.TEXT="text/plain",s.ZIP="application/zip",s))(gs||{})});var fs={};kt(fs,{ContentType:()=>gs,sendBuffer:()=>pr,sendPath:()=>ct,uploadText:()=>Di});var gr=f(()=>{"use strict";o();ms()});async function at(t){let{getDebugUrl:e}=await Promise.resolve().then(()=>(cs(),us));try{let{readUrl:r,uploadUrl:n}=await e({runId:t.id,type:"pw-debug"}),{uploadText:s,sendBuffer:i}=await Promise.resolve().then(()=>(gr(),fs));return"text"in t&&await i({name:`${t.id}-discovery-debug.log`,buffer:Buffer.from(t.text,"utf-8"),contentType:"text/plain",uploadUrl:n},"text/plain",void 0),"path"in t&&await s(t.path,n),r}catch{return null}}var dr,mr=f(()=>{"use strict";o();dr=g(require("debug"))});function Mi(t){return t==="false"?!1:t==="remote"?"remote":t==="full"?"full":!!t}var hs,Es,Cs=f(()=>{"use strict";o();hs=require("@commander-js/extra-typings"),Es=new hs.Option("--pwc-debug [boolean | 'remote' | 'full']","enable debug logs for the reporter. Specify 'remote' to upload logs to Currents. Specify 'full' to dump the debug logs to stdout and upload to Currents.").argParser(Mi).env("CURRENTS_DEBUG")});var Is,Rs,Ts=f(()=>{"use strict";o();Is=require("@commander-js/extra-typings");Cs();Rs=()=>new Is.Command().allowUnknownOption().addOption(Es).helpOption(!1)});var z,_s,hr,ys,Ss,fr,lt,Er=f(()=>{"use strict";o();z=g(require("debug")),_s=g(require("fs")),hr=g(require("path")),ys=g(require("util")),Ss=require("fs/promises");it();T();Ts();mr();z.default.useColors=function(){return!1};fr=z.default.log,lt=class t{constructor(e="core"){this.source=e;this.pipelines={};if(this.mode=Rs().parse().opts().pwcDebug??!1,this.debug=(0,z.default)(`currents:remote-debug:${this.source}`),!this.mode)return this;if(!this.shouldEnableDebug())return this;let r=process.env.DEBUG?`${process.env.DEBUG},currents*`:"currents*";if(z.default.enable(r),!this.shouldUploadRemoteDebug())return this;let n=re(),s=hr.default.resolve(".currents-debug"),i=hr.default.resolve(s,`${n}.log`);(0,Ss.mkdir)(s,{recursive:!0}),w(m(`\u{1F47E} Initiated remote ${this.source} debug log collection:`),m(i));let a=_s.default.createWriteStream(i,{flags:"a"});return z.default.log=(...c)=>{this.mode&&(a.write(`${ys.default.formatWithOptions({colors:!1},...c)}
`),this.shouldMuteLocalStdout()||fr(...c))},this.pipelines[n]={id:n,writeStream:a,type:this.source,tempFilePath:i},this}static factory(e="core"){return this.instance||(this.instance=new t(e)),this.instance}getDebugMode(){return this.mode}async finalize({runId:e}={runId:void 0}){try{let r=Object.keys(this.pipelines);r.length===0&&(this.debug("No debug pipelines found"),z.default.log=fr);for(let n of r)await this.uploadDebug(n,e??re())}catch{}finally{z.default.log=fr}}async uploadDebug(e,r){let n=this.pipelines[e];if(!n){this.debug("No debug pipeline found for id %s",e);return}w(m(`\u{1F47E} ${n.type} debug log written:`),m(n?.tempFilePath));try{let s=await at({id:r,path:n.tempFilePath});n?.writeStream.end(),w(m(`\u{1F47E} ${n.type} debug log uploaded:`),m(s))}catch(s){d(`Failed to upload ${n.type}} debug log ${m(n.tempFilePath)}: ${s.message}`)}}shouldEnableDebug(){return this.mode==="full"||this.mode==="remote"||this.mode===!0}shouldUploadRemoteDebug(){return this.mode==="full"||this.mode==="remote"}shouldMuteLocalStdout(){return this.mode==="remote"}}});var or=f(()=>{"use strict";o();mr();Er()});var l,E=f(()=>{"use strict";o();or();l=(0,dr.default)("currents")});var eu={};kt(eu,{configHelpers:()=>Xa,currentsReporter:()=>za,default:()=>Za,fixtures:()=>Qa});module.exports=Ri(eu);o();o();o();var ks=g(require("crypto")),Rt=g(require("fs")),X=g(require("path"));E();o();var pt=g(require("fs")),xs=g(require("istanbul-lib-coverage")),As=g(require("p-map"));E();var gt=l.extend("coverage");function H({target:t,stage:e}){return({event:r,status:n,message:s,details:i})=>{let a=i?JSON.stringify(i):"",c=`[${e}] [${r}] [${n}] ${s} ${a}`,p=["test_attempt_reports_generation","test_attempt_reports_merging"].includes(e)?c:`${c} [${JSON.stringify(t)}]`;gt(p)}}async function dt(t){try{return await pt.default.promises.readdir(t)}catch(e){return gt(e),null}}async function Bi(t){try{return await pt.default.promises.readFile(t,"utf-8")}catch(e){return gt(e),null}}async function ki(t){try{let e=JSON.parse(t);return Object.keys(e).length===0?"empty":e}catch(e){return gt(e),"invalid"}}async function ji(t,e){try{let n=(await pt.default.promises.stat(t)).size/(1024*1024),s=await Bi(t);if(!s)return e({event:"file_read",status:"failed",message:"Failed to read file",details:{filePath:t,fileSizeInMB:n}}),null;e({event:"file_read",status:"passed",message:"File read successfully",details:{filePath:t,fileSizeInMB:n}});let i=await ki(s);switch(i){case"empty":return e({event:"parse",status:"passed",message:"Coverage JSON is empty",details:{filePath:t}}),null;case"invalid":return e({event:"parse",status:"failed",message:"Coverage report is not a valid JSON",details:{filePath:t}}),null;default:return e({event:"parse",status:"passed",message:"Coverage report parsed successfully",details:{filePath:t}}),i}}catch(r){return e({event:"file_read",status:"failed",message:"Error processing coverage file",details:{filePath:t,error:r}}),null}}async function mt(t,e){let r=xs.default.createCoverageMap({}),n=0;if(await(0,As.default)(t,async s=>{let i=await ji(s,e);if(i)try{r.merge(i),n++,e({event:"merge",status:"passed",message:"Merged file successfully",details:{filePath:s}})}catch(a){e({event:"merge",status:"failed",message:"Failed to merge file",details:{filePath:s,error:a}})}},{concurrency:5}),n===0)return e({event:"merge",status:"failed",message:"No files merged",details:{files:t.length}}),null;e({event:"merge",status:"passed",message:"Merged files successfully",details:{files:n}});try{let s=r.toJSON();return e({event:"parse",status:"passed",message:"Parsed coverage map data",details:{files:t.length}}),s}catch(s){e({event:"parse",status:"failed",message:"Failed to parse coverage map data",details:{files:t.length,error:s}})}return null}var ws=(t,e={})=>e.coverage?.projects===!0?!0:Array.isArray(e.coverage?.projects)&&e.coverage.projects.includes(t);o();o();var Cr=require("lodash");o();var ft=g(require("path"));function Ps(t,e){return $i(ft.default.relative(e,t.file))}function $i(t){return t.split(ft.default.sep).join(ft.default.posix.sep)}function Q(t){return W(t.parent.project())}function A(t){let e=t.titlePath(),r=Et(t).title;return e.slice(e.indexOf(r)+1,e.length)}function ht(t){return t.titlePath().filter(e=>!!e).join(" > ")}function Et(t){let e=t.parent;for(;e.parent?.location;)e=e.parent;return e}function B(t,e){let r=Et(t).location;return Ps(r,e.rootDir)}function D(t){return t.id??t._id}function se(t,e){return`${D(t)}-${e.retry}`}function bs(t){return{workerIndex:(0,Cr.isNil)(t.results[0]?.workerIndex)?-1:t.results[0].workerIndex,parallelIndex:(0,Cr.isNil)(t.results[0]?.parallelIndex)?-1:t.results[0].parallelIndex}}function vs(t){if(t._only)return!0;let e=t.parent;for(;e.parent;){if(e._only)return!0;e=e.parent}return!1}function W(t){if(!t)return"__currents_no_project__";let r=("__projectId"in t?t.__projectId:"").trim(),n=t.name.trim()?r:`project${r?`-0${r}`:""}`;if(n.length>256)throw new Error(`Project name is too long for ${n}`);return n}function Os(t,e){return t.suites.map(r=>{let n=e.projects.find(s=>s.name===r.title);return{name:W(r.project()),tags:(n?.metadata?.pwc?.tags??[]).map(s=>s.trim()),tests:Gi(r,e)}})}function Gi(t,e){let r=t.allTests().map(n=>({isOnly:vs(n),title:A(n),spec:B(n,e),tags:Hi(n),testId:D(n)}));return r.some(n=>n.isOnly)?r.filter(n=>n.isOnly):r}function Hi(t){let e=(A(t).join(" ").match(/@(\S+)/g)??[]).filter(Boolean).map(r=>r);return Array.from(new Set([...e,...t.tags??[]].map(r=>r.trim()).map(r=>r.replace("@",""))))}T();o();var Ct=g(require("fs")),Us=g(require("os")),It=g(require("path"));o();var Me={OR8N_SUITE_FILE_PREFIX:"currents-or8n-",FIXTURES_DIR_PREFIX:"currents-fixtures-",FIXTURES_CONFIG_ERR_FILE:"config_fixture_error.log",FIXTURES_WARNING_FILE_PREFIX:"config_fixture_warning"};o();var Be=g(require("fs")),Wi=require("tmp-promise");function Ns(t){try{return Be.closeSync(Be.openSync(t,"wx")),!0}catch(e){if(e.code==="EEXIST")return!1;throw e}}T();var Ls=()=>process.env.CURRENTS_FIXTURES_TMP_DIR??It.resolve(Us.tmpdir(),`${Me.FIXTURES_DIR_PREFIX}${process.ppid}`),Ds=(t,e)=>{let r=e.stack??e.message;Ct.appendFileSync(t,r)},Ir=t=>(Ct.mkdirSync(Ls(),{recursive:!0}),It.join(Ls(),t)),Ie=(t,e)=>{let r=Ir(`${Me.FIXTURES_WARNING_FILE_PREFIX}_${t}.log`);Ns(r)&&e.forEach(s=>d(s))};var js=l.extend("fixture");function Vi(t){return t.coverage?.dir?X.default.resolve(t.coverage?.dir):X.default.join(process.cwd(),".nyc_output")}function Rr(t){return t.name||"project"}function qi(t,e){return X.default.join(t,Rr(e))}function Ji(){return ks.default.randomBytes(16).toString("hex")}async function Ki(t,e){let r=await dt(t);if(!r)return e({event:"find",status:"failed",message:"Coverage directory not found",details:{coverageFiles:r}}),null;if(r.length===0)return e({event:"find",status:"failed",message:"No coverage files found",details:{coverageFiles:r,coverageDir:t}}),null;let n=r.map(s=>X.default.join(t,s));return mt(n,e)}async function Yi(t,e,r){let{project:n,testId:s,retry:i,titlePath:a}=e,c=Rr(n),p=X.default.join(r,`${s}-${i}`),h=H({target:{projectId:c,titlePath:a,testId:s,attemptId:i},stage:"test_attempt_reports_generation"});return await t.addInitScript(()=>window.addEventListener("beforeunload",()=>{if(console.info("Location: "+window.location.href),!window.__coverage__){console.warn("Coverage data is not available in window.__coverage__ before unloading the page.");return}window.collectIstanbulCoverage(JSON.stringify(window.__coverage__))})),await Rt.default.promises.mkdir(p,{recursive:!0}),h({event:"file_write",status:"passed",message:"Coverage directory created",details:{coverageDir:p}}),await t.exposeFunction("collectIstanbulCoverage",async I=>{if(!I)return;let C=X.default.join(p,`${Ji()}.json`);try{await Rt.default.promises.writeFile(C,I),h({event:"file_write",status:"passed",message:"Coverage file created",details:{coverageFilePath:C}})}catch(R){h({event:"file_write",status:"failed",message:"Failed to create coverage file",details:{coverageFilePath:C,error:R}})}}),p}async function zi(t,e,r,n){let{project:s,testId:i,retry:a,titlePath:c}=e,p=Rr(s);for(let R of t.pages())try{await R.evaluate(()=>{if(!window.__coverage__){console.warn("Coverage data is not available in window.__coverage__ after test execution. This may result in incomplete coverage reports.");return}window.collectIstanbulCoverage(JSON.stringify(window.__coverage__))})}catch{d("Failed to collect coverage from all pages. Coverage may be incomplete")}let h=H({target:{projectId:p,titlePath:c,testId:i,attemptId:a},stage:"test_attempt_reports_merging"}),I=await Ki(n,h);if(!I){h({event:"merge",status:"failed",message:"Failed to obtain coverage map",details:{coverageDir:n}});return}let C=X.default.join(r,`${i}-${a}.json`);try{await Rt.default.promises.writeFile(C,JSON.stringify(I,null,2)),h({event:"file_write",status:"passed",message:"Test attempt coverage file created",details:{coverageOutputPath:C}})}catch(R){h({event:"file_write",status:"failed",message:"Failed to create test attempt coverage file",details:{coverageOutputPath:C,error:R}})}}var Qi=async function({context:t,currentsConfig:e,use:r,testInfo:n}){if(!e)return await Ie("coverageFixture",["Currents config not found. Skipping coverage fixture"]),await r(t);if(!ws(W(n.project),e))return js("Coverage is disabled"),await r(t);let{project:s}=n,i,a;try{i=qi(Vi(e),s),a=await Yi(t,n,i)}catch(c){d("Failed to setup coverage context",c)}if(await r(t),!(!i||!a))try{await zi(t,n,i,a)}catch(c){d("Failed to collect coverage",c)}},$s=async({context:t,currentsFixturesEnabled:e,currentsConfig:r},n,s)=>{if(!e)return js("Currents fixtures disabled, skipping coverage fixture"),await n(t);await Qi({context:t,currentsConfig:r,use:n,testInfo:s})};o();o();o();var Tr=class{constructor(){this._state={}}getState(e){return this._state[e]}upsertState(e,r){return this._state[e]||(typeof r=="function"?this._state[e]=r():this._state[e]=r),this._state[e]}async populateState(e,r){return this._state[e]||(this._state[e]=await r),this._state[e]}},$=new Tr;E();o();var Ks=require("@currents/commit-info"),Ys=require("lodash");o();var _t=require("lodash");E();o();var S=require("lodash");E();it();var Tt=l.extend("ci"),Xi=(t,...e)=>(0,S.chain)(e).compact().join(t).value(),Zi=(t,e)=>(0,S.set)(t,(0,S.camelCase)(e),process.env[e]),_=t=>(0,S.transform)(t,Zi,{}),ea=()=>process.env.TF_BUILD&&process.env.TF_BUILD_BUILDNUMBER,ta=()=>process.env.TF_BUILD&&process.env.AZURE_HTTP_USER_AGENT,ra=()=>(0,S.some)(process.env,(t,e)=>/^CODEBUILD_/.test(e)),na=()=>process.env.bamboo_buildNumber,sa=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&process.env.CODESHIP,oa=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&!process.env.CODESHIP,ia=()=>(0,S.some)(process.env,(t,e)=>/^CONCOURSE_/.test(e)),aa=()=>process.env.GITLAB_CI||process.env.CI_SERVER_NAME&&/^GitLab/.test(process.env.CI_SERVER_NAME),ua=()=>process.env.GCP_PROJECT||process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT,ca=()=>process.env.JENKINS_URL||process.env.JENKINS_HOME||process.env.JENKINS_VERSION||process.env.HUDSON_URL||process.env.HUDSON_HOME,la=()=>process.env.WERCKER||process.env.WERCKER_MAIN_PIPELINE_STARTED,pa={appveyor:"APPVEYOR",azure:ta,awsCodeBuild:ra,bamboo:na,bitbucket:"BITBUCKET_BUILD_NUMBER",buildkite:"BUILDKITE",circle:"CIRCLECI",codeshipBasic:sa,codeshipPro:oa,concourse:ia,codeFresh:"CF_BUILD_ID",drone:"DRONE",githubActions:"GITHUB_ACTIONS",gitlab:aa,goCD:"GO_JOB_NAME",googleCloud:ua,jenkins:ca,semaphore:"SEMAPHORE",shippable:"SHIPPABLE",teamcity:"TEAMCITY_VERSION",teamfoundation:ea,travis:"TRAVIS",wercker:la,netlify:"NETLIFY",layerci:"LAYERCI"};function ga(){let{env:t}=process;return(0,S.findKey)(pa,e=>{if((0,S.isString)(e))return t[e];if((0,S.isFunction)(e))return e()})}var Gs=()=>({appveyor:_(["APPVEYOR_JOB_ID","APPVEYOR_ACCOUNT_NAME","APPVEYOR_PROJECT_SLUG","APPVEYOR_BUILD_NUMBER","APPVEYOR_BUILD_VERSION","APPVEYOR_PULL_REQUEST_NUMBER","APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH"]),azure:_(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID","BUILD_REPOSITORY_URI","SYSTEM_TEAMPROJECT","SYSTEM_COLLECTIONURI"]),awsCodeBuild:_(["CODEBUILD_BUILD_ID","CODEBUILD_BUILD_NUMBER","CODEBUILD_RESOLVED_SOURCE_VERSION","CODEBUILD_SOURCE_REPO_URL","CODEBUILD_SOURCE_VERSION"]),bamboo:_(["bamboo_buildNumber","bamboo_buildResultsUrl","bamboo_planRepository_repositoryUrl","bamboo_buildKey"]),bitbucket:_(["BITBUCKET_REPO_SLUG","BITBUCKET_REPO_OWNER","BITBUCKET_BUILD_NUMBER","BITBUCKET_PARALLEL_STEP","BITBUCKET_STEP_RUN_NUMBER","BITBUCKET_PR_ID","BITBUCKET_PR_DESTINATION_BRANCH","BITBUCKET_PR_DESTINATION_COMMIT"]),buildkite:_(["BUILDKITE_REPO","BUILDKITE_SOURCE","BUILDKITE_JOB_ID","BUILDKITE_BUILD_ID","BUILDKITE_BUILD_URL","BUILDKITE_BUILD_NUMBER","BUILDKITE_PULL_REQUEST","BUILDKITE_PULL_REQUEST_REPO","BUILDKITE_PULL_REQUEST_BASE_BRANCH"]),circle:_(["CIRCLE_JOB","CIRCLE_BUILD_NUM","CIRCLE_BUILD_URL","CIRCLE_PR_NUMBER","CIRCLE_PR_REPONAME","CIRCLE_PR_USERNAME","CIRCLE_COMPARE_URL","CIRCLE_WORKFLOW_ID","CIRCLE_PULL_REQUEST","CIRCLE_REPOSITORY_URL","CI_PULL_REQUEST"]),codeshipBasic:_(["CI_BUILD_ID","CI_REPO_NAME","CI_BUILD_URL","CI_PROJECT_ID","CI_BUILD_NUMBER","CI_PULL_REQUEST"]),codeshipPro:_(["CI_BUILD_ID","CI_REPO_NAME","CI_PROJECT_ID"]),concourse:_(["BUILD_ID","BUILD_NAME","BUILD_JOB_NAME","BUILD_PIPELINE_NAME","BUILD_TEAM_NAME","ATC_EXTERNAL_URL"]),codeFresh:_(["CF_BUILD_ID","CF_BUILD_URL","CF_CURRENT_ATTEMPT","CF_STEP_NAME","CF_PIPELINE_NAME","CF_PIPELINE_TRIGGER_ID","CF_PULL_REQUEST_ID","CF_PULL_REQUEST_IS_FORK","CF_PULL_REQUEST_NUMBER","CF_PULL_REQUEST_TARGET"]),drone:_(["DRONE_JOB_NUMBER","DRONE_BUILD_LINK","DRONE_BUILD_NUMBER","DRONE_PULL_REQUEST"]),githubActions:_(["GITHUB_WORKFLOW","GITHUB_ACTION","GITHUB_EVENT_NAME","GITHUB_RUN_ID","GITHUB_RUN_ATTEMPT","GITHUB_REPOSITORY"]),gitlab:_(["CI_PIPELINE_ID","CI_PIPELINE_URL","CI_BUILD_ID","CI_JOB_ID","CI_JOB_URL","CI_JOB_NAME","GITLAB_HOST","CI_PROJECT_ID","CI_PROJECT_URL","CI_REPOSITORY_URL","CI_ENVIRONMENT_URL","CI_DEFAULT_BRANCH"]),goCD:_(["GO_SERVER_URL","GO_ENVIRONMENT_NAME","GO_PIPELINE_NAME","GO_PIPELINE_COUNTER","GO_PIPELINE_LABEL","GO_STAGE_NAME","GO_STAGE_COUNTER","GO_JOB_NAME","GO_TRIGGER_USER","GO_REVISION","GO_TO_REVISION","GO_FROM_REVISION","GO_MATERIAL_HAS_CHANGED"]),googleCloud:_(["BUILD_ID","PROJECT_ID","REPO_NAME","BRANCH_NAME","TAG_NAME","COMMIT_SHA","SHORT_SHA"]),jenkins:_(["BUILD_ID","BUILD_URL","BUILD_NUMBER","ghprbPullId"]),semaphore:_(["SEMAPHORE_BRANCH_ID","SEMAPHORE_BUILD_NUMBER","SEMAPHORE_CURRENT_JOB","SEMAPHORE_CURRENT_THREAD","SEMAPHORE_EXECUTABLE_UUID","SEMAPHORE_GIT_BRANCH","SEMAPHORE_GIT_DIR","SEMAPHORE_GIT_REF","SEMAPHORE_GIT_REF_TYPE","SEMAPHORE_GIT_REPO_SLUG","SEMAPHORE_GIT_SHA","SEMAPHORE_GIT_URL","SEMAPHORE_JOB_COUNT","SEMAPHORE_JOB_ID","SEMAPHORE_JOB_NAME","SEMAPHORE_JOB_UUID","SEMAPHORE_PIPELINE_ID","SEMAPHORE_PLATFORM","SEMAPHORE_PROJECT_DIR","SEMAPHORE_PROJECT_HASH_ID","SEMAPHORE_PROJECT_ID","SEMAPHORE_PROJECT_NAME","SEMAPHORE_PROJECT_UUID","SEMAPHORE_REPO_SLUG","SEMAPHORE_TRIGGER_SOURCE","SEMAPHORE_WORKFLOW_ID","PULL_REQUEST_NUMBER"]),shippable:_(["SHIPPABLE_BUILD_ID","SHIPPABLE_BUILD_NUMBER","SHIPPABLE_COMMIT_RANGE","SHIPPABLE_CONTAINER_NAME","SHIPPABLE_JOB_ID","SHIPPABLE_JOB_NUMBER","SHIPPABLE_REPO_SLUG","IS_FORK","IS_GIT_TAG","IS_PRERELEASE","IS_RELEASE","REPOSITORY_URL","REPO_FULL_NAME","REPO_NAME","BUILD_URL","BASE_BRANCH","HEAD_BRANCH","IS_PULL_REQUEST","PULL_REQUEST","PULL_REQUEST_BASE_BRANCH","PULL_REQUEST_REPO_FULL_NAME"]),teamcity:null,teamfoundation:_(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID"]),travis:_(["TRAVIS_JOB_ID","TRAVIS_BUILD_ID","TRAVIS_BUILD_WEB_URL","TRAVIS_REPO_SLUG","TRAVIS_JOB_NUMBER","TRAVIS_EVENT_TYPE","TRAVIS_COMMIT_RANGE","TRAVIS_BUILD_NUMBER","TRAVIS_PULL_REQUEST","TRAVIS_PULL_REQUEST_BRANCH","TRAVIS_PULL_REQUEST_SHA"]),wercker:null,netlify:_(["BUILD_ID","CONTEXT","URL","DEPLOY_URL","DEPLOY_PRIME_URL","DEPLOY_ID"]),layerci:_(["LAYERCI_JOB_ID","LAYERCI_RUNNER_ID","RETRY_INDEX","LAYERCI_PULL_REQUEST","LAYERCI_REPO_NAME","LAYERCI_REPO_OWNER","LAYERCI_BRANCH","GIT_TAG"])}),da=()=>{let{env:t}=process;return{appveyor:{sha:t.APPVEYOR_REPO_COMMIT,branch:t.APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH||t.APPVEYOR_REPO_BRANCH,message:Xi(`
`,t.APPVEYOR_REPO_COMMIT_MESSAGE,t.APPVEYOR_REPO_COMMIT_MESSAGE_EXTENDED),authorName:t.APPVEYOR_REPO_COMMIT_AUTHOR,authorEmail:t.APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL},awsCodeBuild:{sha:t.CODEBUILD_RESOLVED_SOURCE_VERSION,remoteOrigin:t.CODEBUILD_SOURCE_REPO_URL},azure:{sha:t.BUILD_SOURCEVERSION,branch:t.BUILD_SOURCEBRANCHNAME,message:t.BUILD_SOURCEVERSIONMESSAGE,authorName:t.BUILD_SOURCEVERSIONAUTHOR,authorEmail:t.BUILD_REQUESTEDFOREMAIL},bamboo:{sha:t.bamboo_planRepository_revision,branch:t.bamboo_planRepository_branch,authorName:t.bamboo_planRepository_username,remoteOrigin:t.bamboo_planRepository_repositoryURL},bitbucket:{sha:t.BITBUCKET_COMMIT,branch:t.BITBUCKET_BRANCH},buildkite:{sha:t.BUILDKITE_COMMIT,branch:t.BUILDKITE_BRANCH,message:t.BUILDKITE_MESSAGE,authorName:t.BUILDKITE_BUILD_CREATOR,authorEmail:t.BUILDKITE_BUILD_CREATOR_EMAIL,remoteOrigin:t.BUILDKITE_REPO,defaultBranch:t.BUILDKITE_PIPELINE_DEFAULT_BRANCH},circle:{sha:t.CIRCLE_SHA1,branch:t.CIRCLE_BRANCH,authorName:t.CIRCLE_USERNAME,remoteOrigin:t.CIRCLE_REPOSITORY_URL},codeshipBasic:{sha:t.CI_COMMIT_ID,branch:t.CI_BRANCH,message:t.CI_COMMIT_MESSAGE,authorName:t.CI_COMMITTER_NAME,authorEmail:t.CI_COMMITTER_EMAIL},codeshipPro:{sha:t.CI_COMMIT_ID,branch:t.CI_BRANCH,message:t.CI_COMMIT_MESSAGE,authorName:t.CI_COMMITTER_NAME,authorEmail:t.CI_COMMITTER_EMAIL},codeFresh:{sha:t.CF_REVISION,branch:t.CF_BRANCH,message:t.CF_COMMIT_MESSAGE,authorName:t.CF_COMMIT_AUTHOR},drone:{sha:t.DRONE_COMMIT_SHA,branch:t.DRONE_SOURCE_BRANCH,message:t.DRONE_COMMIT_MESSAGE,authorName:t.DRONE_COMMIT_AUTHOR,authorEmail:t.DRONE_COMMIT_AUTHOR_EMAIL,remoteOrigin:t.DRONE_GIT_HTTP_URL,defaultBranch:t.DRONE_REPO_BRANCH},githubActions:{sha:t.GITHUB_SHA,branch:t.GH_BRANCH||t.GITHUB_REF,defaultBranch:t.GITHUB_BASE_REF,remoteBranch:t.GITHUB_HEAD_REF,runAttempt:t.GITHUB_RUN_ATTEMPT},gitlab:{sha:t.CI_COMMIT_SHA,branch:t.CI_COMMIT_REF_NAME,message:t.CI_COMMIT_MESSAGE,authorName:t.GITLAB_USER_NAME,authorEmail:t.GITLAB_USER_EMAIL,remoteOrigin:t.CI_REPOSITORY_URL,defaultBranch:t.CI_DEFAULT_BRANCH},googleCloud:{sha:t.COMMIT_SHA,branch:t.BRANCH_NAME},jenkins:{sha:t.GIT_COMMIT,branch:t.GIT_BRANCH},semaphore:{sha:t.SEMAPHORE_GIT_SHA,branch:t.SEMAPHORE_GIT_BRANCH,remoteOrigin:t.SEMAPHORE_GIT_REPO_SLUG},shippable:{sha:t.COMMIT,branch:t.BRANCH,message:t.COMMIT_MESSAGE,authorName:t.COMMITTER},snap:null,teamcity:null,teamfoundation:{sha:t.BUILD_SOURCEVERSION,branch:t.BUILD_SOURCEBRANCHNAME,message:t.BUILD_SOURCEVERSIONMESSAGE,authorName:t.BUILD_SOURCEVERSIONAUTHOR},travis:{sha:t.TRAVIS_PULL_REQUEST_SHA||t.TRAVIS_COMMIT,branch:t.TRAVIS_PULL_REQUEST_BRANCH||t.TRAVIS_BRANCH,message:t.TRAVIS_COMMIT_MESSAGE},wercker:null,netlify:{sha:t.COMMIT_REF,branch:t.BRANCH,remoteOrigin:t.REPOSITORY_URL},layerci:{sha:t.GIT_COMMIT,branch:t.LAYERCI_BRANCH,message:t.GIT_COMMIT_TITLE}}},Hs=t=>{let e=Ws();return e?(0,S.chain)(t()).get(e).value():{}};function ma(){return(0,S.chain)(Gs()).omitBy(S.isNull).keys().value()}function Ws(){let t=ga();return Tt("detected CI provider name: %s",t),t||null}function fa(){return Hs(Gs)}function Vs(){return Hs(da)}function ha(t){return t&&ma().includes(t)}function qs(t){let e=fa(),r=Ws(),n=Ea(t,r);return Tt("detected CI provider: %s",r),Tt("detected CI params: %O",e),Tt("detected CI build ID: %o",n),{params:e,provider:r,ciBuildId:n}}function Ea(t,e){return t?{source:"user",value:t}:ha(e)?{source:"server",value:null}:{source:"random",value:`auto:${re()}`}}var _r=l.extend("ci-git");function Js(t){_r("git commit existing info: %O",t);let e=Vs();_r("commit info from provider environment variables: %O",e);let r=(0,_t.transform)(t,(n,s,i)=>{let a=s||(e?e[i]:null);return n[i]=(0,_t.defaultTo)(a,null)});return _r("combined git and environment variables from provider: %O",r),r}var Ca=async()=>{let t=await(0,Ks.commitInfo)();return Js({branch:t.branch,remoteOrigin:t.remote,authorEmail:t.email,authorName:t.author,message:t.message,sha:t.sha,ghaEventData:t.ghaEventData})},yt=(0,Ys.memoize)(Ca);var yr=l.extend("fixture"),Sr=async function(t,e){let r;try{r=await $.upsertState("fixtureGitInfo",async()=>await yt())}catch(n){yr("Failed to retrieve git info",n)}yr("Git info",r),t&&await t(r)},zs=async({currentsFixturesEnabled:t},e,r)=>{if(!t)return yr("Currents fixtures disabled, skipping git info fixture"),await e();await Sr(e,r)};o();E();var Qs=l.extend("fixture"),xr=async function(t,e,r=null,n=null){let s=await $.getState("projectRules");if(!s){Qs("No actions found, skipping actions processing"),await t(n||{});return}s.applyBefore(e,r),await t(n||s.rules),s.applyAfter(e,r)},Xs=async({gitInfo:t,currentsFixturesEnabled:e},r,n)=>{if(!e)return Qs("Currents fixtures disabled, skipping action fixture"),await r({});await xr(r,n,t)};o();j();E();o();var Zs=g(require("crypto"));function oe(t){return typeof t=="string"&&(t=Buffer.from(t)),Zs.default.createHash("md5").update(t).digest("hex")}o();var ao=require("axios");E();T();o();ne();function eo(t){return U({method:"GET",url:`/rules/project/${t}`,"axios-retry":{retries:1}}).then(e=>e.data)}o();o();var N={EQ:"eq",NEQ:"neq",IN:"in",NOTIN:"notIn",ANY:"any",EMPTY:"empty",INC:"inc",NOTINC:"notInc",INCALL:"incAll",NOTINCALL:"notIncAll"},to=[N.EMPTY,N.NEQ,N.NOTIN,N.NOTINC,N.NOTINCALL];o();var ro=g(require("lodash")),no=t=>Array.isArray(t)?t.length>0:!!t,St=(t,e)=>Array.isArray(t)||Array.isArray(e)?ro.default.xor([t].flat(),[e].flat()).length===0:t===e,ke=(t,e)=>{if(Array.isArray(e)||Array.isArray(t)){let r=[t].flat(),n=[e].flat();for(let s=0,i=0,a=!1;s<n.length;){let c=ke(r[i],n[s]);if(c){s++,i=0;continue}if(a=a||!c,i<r.length)i++;else{if(a)return!1;i=0,s<n.length&&s++}}return!0}return typeof e=="string"&&typeof t=="string"?new RegExp(e).test(t):St(t,e)},Ar=(t,e)=>{if(Array.isArray(e)||Array.isArray(t)){let r=[t].flat(),n=[e].flat();for(let s=0,i=0;s<n.length;){if(ke(r[i],n[s]))return!0;i<r.length?i++:(i=0,s<n.length&&s++)}return!1}return St(t,e)},so=(t,e)=>{let r=new Set([t].flat());return[e].flat().every(n=>r.has(n))},wr=(t,e)=>{let r=new Set([t].flat());return[e].flat().some(n=>r.has(n))},oo=(t,e)=>Array.isArray(t)?wr(t,e):new Set([e].flat()).has(t);o();function Pr(t){return typeof t=="string"?io(t):Array.isArray(t)?t.map(io):t}function io(t){return t.startsWith("@")?t:`@${t}`}var xt=({input:t,toMatch:e,op:r,allowRegex:n})=>{let s=(()=>{switch(r){case N.ANY:case N.EMPTY:return no(t);case N.EQ:case N.NEQ:return n?ke(t,e):St(t,e);case N.IN:case N.NOTIN:return n?Ar(t,e):oo(t,e);case N.INC:case N.NOTINC:return n?Ar(t,e):wr(t,e);case N.INCALL:case N.NOTINCALL:return n?ke(t,e):so(t,e);default:return!1}})();return to.includes(r)?!s:s},At=class{constructor(e,r=(n,...s)=>{}){this.rules=e;this._debug=r}matchCondition(e,r){switch(e.type){case"title":case"titlePath":case"file":{let n={input:r[e.type],toMatch:e.value,op:e.op,allowRegex:!0},s=xt(n);return this._debug("Check condition type %s : %O and got result %s",e.type,n,s),s}case"git_branch":case"git_authorName":case"git_authorEmail":case"git_remoteOrigin":case"git_message":{let n={input:r.gitInfo&&r.gitInfo[e.type.replace("git_","")],toMatch:e.value,op:e.op,allowRegex:!0},s=xt(n);return this._debug("Check condition type %s : %O and got result %s",e.type,n,s),s}case"project":case"testId":{let n={input:r[e.type],toMatch:e.value,op:e.op,allowRegex:!1},s=xt(n);return this._debug("Check condition type %s %O and got result %s",e.type,n,s),s}case"tag":{let n=r[e.type]!==void 0?Pr(r[e.type]):void 0,s=e.value!==null?Pr(e.value):null,i={input:n,toMatch:s,op:e.op,allowRegex:!1},a=xt(i);return this._debug("Check condition type %s %O and got result %s",e.type,i,a),a}default:return!1}}matchRule(e,r){return this._debug("Check for rule match %j with test %O",e,r),e.matcher.op==="AND"?e.matcher.cond.every(n=>this.matchCondition(n,r)):e.matcher.op==="OR"?e.matcher.cond.some(n=>this.matchCondition(n,r)):!1}getMatchedRules(e){return this.rules.filter(r=>this.matchRule(r,e))}getMatchedRulesForAction(e,r){return this.getMatchedRules(e).filter(n=>n.action.some(s=>s.op===r))}};o();var je=l.extend("fixture"),wt=class extends At{constructor(r){super(r,je);this.rules=r}testInfoToMatchable(r,n){return{title:r.title,titlePath:r.titlePath,file:r.titlePath[0],project:r.project.name,testId:r.testId,tag:r.tags,gitInfo:n}}applyBefore(r,n){let s=[];try{let i=this.testInfoToMatchable(r,n);s=this.getMatchedRulesForAction(i,"skip"),s.length>0&&je("Test matched after before. %O Actions : %j",i,s)}catch(i){d("Failed to apply before actions",i)}s.some(i=>{let a={rule:{v:i.v,id:i._id,name:i.name,appliedAt:Date.now()},testInfo:{config:{version:r.config.version},testId:r.testId}};r.annotations.push({type:"_currents:rule:skip",description:JSON.stringify(a)}),r.skip(!0,`Skipping due to matched Currents.dev skip action: ${i.name}`)})}applyAfter(r,n){let s=[];try{let i=this.testInfoToMatchable(r,n);s=this.getMatchedRulesForAction(i,"quarantine"),s.length>0&&je("Test matched after rules. %O Actions : %j",i,s)}catch(i){d("Failed to apply after action",i)}s.some(i=>{if(r.expectedStatus!==r.status){let a={rule:{v:i.v,id:i._id,name:i.name,appliedAt:Date.now()},testInfo:{config:{version:r.config.version},testId:r.testId,status:r.status}};je("Quarantining test, status was: %s",r.status),r.annotations.push({type:"_currents:rule:quarantine",description:JSON.stringify(a)}),r.status="skipped",r.skip(!0,`Quarantining due to matched Currents.dev action: ${i.name}`)}})}},uo=async t=>{try{let e=await eo(t);return new wt(e.rules)}catch(e){return je("Failed to fetch project actions: %o",(0,ao.isAxiosError)(e)?e.toJSON():e),d("Failed to fetch project actions"),new wt([])}};o();o();j();E();T();o();var co=require("c12");function lo(t){return(0,co.loadConfig)({name:"currents",configFile:t})}o();T();function po(t=()=>!1){let e=Date.now(),r=Ra();for(;!t();)if(Date.now()-e>r)throw y(`Could not load Currents config after ${r}ms, exiting...`),new Error("Could not load Currents config")}function Ra(t=5e3){let e=Number(process.env.CURRENTS_CONFIG_LOAD_TIMEOUT_MS);return isNaN(e)||e<1?t:e}var go=l.extend("config-loader"),Re=class{constructor(e,r=i=>{},n=()=>{process.exit(1)},s={validationFn:Kt}){this.reporterOptions=e;this.onSuccess=r;this.onFailure=n;this.options=s;this._configLoaded=!1;this._promise=null}start(){return this._promise=lo(Ce().pwcConfigPath).then(async e=>{this.onSuccess(e),mn(this.reporterOptions,e.config,{validationFn:this.options.validationFn})}).catch(e=>{y("Could not load currents configuration: %O",e),this.onFailure()}).finally(()=>{this._configLoaded=!0}),this}waitSync(){return go("Waiting to load config..."),po(()=>this._configLoaded),this}load(){return this._promise||(go("Starting config loader"),this.start()),this._promise}};o();function Te(t){return t!=null}o();var mo=g(require("fs"));E();var br=l.extend("fixture:worker-config:run-if-no-marker");async function fo(t){let e=Ir(Me.FIXTURES_CONFIG_ERR_FILE);if(br("Checking if error marker exists",e),mo.default.existsSync(e))return br("Error file exists, skipping config loader"),!1;try{return await t(),!0}catch(r){return Ds(e,r),br("Failed to load config",r),!1}}async function ho(t){let e=[],r=await fo(async()=>{await $.upsertState("fixtureConfigLoader",new Re(t,()=>{},()=>{},{validationFn:n=>e=Ta(n)})).load()});return{missingKeys:e,loaded:r}}function Ta(t){return["projectId","recordKey"].map(e=>t[e]?null:e).filter(Te)}var Eo=l.extend("fixture:worker-config"),vr=async function({config:t,use:e,workerInfo:r,chainedFixture:n=null}){try{let{missingKeys:i,loaded:a}=await ho(t);if(!a){Ie("fixture:worker-config:not-loaded",["Failed to load Currents config"]),await e(n);return}if(i.length>0){Ie(oe(`missing_config_keys_${i.join("-")}`),i.map(c=>`Missing Currents configuration: "${c}". Currents Fixtures may not work as expected.`)),await e(n);return}}catch(i){Eo("Failed to load config",i),Ie(oe("fixture:worker-config:exception"),["Error loading Currents configuration. Currents Fixtures may not work as expected."]),await e(n);return}let s=P();s&&await $.populateState("projectRules",uo(s.projectId)),await e(n||s)},Co=async({currentsConfigOptions:t,currentsFixturesEnabled:e},r,n)=>{if(!e)return Eo("Currents fixtures are disabled, skipping config fixture"),await r(null);await vr({config:t,use:r,workerInfo:n})};var Io={currentsFixturesEnabled:[!0,{scope:"worker",option:!0}],currentsConfigOptions:[{},{scope:"worker",option:!0}],gitInfo:[zs,{scope:"worker",title:"Currents Git Info"}],currentsConfig:[Co,{scope:"worker",auto:!0,title:"Currents Configuration"}]},Ro={currentsActions:[Xs,{auto:!0,scope:"test",title:"Currents Actions"}]},To={context:[$s,{scope:"test",title:"Currents Coverage"}]};o();o();var di=g(require("fs")),Bt=require("ts-pattern");o();var Pt=require("lodash"),Ao=g(require("p-queue")),wo=g(require("path")),ie=require("ts-pattern"),Or=require("util");E();T();gr();o();ne();function _o(t,e){return U({method:"POST",url:`/artifacts/test-record/${t}`,data:{...e,_t:Date.now()}}).then(r=>r.data)}function yo(t,e){return U({method:"POST",url:`/artifacts/instance/${t}`,data:{...e,_t:Date.now()}}).then(r=>r.data)}var L=l.extend("artifact"),Ur=l.extend("upload-queue"),V=new Ao.default({concurrency:20}),_a=0,ya=0;V.on("active",()=>{Ur(`Working on item #${++_a}.  Size: ${V.size}  Pending: ${V.pending}`)});V.on("add",()=>{Ur(`Added item #${++ya}.  Size: ${V.size}  Pending: ${V.pending}`)});var Nr=class{constructor(e,r,n,s,i,a){this.testLabel=e;this.testId=r;this.attemptId=n;this.groupId=s;this.artifactId=i;this.artifact=a;this.recordId=null;this.instanceId=null;this.runId=null;this.machineId=null;this.uploadPromise=Promise.resolve();this.uploadedAt=null;this.uploadStartedAt=null;this.createdAt=new Date}startUpload(){let e=async()=>{try{if(!this.recordId)throw new Error("recordId must be set before uploading");if(!this.instanceId)throw new Error("instanceId must be set before uploading");if(!this.runId)throw new Error("runId must be set before uploading");if(!this.machineId)throw new Error("machineId must be set before uploading");L("Creating artifact %o",this.getDebugInfo());let r=await _o(this.recordId,{createdAt:this.createdAt,type:this.artifact.type,name:this.artifact.name,filename:this.artifact.filename,runId:this.runId,groupId:this.groupId,instanceId:this.instanceId,machineId:this.machineId,testId:this.testId,artifactId:this.artifactId,attemptId:this.attemptId,contentType:this.artifact.contentType,metadata:this.artifact.metadata});if(!r?.uploadUrl){d("Could not get upload instructions for test record artifact %s",this.artifact.path??this.artifact.name);return}this.uploadedAt=new Date,await Po(this.artifact,r.uploadUrl),L("Upload completed for test record artifact: %o",this.getDebugInfo())}catch(r){L("Error creating artifact: %o",r,this.getDebugInfo()),d("Could not get upload instructions for test record artifact %s",this.artifact.path??this.artifact.name)}};return this.uploadPromise=V.add(e),this}setRecordId(e,r,n,s){if(this.recordId){L("Record id already set for artifact: %o",this.getDebugInfo());return}L("Starting test record artifact upload: %o",this.getDebugInfo()),this.recordId=e,this.instanceId=r,this.runId=n,this.machineId=s,this.startUpload()}getDebugInfo(){return{testLabel:this.testLabel,recordId:this.recordId,attemptId:this.attemptId,attachment:this.artifact.path??this.artifact.name}}},Lr=class{constructor(e,r,n,s){this.instanceId=e;this.groupId=r;this.runId=n;this.artifact=s;this.uploadPromise=Promise.resolve()}startUpload(){let e=async()=>{try{L("Creating instance artifact %o",this.getDebugInfo());let r=await yo(this.instanceId,{name:this.artifact.name,runId:this.runId,groupId:this.groupId,type:this.artifact.type,contentType:this.artifact.contentType,metadata:this.artifact.metadata});if(!r?.uploadUrl){d("Could not get upload instructions for instance %s artifact %s",this.instanceId,this.artifact.path??this.artifact.name);return}await Po(this.artifact,r.uploadUrl),L("Upload completed for instance artifact: %o",this.getDebugInfo())}catch(r){L("Error creating artifact: %o",r,this.getDebugInfo()),d("Could not get upload instructions for instance artifact %s",this.artifact.path??this.artifact.name)}};return this.uploadPromise=V.add(e),this}getDebugInfo(){return{instanceId:this.instanceId,attachment:this.artifact.path??this.artifact.name}}},b=class{static{this.uploads=new Map}static{this.ids=new Map}static{this.uploadWarnings=new Set}static createOnceForAttempt(e){return e.attachment.forEach((r,n)=>{this._createOnceForAttempt({...e,attachmentIndex:n},r)}),this}static createOnceForInstance(e){return e.artifact.forEach((r,n)=>{let s=this.getArtifactId({testId:`${e.instanceId}-${e.type}`,attemptId:0,attachment:r,attachmentIndex:n});if(this.uploads.has(s)){L("Instance artifact uploader already exists for %o",{instanceId:e.instanceId,attachment:r.path??r.name});return}let i=new Lr(e.instanceId,e.groupId,e.runId,r).startUpload();L("Creating instance artifact uploader %o",{instanceId:e.instanceId,attachment:r.path??r.name}),this.uploads.set(s,i)}),this}static setRecordId(e,r,n,s,i){this.ids.has(e)||(L("Triggering pending uploads for test record %s",r),this.ids.set(e,{recordId:r,instanceId:n,runId:s,machineId:i}),this.uploads.forEach(a=>{"testId"in a&&a.testId===e&&a.setRecordId(r,n,s,i)}))}static getAllUploads(){return Array.from(this.uploads.values()).map(e=>e.uploadPromise)}static dumpUploads(){let e=[],r=[];this.uploads.forEach(n=>{n.recordId&&e.push({recordId:n.recordId,testLabel:n.testLabel,testId:n.testId,attemptId:n.attemptId,name:n.artifact.name,uploadedAt:n.uploadedAt,promise:n.uploadPromise}),n.instanceId&&r.push({instanceId:n.instanceId,name:n.artifact.name,promise:n.uploadPromise})}),Ur("Queue size:",V.size),console.table((0,Pt.orderBy)(e,"recordId")),console.table(r)}static getArtifactId(e){let r=e.attachmentIndex??e.attachment.path??e.attachment.name,n=oe(Buffer.from(`${e.testId}-${e.attemptId}-${r}`));return L("Artifact id %s for %o",n,{testId:e.testId,attemptId:e.attemptId,attachmentIndex:e.attachmentIndex,path:e.attachment.path,name:e.attachment.name}),n}static _createOnceForAttempt(e,r){let{testLabel:n,testId:s,attemptId:i,groupId:a}=e,c=r.path??r.name,p=this.getArtifactId({testId:s,attemptId:i,attachment:r,attachmentIndex:e.attachmentIndex??0});if(this.uploads.has(p))return L("Artifact uploader already exists for %o",{testLabel:n,key:p,attachmentLabel:c,attemptId:i}),this;let h=new Nr(n,s,i,a,p,{...r,name:r.name,type:wa(r),filename:Pa(r)});L("Creating artifact uploader %o",{key:p,testLabel:n,attachmentLabel:c}),this.uploads.set(p,h);let I=this.ids.get(s);return I&&h.setRecordId(I.recordId,I.instanceId,I.runId,I.machineId),this}};async function Po(t,e){try{await(0,ie.match)(t).with({path:ie.P.string},r=>ct({name:r.name,path:r.path,uploadUrl:e,contentType:t.contentType},t.contentType,So(r.path))).with({body:ie.P.not(ie.P.nullish)},r=>pr({name:r.name,buffer:r.body,uploadUrl:e,contentType:t.contentType},t.contentType,So(r.name??"buffer"))).otherwise(()=>{let r=(0,Or.format)("Unknown attachment type: %o",t);d(r),b.uploadWarnings.add(r)})}catch(r){let n=(0,Or.format)("Upload failed: %o",Sa(r));b.uploadWarnings.add(n),d(n)}}var So=t=>({total:e,loaded:r})=>{};function xo(t){return t/1e3/1e3}function Sa(t){return(0,Pt.pick)(t,"message","code","method","url")}function xa(t){return t.subarray(0,8).toString("hex").toUpperCase()}function Aa(t){return Object.values({jpeg:"FFD8FF",png:"89504E470D0A1A0A",gif87a:"474946383761",gif89a:"474946383961",bmp:"424D",tiffLE:"49492A00",tiffBE:"4D4D002A"}).some(r=>t.startsWith(r))}function wa(t){return(0,ie.match)(t).when(({contentType:e,body:r})=>{if(e.startsWith("image"))return!0;if(r&&e==="application/octet-stream"){let n=xa(r);return Aa(n)}return!1},()=>"screenshot").when(({contentType:e})=>e.startsWith("video"),()=>"video").when(({name:e,path:r,contentType:n})=>n==="application/zip"&&e==="trace"&&!!r,()=>"trace").when(({name:e,path:r,contentType:n})=>n==="application/json"&&e==="coverage"&&!!r,()=>"coverage").otherwise(()=>"attachment")}function Pa(t){return t.path&&wo.default.basename(t.path)}Yt();E();o();var bo=require("@babel/code-frame"),bt=g(require("chalk")),Fr=g(require("fs")),_e=g(require("path")),vo=g(require("stack-utils")),Oo=g(require("url"));function Dr(t,e){return t.replace(/^(?=.+$)/gm,e)}function ba(t){let e=t.split(`
`),r=e.findIndex(a=>a.startsWith("    at "));r===-1&&(r=e.length);let n=e.slice(0,r).join(`
`),s=e.slice(r),i;for(let a of s){let{frame:c,fileName:p}=La(a);if(!(!c||!p)&&!va(p)){i={file:p,column:c.column||0,line:c.line||0};break}}return{message:n,stackLines:s,location:i}}function va(t){return t.includes(`${_e.default.sep}node_modules${_e.default.sep}`)}function Oa(t,e){return _e.default.relative(t.rootDir,e)||_e.default.basename(e)}function Mr(t,e,r,n){let s=e.stack,i=[],a;if(s){let c=ba(s);if(i.push(c.message),a=c.location,a)if(!e.snippet&&(!n||Fr.default.realpathSync(n)!==a.file)&&(i.push(""),i.push(bt.default.gray("   at ")+`${Oa(t,a.file)}:${a.line}`)),i.push(""),e.snippet)i.push(e.snippet);else try{let p=Fr.default.readFileSync(a.file,"utf8"),h=(0,bo.codeFrameColumns)(p,{start:a},{highlightCode:r});i.push(h)}catch{}i.push(""),i.push(c.stackLines.join(`
`))}else e.message?i.push(e.message):e.value&&i.push(e.value);return{location:a,message:i.join(`
`)}}var Na=new vo.default;function La(t){let e=Na.parseLine(t);if(!e)return{frame:null,fileName:null};let r=null;return e.file&&(r=e.file.startsWith("file://")?Oo.default.fileURLToPath(e.file):_e.default.resolve(process.cwd(),e.file)),{frame:e,fileName:r}}function No(t,e,r,n,s){let i=[];r.status==="passed"&&e.expectedStatus==="failed"&&i.push({message:Dr(bt.default.red("Expected to fail, but passed."),n)}),r.status==="interrupted"&&i.push({message:Dr(bt.default.red("Test was interrupted."),n)});for(let a of r.errors){let c=Mr(t,a,s,e.location.file);i.push({message:Dr(c.message,n),location:c.location})}return i}cr();jt();Zt();T();Ke();o();var ko=g(require("fs"));E();T();o();o();var Uo=g(require("ws"));E();var Lo=l.extend("ws"),ye=null;function Do(t){ye&&ye.send(JSON.stringify(t))}function Fo(){ye&&ye.close()}async function Mo(t){Lo("setting port to %s",t),await new Promise(e=>{ye=new Uo.default(`ws://localhost:${t}`),ye.on("open",()=>{Lo("ws opened"),e(null)})})}o();var Ua=g(require("http"));E();var Da=g(require("lil-http-terminator")),Bo=require("ts-pattern"),Fa=g(require("ws")),rd=l.extend("wss");var Ma=l.extend("output");async function jo(t){let e=" ".repeat(t.options?.ident??2);w(`${e}\u{1F4BE} JSON output file: ${m(t.outputFile)}`);try{ko.default.writeFileSync(t.outputFile,JSON.stringify(t.summary,null,2))}catch(r){y("Error writing JSON summary",r.message)}}async function $o(t){let e=parseInt(process.env.CURRENTS_PWCP_WSS_PORT),r=!!process.env.CURRENTS_OR8N_SEND_RESULTS_TO_WSS;if(!e||!r){Ma("Skipping sending JSON summary to WSS: %o",{port:e,shouldSendToWSS:r});return}await Mo(e),await Do({type:"execution:summary",payload:await t.executionState.getSummary()}),await Fo()}Er();o();var J=require("lodash"),Yr=g(require("pluralize"));j();E();o();o();o();var Ba=new RegExp("([\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~])))","g");function Go(t){return t.replace(Ba,"")}o();E();o();E();o();o();E();ne();var vt=class{static create(e){return l("Creating instance: %o",e),U({method:"POST",url:`runs/${e.runId}/pw/instances/v1`,data:e}).then(r=>r.data)}};o();E();Ke();var Br=l.extend("instance"),kr=class{constructor(e,r,n){this.projectId=e;this.specName=r;this.tests=n;this.claimedCount=0;this.instanceId=null;this.creationRequest=null}async startCreationOnce({run:e,startTime:r,worker:n}){return this.creationRequest?this.creationRequest:(this.creationRequest=e.then(s=>s?vt.create({runId:s.runId,groupId:s.groupId,machineId:s.machineId,spec:this.specName,worker:n,startTime:r}).then(({instanceId:i,claimedCount:a})=>(Br("Create instance response: %o",{worker:n,projectId:this.projectId,specName:this.specName,instanceId:i,claimedCount:a}),this.instanceId=i,this.claimedCount=a,{instanceId:i,claimedCount:a})).catch(i=>(ee.push("Failed to create instance for project %s, spec file %s: %s",this.projectId,this.specName,i),null)):(Br("Missing run to create instance [%s] > %s",this.projectId,this.specName),null)),this.creationRequest)}},$e=class t{static{this.instanceCreations=new Map}static get(e,r){return t.instanceCreations.get(t.getKey(e,r))}static createOnce(e,r,n){let s=t.getKey(e,r),i=t.instanceCreations.get(s);if(i)return Br("Instance creation already started: %s %s",e,r),i;let a=new kr(e,r,n);return t.instanceCreations.set(s,a),a}static getKey(e,r){return`${e}::${r}`}};T();T();o();var q=require("lodash"),$r=g(require("path")),Ot=g(require("pluralize")),Nt=g(require("pretty-ms")),Gr=require("process"),He=require("ts-pattern");j();zt();$t();T();o();var Ho=require("lodash"),Wo=require("ts-pattern");function ka(t){if(!t.results?.length)return"skipped";let e=t.results.map(r=>r.status);return e.every(r=>r===e[0])?(0,Wo.match)(e[0]).with("skipped",()=>"skipped").with("passed",()=>t.expectedStatus==="passed"?"passed":"failed").with("failed",()=>t.expectedStatus==="failed"?"passed":"failed").otherwise(()=>"failed"):t.results.some(r=>r.status==="passed")&&t.expectedStatus==="passed"||t.results.some(r=>r.status==="failed")&&t.expectedStatus==="failed"?"passed":t.results.some(r=>r.status==="skipped")&&t.expectedStatus==="skipped"?"skipped":"failed"}function jr(t){switch(t){case"timedOut":return"failed";case"interrupted":return"failed";case"skipped":return"pending";default:return t}}var ae=(0,Ho.flowRight)(jr,ka);var ue=class t{constructor(e,r,n,s=P(),i){this.pwConfig=e;this.suite=r;this.executionState=n;this.currentsConfig=s;this.ciBuildId=i;this.loggerChain=Promise.resolve(null);this.runUrl=null;this.runId=null;this.flakySymbol="flaky"}static{this.globalOutput=new Map}static mergeOutputMaps(...e){let r=new Map;e.forEach(s=>{s.forEach((i,a)=>{r.set(a,i)})});let n=[];return Array.from(r.keys()).sort().forEach(s=>n.push(...r.get(s))),n}getIntro(){return[`\u{1F4E6} Currents reporter: ${m([`${K(Qe)}`,`recording to project ${this.currentsConfig?.projectId}`].join(" "))}`,`\u{1F3AD} Playwright: ${m([`${K(this.pwConfig.version)}`,`${this.suite.allTests().length} ${(0,Ot.default)("test",this.suite.allTests().length)} in ${this.suite.suites.length} ${(0,Ot.default)("project",this.suite.suites.length)} [${this.suite.suites.map(e=>W(e.project())).join(", ")}]`,this.pwConfig.shard?["shard",`${this.pwConfig.shard.current}/${this.pwConfig.shard.total}`].join(" "):null].filter(e=>e).join(" "))} `,this.ciBuildId.value?"\u{1F528} CI Build ID: "+[`${K.dim(this.ciBuildId.value)}`,this.ciBuildId.source==="random"?[m("was auto-generated,"),m("learn more at"),rn(Je.guide.ciBuildId)].join(" "):null].filter(Boolean).join(" "):null].filter(e=>e).join(`
`)}onTestBegin(e){let r=this.executionState.getTestExecution(e),n=`${this.now()} ${K(`starting test attempt #${e.results.length}`)}: ${this.getTestCaseLabel(e)}`;r?.appendOutput([n]),this.logAfterRunCreated(n)}async onTestEnd(e,r){let n=Gr.hrtime.bigint(),s=this.executionState.getTestExecution(e);return this.getTestEndLines(e,r).then(i=>{s?.appendOutput(i,n),this.logAfterRunCreated(i.join(`
`))})}async getTestEndLines(e,r){let n=`finished test attempt #${r.retry+1}`,s=this.executionState.getTestExecution(e),i=await this.executionState.getDashboardUrl(),a=i?await s?.getTestLink(i):null;return[`${this.now()} ${K(`${n}`)}: ${this.getTestCaseLabel(e)}`,[a?["  Recording URL:",m(a)].join(" "):null,["  Expected result:",m(e.expectedStatus)].join(" "),e.results.map((p,h)=>[`    - attempt ${h+1}/${e.retries+1}:`,m(p.status),m(`${(0,Nt.default)(p.duration)}`)].join(" ")).join(`
`)].filter(Boolean).join(`
`),e.results.length===0?m("    - No attempts"):null,r.retry>e.retries?m("    \u2139\uFE0F  Note: retries can exceed max attempts when serial mode is enabled"):null,s?.isFinished()?["  Test result:",this.getStatusLabel(s.currentsState),...s?.isFlaky?[De(this.flakySymbol)]:[]].join(" "):m("    - waiting for additional attempts to determine test result..."),...this.getInlineErrorsBlock(e,r),"",fe(),""].filter(p=>p!==null)}onStdOut(...e){this.onOutput("stdout",...e)}onStdErr(...e){this.onOutput("stderr",...e)}onOutput(e,r,n,s){let a=[this.getStdIdentifier(e,n,s),(r??"<empty>").toString()].join(`
`);n?this.executionState.getTestExecution(n)?.appendOutput([a]):t.globalOutput.set(Gr.hrtime.bigint(),[a]),this.logAfterRunCreated(a)}getStdIdentifier(e,r,n){let s=[this.now(),K(`${e} from:`)];return r?s.push(this.getTestCaseLabel(r)):s.push("global output - no tests associated"),n&&s.push(`- attempt #${n.retry+1}`),s.join(" ")}getInlineErrorsBlock(e,r){if(this.executionState.getTestExecution(e)?.isFlaky||ae(e)==="failed"){let s=e.results.filter(i=>i.error);if(s.length)return s.flatMap(i=>["",`  ${en(`attempt ${i.retry+1} error`)}`,...this.getTestResultError(e,i),`  ${tn(`attempt ${i.retry+1} error`)}`,""])}return[]}async onEnd(e){await this.printSummary(e,this.executionState.getAllTestExecutions())}farewell(e,r){let n=[];n.push(`  Elapsed time: ${m((0,Nt.default)(Date.now()-e.getTime()))}`,`  Artifacts created: ${m(r)}`),this.runUrl&&!Y()&&n.push(`  \u{1F310} Run URL: ${m(this.runUrl)}`),this.logAfterRunCreated(n.join(`
`))}chainRunCreation(){Object.values(this.executionState.projectExecutions).length&&(this.loggerChain=this.loggerChain.then(()=>Promise.allSettled([this.executionState.getRunUrl(),this.executionState.getRunId(),this.executionState.getCiBuildId()])).then(([r,n,s])=>{this.runUrl=r.status==="fulfilled"?r.value:null,this.runId=n.status==="fulfilled"?n.value:null;let i=s.status==="fulfilled"?s.value:null;this.runUrl?(i&&this.ciBuildId.source==="server"&&w("\u{1F528} CI Build ID: %s %s",K.dim(i),m("auto-detected")),w("\u{1F310} Run URL: %s",m(this.runUrl)),me()):d("Failed to create run recording")}))}now(){return m(new Date().toISOString())}getStatusLabel(e){let r=this.getColor(e),n=(0,He.match)(e).when(s=>s==="passed",()=>"passed").when(s=>s==="failed",()=>"failed").when(s=>s==="skipped",()=>"failed").when(s=>s==="pending",()=>"skipped").otherwise(()=>"unknown");return r(n)}getColor(e){return(0,He.match)(e).when(r=>r==="passed",()=>Le).when(r=>r==="failed",()=>he).when(r=>r==="skipped",()=>he).when(r=>r==="pending",()=>Ue).otherwise(()=>q.identity)}getTestCaseLabel(e,r=!0){let n=Et(e).location.file;return[r?`[${Q(e)}]`:null,e.location.file!==n?this.relativeFilePath(this.pwConfig,n):null,this.getTestCaseFile(e),A(e).join(" \u203A ")].filter(s=>s).join(" \u203A ")}getTestCaseFile(e,r=!0){let n=this.relativeTestPath(this.pwConfig,e);return e.location&&r?`${n}:${e.location.line}:${e.location.column}`:n}relativeTestPath(e,r){return this.relativeFilePath(e,r.location.file)}relativeFilePath(e,r){return $r.default.relative(e.rootDir,r)||$r.default.basename(r)}getTestResultError(e,r){return No(this.pwConfig,e,r,"  ",!0).map(n=>`
`+n.message+`
`)}getBriefAttachments(e){let r=e.results.flatMap(s=>({attempt:s.retry,attachments:s.attachments}));if(!r.flatMap(s=>s.attachments).length)return[];let n=["  Attachments:"];return(0,q.orderBy)(r,"attempt").forEach(({attachments:s,attempt:i})=>{if(n.push(`    - attempt #${i+1}`),!s.length){n.push(m("       - no attachments"));return}let a=(0,q.groupBy)(s,c=>this.getAttachmentType(c));n.push(`       ${s.length} ${(0,Ot.default)("attachment",s.length)}: ${Object.entries(a).map(([c,p])=>`${p.length} ${c}`)}`)}),n}getAttachmentType(e){return(0,He.match)(e.contentType).when(r=>r.startsWith("text/"),()=>"text").when(r=>r.startsWith("image/"),()=>"image").when(r=>r.startsWith("video/"),()=>"video").when(r=>r.startsWith("application/")&&e.name?.endsWith(".json"),()=>"json").when(r=>r.startsWith("application/")&&e.name.startsWith("trace"),()=>"trace").otherwise(()=>"unknown")}getAttachmentDetails(e){return(0,He.match)(e.contentType).when(r=>r.startsWith("text/"),()=>`Text ${e.contentType}:
${this.getAttachmentText(e)}`).when(r=>r.startsWith("image/"),()=>`Image (${e.contentType}): ${e.name??""} ${m(e.path??"<Buffer>")}`).when(r=>r.startsWith("video/"),()=>`Video (${e.contentType}): ${e.name??""} ${m(e.path??"<Buffer>")}`).when(r=>r.startsWith("application/")&&e.name?.endsWith(".json"),()=>`JSON file (${e.contentType}): ${e.name??""} ${m(e.path??"<Buffer>")}`).when(r=>r.startsWith("application/")&&e.name.startsWith("trace"),()=>`Trace: ${m(e.path??"<Buffer>")}`).otherwise(()=>`Attachment (${e.contentType}): ${e.name??""} ${e.path??"<Buffer>"}`)}getAttachmentText(e){if(!e.body)return;let r=e.body.toString();return r.length>300&&(r=r.slice(0,300)+"... <truncated>"),r}logAfterRunCreated(...e){this.loggerChain.then(()=>{w(...e)})}async getSummary(e,r={showLinks:!0}){let s=e.filter(v=>v.isFlaky).length,i=e.filter(v=>v.currentsState==="failed"),a=e.filter(v=>v.currentsState==="pending"),c=e.filter(v=>v.currentsState==="passed"),p=c.filter(v=>v.isFlaky),h=i.filter(v=>v.isFlaky),I=a.filter(v=>v.isFlaky),C=e.filter(v=>v.testCase.results.length===0),R=[];C.length>0&&R.push("",te(`${Z(4)}${C.length} did not run:`),...C.map(v=>`${Z(4)}${this.getTestCaseLabel(v.testCase)}`));let G=[];this.pwConfig.maxFailures&&i.length<this.pwConfig.maxFailures&&G.push(te(`${Z(4)}Testing stopped early after ${this.pwConfig.maxFailures} maximum allowed failures`));let we=[];i.length>0&&we.push([`${Z(4)}${he(`${i.length} failed`)}`,h.length>0?`${te(`(${h.length} flaky)`)}`:null].filter(Boolean).join(" "),...i.length>0?await this.testTree(i,he,{flatten:!0,showLinks:r.showLinks}):[]);let Pe=[];c.length>0&&Pe.push([p.length>0?`${Z(4)}${Le(`${c.length} passed`)} ${te(`(${p.length} flaky)`)}`:null].filter(Boolean).join(" "),...p.length>0?await this.testTree(p,Le,{flatten:!0,showLinks:r.showLinks}):[]);let be=[];return I.length>0&&be.push([`${Z(4)}${Ue(`${a.length} skipped`)} ${te(`(${I.length} flaky)`)}`].join(" "),...I.length>0?await this.testTree(I,Ue,{flatten:!0,showLinks:r.showLinks}):[]),[[`${Z(2)}Test results:`,[Ge(e.length,`${`${e.length} overall`}`),Ge(c.length,`${Le(`${c.length} passed`)}`),Ge(a.length,`${Ue(`${a.length} skipped`)}`),Ge(i.length,`${he(`${i.length} failed`)}`),Ge(s,`${te(`${s} flaky`)}`)].join(", ")].join(" "),...we,...Pe,...be,...R,...G].filter(Boolean).join(`
`)}async printSummary(e,r){this.logAfterRunCreated(await this.getSummary(r))}async testTree(e,r=q.identity,n={flatten:!1,showLinks:!0}){let s=(0,q.groupBy)(e,a=>a.projectId),i=[];return await Promise.allSettled(Object.entries(s).map(async([a,c])=>{let p=[],h=(0,q.groupBy)(c,C=>B(C.testCase,this.pwConfig)),I=!1;await Promise.allSettled(Object.entries(h).map(async([C,R])=>{if(!R.length)return;let G=await this.executionState.getDashboardUrl();if(!G)return;let we=await R[0].getInstanceLink(G);!I&&!n.flatten&&(p.push(r(`  [${a}]`)),I=!0);let Pe=!1;await Promise.allSettled(R.map(async be=>{let zr=await be.getTestLink(G);!Pe&&!n.flatten&&(p.push([r(`    ${C}`),we&&n.showLinks?`${m(we)}`:""].join(" ")),Pe=!0),p.push(this.testExecutionSummaryLine(be,zr,r,{ident:n.flatten?6:8,showProject:n.flatten,showLinks:n.showLinks}))}))})),i.push(...p)})),i}testExecutionSummaryLine(e,r,n=w,s={ident:2,showProject:!0,showLinks:!0}){let i=e.isFlaky?De.dim(this.flakySymbol):null;return[Z(s.ident),[i,n(this.getTestCaseLabel(e.testCase,s.showProject)),...r&&s.showLinks?[m(r)]:[],m((0,Nt.default)(e.duration))].filter(a=>a!==null).join(" ")].join("")}};function Z(t=0){return" ".repeat(t)}function Ge(t,e){return t>0?e:m(e)}o();o();j();T();o();var Lt=g(require("path"));async function Vo({config:t,groupId:e,testId:r,titlePath:n}){let s=e.length>0?e:"project",i=Lt.default.resolve(t.dir??".nyc_output",s),a=H({target:{titlePath:n,projectId:e,testId:r},stage:"spec_reports_finding"}),c=await dt(i);if(!c)return a({event:"find",status:"failed",message:"Coverage directory not found",details:{dir:i}}),null;if(c.length===0)return a({event:"find",status:"failed",message:"No coverage files found",details:{dir:i,files:c}}),[];let p=c.filter(I=>I.startsWith(r)&&Lt.default.extname(I)===".json"),h=p.map(I=>Lt.default.join(i,I));return c.length===0?(a({event:"find",status:"failed",message:"No coverage files found. No files match the testId",details:{dir:i,testId:r,filteredFiles:p}}),[]):(a({event:"find",status:"passed",message:"Coverage files found",details:{dir:i,filteredFilePaths:h,files:h.length}}),h)}async function qo({runId:t,groupId:e,instanceId:r,specName:n,testExecutions:s}){try{let i=P();if(!(i?.coverage?ze([e],i.coverage):[]).length)return;let c=H({target:{spec:n,projectId:e},stage:"spec_reports_finding"}),p=await Promise.all(s.map(R=>Vo({config:i.coverage,groupId:e,testId:R.testId,titlePath:R.titlePath}))).then(R=>R.flat().filter(G=>G));if(p.length===0){c({event:"find",status:"failed",message:"No coverage paths found for spec",details:{testExecutions:s.map(R=>R.testId),total:s.length,coveragePaths:p}});return}c({event:"find",status:"passed",message:"Coverage paths found for spec",details:{testExecutions:s.map(R=>R.testId),total:s.length,coveragePaths:p,found:p.length}});let h=H({target:{spec:n,projectId:e},stage:"spec_test_merging"}),I=await mt(p,h),C=H({target:{spec:n,projectId:e},stage:"spec_reporting"});if(!I){C({event:"report",status:"failed",message:"No coverage data found for spec",details:{coveragePaths:p,files:p.length}});return}b.createOnceForInstance({instanceId:r,groupId:e,runId:t,artifact:[{name:"coverage",body:Buffer.from(JSON.stringify(I)),contentType:"application/json",type:"coverage"}],type:"coverage"}),C({event:"report",status:"passed",message:"Coverage artifact created",details:{coveragePaths:p,files:p.length}})}catch(i){y(`Error sending coverage for spec: ${n}, groupId: ${e}`,i);return}}o();var Jo=require("lodash"),Ko=require("process");E();var ja=l.extend("testExecution"),Se=class t{constructor(e,r,n,s){this.specExecution=e;this.projectId=n;this.specName=s;this.output=new Map;this._testCase=r}get duration(){return this._testCase.results.reduce((e,r)=>e+r.duration,0)}get isFlaky(){return this._testCase.outcome()==="flaky"}get testCase(){return this._testCase}get titlePath(){return`${this.testCase.titlePath().filter(Boolean).join(" > ")}`}get currentsState(){return ae(this.testCase)}get testId(){return this.testCase.id}get getOutput(){return this.output}appendOutput(e,r){this.output.set(r??Ko.hrtime.bigint(),e)}isInterruptedWithError(){return!(!this.testCase.results.some(e=>e.status==="interrupted")||!this.testCase.results.some(e=>!!e.error))}isFinished(){let e=this.testCase.results.map(r=>r.status);return ja("isFinished?: %o",{title:this.titlePath,allStatuses:e,retries:this.testCase.retries}),!!(e.includes(this.testCase.expectedStatus)||e.length===this.testCase.retries+1)}setTestCase(e){return this._testCase=e,this}getFakeTestCase(){let e=(0,Jo.extend)(this.testCase),r=this.testCase.retries+1-e.results.length;return Array.from({length:r}).forEach(()=>{e.results.push(t.getFakeTestResult(e.results.length+1))}),e}async getInstanceLink(e){let r=(await this.specExecution.instance?.creationRequest)?.instanceId;return r?`${e}/i/${r}`:null}async getTestLink(e){let r=(await this.specExecution.instance?.creationRequest)?.instanceId;return r?`${e}/i/${r}/test/${this.testId}`:null}static getFakeTestResult(e){return{__currents_isFake:!0,status:"skipped",workerIndex:-1,parallelIndex:0,duration:0,startTime:new Date,stdout:["Playwright did not run this test attempt because of maximum allowed failures, or SIGINT"],stderr:["Playwright did not run this test attempt because of maximum allowed failures, or SIGINT"],attachments:[],steps:[],error:{message:"Playwright did not run this test attempt because of maximum allowed failures, or SIGINT",stack:""},errors:[],retry:e}}};var Yo=l.extend("specExecution"),Ut=class{constructor(e,r,n,s,i){this.projectExecution=e;this.specName=r;this.projectId=n;this.tests=s;this.printer=i;this.testExecutions=new Map;this.instance=null;this.instanceFinishedTask=null}createTestExecution(e,r,n){this.testExecutions.set(e,new Se(this,r,this.projectId,this.specName))}getTestExecution(e){return this.testExecutions.get(e)}getAllTestExecutions(){return Array.from(this.testExecutions.values())}isFinished(){return this.getAllTestExecutions().every(e=>e.isFinished())}isFailed(){return this.getAllTestExecutions().map(e=>e.currentsState).some(e=>e==="failed")}getInstanceCreation(){return $e.get(this.projectId,this.specName)?.creationRequest}startInstanceCreation(e){return this.instance=$e.createOnce(this.projectId,this.specName,this.tests),this.instance.startCreationOnce(e)}finish(e){this.isFinished()&&(this.instanceFinishedTask=this._startInstanceFinishedTask(e))}async _startInstanceFinishedTask(e){let r=await this.projectExecution.run;if(!r)return;Yo("Starting instance finished task: %o",{ciBuildId:r.ciBuildId,projectId:this.projectId,specName:this.specName});let n=await this.getInstanceCreation();if(!n?.instanceId){d("[currents] Missing reporting instructions for spec file, skipping: [%s] \u203A %s",this.projectId,this.specName);return}if(n?.claimedCount>1){Yo('[currents] Results already reported for CI build "%s" [%s] \u203A %s',r.ciBuildId,this.projectId,this.specName);return}await this.sendStdOut({instanceId:n.instanceId,groupId:this.projectId,runId:r.runId}),await qo({runId:r.runId,groupId:this.projectId,instanceId:n.instanceId,specName:this.specName,testExecutions:this.getAllTestExecutions()})}async sendStdOut({instanceId:e,groupId:r,runId:n}){let s=this.getAllTestExecutions(),i=s.map(h=>h.getOutput),a=ue.globalOutput,c=ue.mergeOutputMaps(a,...i),p=[this.printer.getIntro(),fe(),c.join(`
`),await this.printer.getSummary(s,{showLinks:!1}),fe()].join(`
`);b.createOnceForInstance({instanceId:e,groupId:r,runId:n,artifact:[{name:"stdout",body:Buffer.from([p].join(`
`)),contentType:"text/plain",type:"stdout"}],type:"stdout"})}};var hm=l.extend("projectExecution"),Dt=class{constructor(e){this.projectId=e;this.specExecutions={};this.run=Promise.resolve(null)}setRun(e){return this.run=e,this}upsertSpecExecution(e,r,n,s){return this.specExecutions[e]||(this.specExecutions[e]=new Ut(this,e,r,n,s)),this.specExecutions[e]}getSpecExecution(e){return this.specExecutions[e]}getAllSpecExecutions(){return Object.values(this.specExecutions)}};var Ft=class{constructor(e){this.config=e;this.projectExecutions={}}upsertProjectExecution(e){return this.projectExecutions[e]||(this.projectExecutions[e]=new Dt(e)),this.projectExecutions[e]}getProjectExecution(e){return this.projectExecutions[e]}getAllProjectExecutions(){return Object.values(this.projectExecutions)}getAllSpecExecutions(){return Object.values(this.projectExecutions).flatMap(e=>e.getAllSpecExecutions())}getAllTestExecutions(){return this.getAllSpecExecutions().flatMap(e=>e.getAllTestExecutions())}getProjectExecutionForTestCase(e){return this.getProjectExecution(Q(e))}getSpecExecution(e){return this.getProjectExecutionForTestCase(e).getSpecExecution(B(e,this.config))}getTestExecution(e){return this.getSpecExecution(e).getTestExecution(D(e))}getAllPendingPromises(){return[...this.getAllSpecExecutions().map(e=>e.instanceFinishedTask).filter(Te)]}getUnfinishedSpecExecutions(){return this.getAllSpecExecutions().filter(e=>!e.isFinished())}async getRun(){let e=this.getAllProjectExecutions();if(e.length)return await e[0].run}async getRunUrl(){return(await this.getRun())?.runUrl}async getRunId(){return(await this.getRun())?.runId}async getDashboardUrl(){return(await this.getRun())?.dashboardUrl}async getCiBuildId(){return(await this.getRun())?.ciBuildId}async getSummary(){let e=this.getAllTestExecutions(),r=await this.getDashboardUrl();return{runId:await this.getRunId()??null,url:await this.getRunUrl()??null,ciBuildId:await this.getCiBuildId()??null,results:{tests:{overall:e.length,flaky:e.filter(n=>n.isFlaky).length,failed:e.filter(n=>n.currentsState==="failed").length,skipped:e.filter(n=>n.currentsState==="pending").length,passed:e.filter(n=>n.currentsState==="passed").length}},details:await Promise.all(e.map(async n=>({projectId:Q(n.testCase),url:r?await n.getTestLink(r):null,specName:n.specName,title:A(n.testCase),status:n.currentsState,isFlaky:n.isFlaky,durationMs:n.duration,attempts:n.testCase.results.map(s=>({attemptIndex:s.retry,status:s.status,errorMessage:s.error?.message?Go(s.error?.message):null}))})))}}};o();tt();T();ot();o();o();var ti=require("lodash");j();E();o();var zo=g(require("getos")),Qo=require("lodash"),k=require("os"),Xo=require("util"),$a=async()=>{if((0,k.platform)()==="linux")try{let t=await(0,Xo.promisify)(zo.default)();return"dist"in t&&"release"in t?[t.dist,t.release].join(" - "):(0,k.release)()}catch{return(0,k.release)()}return(0,k.release)()},Ga=async()=>{let t=await $a();return{osName:(0,k.platform)(),osVersion:t,osCpus:[],osMemory:{free:(0,k.freemem)(),total:(0,k.totalmem)()}}},Zo=(0,Qo.memoize)(Ga);o();ne();function ei(t){return U({method:"POST",url:"runs/v1",data:t}).then(e=>e.data).catch(e=>{if(e.response&&e.response.status===422)return null;throw e})}var Ha={tags:[]};async function ri(t){let e=P();if(!e)return null;let r=await yt(),n=await Zo(),{browser:s}=t,a={...{browserName:s.name,browserVersion:s.version},...n},c={...Ha,platform:a,commit:r,...t,projectId:e.projectId,recordKey:e.recordKey,ciBuildId:t.ci.ciBuildId.value,tags:e.tag??[],machineId:process.env.CURRENTS_MACHINE_ID??e.machineId,orchestrationId:process.env.CURRENTS_ORCHESTRATION_ID??e.orchestrationId,previousCiBuildId:process.env.CURRENTS_PREVIOUS_CI_BUILD_ID,coverage:ze(hn(t.fullTestSuite),e.coverage)};c.config=Cn(c.config),l("Creating run: %o",(0,ti.mapValues)(c,(p,h)=>h==="recordKey"?"******":p));try{let p=await ei(c);return l("Run created: %o",p),p}catch{return null}}o();o();var ni=g(require("debug")),Wr=g(require("fs")),Vr=g(require("tmp")),si=require("ts-pattern");var Hr=(0,ni.default)("pwc-scanner"),Va=(t,e)=>(0,si.match)(t).with("project",()=>e.map(r=>`--project=${r}`)).with("grep",()=>`--grep=${e}`).with("grepInvert",()=>`--grep-invert=${e}`).with("configFile",()=>`--config=${e}`).with("repeatEach",()=>`--repeat-each=${e}`).with("cliArgs",()=>null).with("cliOnlyChanged",()=>`--only-changed=${e}`).exhaustive(),oi=async params=>{let{execa}=await eval('import("execa")'),tmpFile=Vr.default.fileSync({postfix:".json"}),scannerArgs=Object.entries(params).filter(([t,e])=>!!e).map(([t,e])=>Va(t,e)).filter(Te).map(t=>Array.isArray(t)?t:[t]).flat();Hr("scannerArgs: %O",scannerArgs);let cliParams=["test","--list",...scannerArgs,"--reporter=@currents/playwright/discovery","--shard=1/1",...params.cliArgs];Hr("running scanner: %O",cliParams);let execaResult=await execa("playwright",cliParams,{reject:!1,env:{PWTEST_WATCH:void 0,CURRENTS_DISCOVERY_PATH:tmpFile.name}}),fileContents=Wr.default.readFileSync(tmpFile.name,"utf-8");if(Hr("execa result: %o",execaResult),execaResult.failed){let t=Vr.default.fileSync({prefix:"pwc-scanner-error",postfix:".json"});return Wr.default.writeFileSync(t.name,JSON.stringify(execaResult,null,2)),console.error("Error: pwc-scanner failed. Debug: %s",t.name),{execaResult,result:null}}return{execaResult,result:JSON.parse(fileContents)}};j();E();ot();T();o();var ii=g(require("fs")),ai=t=>{try{return JSON.parse(ii.default.readFileSync(t,"utf-8"))}catch(e){console.error("Error reading test suite file",e)}};var xe=l.extend("scanner");async function ci(t,e){try{let r=st("discovery")||{},n=P();if(r.currentsConfig=n,n?.testSuiteFile)return xe("scanner explicit test suite: %o",n.testSuiteFile),ai(n.testSuiteFile);let s=In(t);if(r.internalConfig=s,xe("internal config: %o",s),!s)return null;if(s.testIdMatcher||s.cliLastFailed)return xe("skipping scanning due to testIdMatcher or cliLastFailed being set"),Os(e,t);let i={cliArgs:s.cliArgs,project:s.cliProjectFilter,configFile:t.configFile,grep:ui(s.cliGrep),grepInvert:ui(s.cliGrepInvert),repeatEach:s.configCLIOverrides.repeatEach,cliOnlyChanged:s.cliOnlyChanged};return xe("scanner config: %o",i),r.scannerConfig=i,oi(i).then(a=>(xe("scanner execa result: %o",a.execaResult),xe("scanner result: %O",a.result),r.execaResult=a.execaResult,r.result=a.result,a.result)).catch(a=>(y(a),r.pwcScannerError=a,null))}catch(r){return y(r),null}}function ui(t){return t?(Array.isArray(t)?t:[t]).join(","):null}o();var li=g(require("json-stringify-safe")),We=require("lodash"),pi=g(require("p-debounce"));j();E();ne();o();var qa={length:32,separator:"..."},qr=function(t,e={}){let{length:r,separator:n}={...qa,...e};if(!t)return;if(t.length<=r)return t.trim();let s=n.length,i=r-s,a=Math.ceil(i/2),c=Math.floor(i/2);return t.substring(0,a)+n+t.substring(t.length-c,t.length-1)};T();var Ae=l.extend("trr"),Jr=class t{constructor(e){this.requestSequence=new Kr;this.executionChain=Promise.resolve();this.updateRequestSet=new Set;this.recordId=null;this.instanceId=null;this.currentsConfig=null;this.updateCounter=0;this.attemptTriggerEvent=new Map;this.networkRequests=[];this.updateRemoteTest=(0,pi.default)(this._updateRemoteTest,t.DEBOUNCE_TIME_MS);this.testCase=e.testCase,this.groupId=e.projectId,this.specName=e.specName,this.currentsConfig=P()}static{this.DEBOUNCE_TIME_MS=5e3}static{this.MAX_STEPS_PER_LEVEL=2e3}get execution(){return this.executionChain}onTestBegin(e){this.testCase=e.testCase,this.setTriggerEventForAttempt(se(e.testCase,e.testResult??{retry:0}),"testBegin"),this.executionChain=this.executionChain.then(()=>Promise.allSettled([e.runCreation,e.instanceCreation])).then(([r,n])=>r.status==="rejected"||!r.value||n.status==="rejected"||!n.value?null:[r.value,n.value]).then(r=>{if(!r)return null;let[n,s]=r;return this.instanceId=s.instanceId,this.recordId?this.triggerUpdateRemoteTest():this.createRemoteTest(n,e.testCase,e.testResult)})}onStepBegin(e,r){this.testCase=e,this.setTriggerEventForAttempt(se(e,r),"stepBegin"),this.triggerUpdateRemoteTest()}onStepEnd(e,r){this.testCase=e,this.setTriggerEventForAttempt(se(e,r),"stepEnd"),this.triggerUpdateRemoteTest(),b.createOnceForAttempt({testLabel:A(e).join(" > "),testId:D(e),attemptId:r.retry,attachment:r.attachments,groupId:this.groupId})}onTestEnd(e,r){this.testCase=e,this.setTriggerEventForAttempt(se(e,r),"testEnd"),this.triggerUpdateRemoteTest(),b.createOnceForAttempt({testLabel:A(e).join(" > "),testId:D(e),attemptId:r.retry,groupId:this.groupId,attachment:r.attachments})}async createRemoteTest(e,r,n){if(!this.currentsConfig?.recordKey)throw new Error("missing Currents Record Key for createRemoteTest");if(!this.currentsConfig?.projectId)throw new Error("missing Currents Project Id for createRemoteTest");if(this.instanceId)try{Ae("Creating remote test record for %s",ht(r));let s=await U({method:"POST",url:"/test-record",data:{_v:0,_ct:new Date().toISOString(),_t:this.requestSequence.value,_s:ae(r),_d:this.isTestCaseFinished(),_f:this.isTestCaseFinished()&&this.isTestCaseFlaky(),runId:e.runId,instanceId:this.instanceId,testId:D(r),projectId:this.currentsConfig.projectId,groupId:this.groupId,machineId:e.machineId,spec:this.specName,expectedStatus:r.expectedStatus,annotations:this.getAnnotations(this.testCase),timeout:r.timeout,location:{column:r.location.column,file:r.location.file,line:r.location.line},title:A(r),retries:r.retries,attempts:this.getAttemptListPayload(r)},currentsOptions:{enableCompression:!0}});this.recordId=s.data.recordId,Ae("Remote test record created for %s, recordId: %s",A(r),this.recordId),b.setRecordId(D(r),this.recordId,this.instanceId,e.runId,e.machineId)}catch(s){d(`Cannot create remote test: %s > %s
%s`,this.specName,this.testCase.title,s.message);return}}triggerUpdateRemoteTest(){this.updateCounter++;let e=this.updateCounter;this.executionChain=this.executionChain.then(()=>{if(e!==this.updateCounter){Ae("Skipping updateRemoteTest: %o",{updateCounter:e,current:this.updateCounter,recordId:this.recordId});return}return this.updateRemoteTest()}).catch(r=>{Ae("Error while updating remote test: %o",{test:A(this.testCase),error:r.message,record:this.recordId})})}async _updateRemoteTest(){if(!this.recordId)throw new Error("missing recordId for updateRemoteTest");if(!this.currentsConfig?.recordKey)throw new Error("missing recordKey for updateRemoteTest");if(!this.testCase)throw new Error("missing testCase for updateRemoteTest");let e={_v:0,_e:this.getLastAttemptTriggerEventCode(),_d:this.isTestCaseFinished(),_f:this.isTestCaseFlaky()&&this.isTestCaseFinished(),_s:ae(this.testCase),attempts:this.getAttemptListPayload(this.testCase),annotations:this.getAnnotations(this.testCase)},r=this.getPayloadHash(e);if(this.updateRequestSet.has(r)){Ae("Similar update request was already sent, skipping %s",this.recordId);return}this.updateRequestSet.add(r);try{return U({method:"PUT",url:`/test-record/${this.recordId}`,data:{_t:this.requestSequence.value,...e},currentsOptions:{enableCompression:!0}})}catch(n){Ae("Error while updating remote test: %o",{test:A(this.testCase),error:n.message,record:this.recordId}),d(`Error while reporting remote test: %s
%s`,A(this.testCase),n.message)}}getPayloadHash(e){return oe(Buffer.from((0,li.default)(e)))}getAnnotations(e){return e.annotations?.map(r=>({type:r.type,description:r.description}))}getAttemptListPayload(e){return e.results.map(r=>({_s:jr(r.status),_e:this.getTriggerEventCode(this.getAttemptLastTriggerEvent(se(e,r))),attempt:r.retry,steps:this.getSteps(r.steps),workerIndex:r.workerIndex??-1,parallelIndex:r.parallelIndex??-1,startTime:r.startTime.toISOString(),duration:r.duration,status:r.status,stdout:this.getStdio(r.stdout),stderr:this.getStdio(r.stderr),errors:r.errors.map(n=>this.getError(n)),error:r.error?this.getError(r.error):void 0}))}isTestCaseFinished(){let e=this.testCase.results.map(r=>r.status);return(0,We.last)(e)==="interrupted"||e.includes(this.testCase.expectedStatus)?!0:this.testCase.results.length===this.testCase.retries+1&&this.isLastAttemptFinished()}isLastAttemptFinished(){return this.getLastAttemptTriggerEvent()==="testEnd"}getLastAttemptTriggerEvent(){let e=(0,We.last)(this.testCase.results);return e?this.getAttemptLastTriggerEvent(se(this.testCase,e)):"testBegin"}getAttemptLastTriggerEvent(e){return this.attemptTriggerEvent.get(e)??"testBegin"}getLastAttemptTriggerEventCode(){return this.getTriggerEventCode(this.getLastAttemptTriggerEvent())}getStdio(e){return e.map(r=>typeof r=="string"?r:r.toString())}getTriggerEventCode(e){switch(e){case"testBegin":return 0;case"stepBegin":return 1;case"stepEnd":return 2;case"testEnd":return 3}}getSteps(e){let r=Object.values((0,We.groupBy)(e,s=>s.category==="hook"?s.title:"default")),n=s=>{let i=[],a=[...s];if(a.splice(0,t.MAX_STEPS_PER_LEVEL).forEach(c=>{i.push({title:c.title,category:c.category,duration:c.duration,steps:n(c.steps),startTime:c.startTime.toISOString(),error:c.error?this.getError(c.error):void 0,location:c.location?this.getLocation(c.location):void 0})}),a.length>0){let c=a.find(p=>p.error);i.push({title:`... ${a.length} more steps`,category:a[0].category,duration:a.reduce((p,h)=>p+(h.duration||0),0),steps:[],startTime:a[0].startTime.toISOString(),error:c?.error?this.getError(c.error):void 0,location:c?.location?this.getLocation(c.location):void 0})}return i};return r.flatMap(n)}getError(e){let n=`
...truncated to fit the 2048-character limit
`;return{message:qr(e.message,{length:2048,separator:n}),stack:qr(e.stack,{length:2048,separator:n}),value:e.value,snippet:e.snippet,location:e.location?this.getLocation(e.location):void 0}}getLocation(e){return{column:e.column,file:e.file,line:e.line}}setTriggerEventForAttempt(e,r){this.attemptTriggerEvent.set(e,r)}isTestCaseFlaky(){return this.testCase.outcome()==="flaky"}},ce=class t{constructor(){this.container=new Map}static getId(e){return D(e)}create(e,r){let n=t.getId(e);return this.container.has(n)?this.get(n):(this.container.set(n,new Jr({...r,testCase:e})),this.get(n))}get(e){let r=this.container.get(e);if(!r)throw new Error(`TestResultReporter for ${e} not found`);return r}getAllExecutions(){return Array.from(this.container.values()).map(e=>e.execution)}},Kr=class{constructor(){this.counter=0}get value(){return this.counter++}};var le=l.extend("actor"),Mt=class{constructor(e,r){this.testResultsContainer=new ce;this.suite=e,this.config=r,this.executionState=new Ft(r);let n=P(),s=qs(n?.ciBuildId);this.printer=new ue(r,e,this.executionState,n,s.ciBuildId),!Y()&&w(this.printer.getIntro()),e.suites.forEach(i=>{let a=W(i.project());le("Creating project execution state for project: %s",a);let c=i.allTests(),p=c.map(C=>({specName:B(C,r),testCase:C})),h=(0,J.groupBy)(p,"specName"),I=this.executionState.upsertProjectExecution(a).setRun(this.createRun({projectId:a,project:i.project(),createRunParams:{ci:s,browser:{name:a,version:""},tests:c.map(C=>({testId:D(C),spec:B(C,r),title:A(C)})),group:a,config:{pw:this.config,currents:{autoCancelAfterFailures:n?.cancelAfterFailures,removeTitleTags:!!n?.removeTitleTags,disableTitleTags:!!n?.disableTitleTags}}}}));c.forEach(C=>{I.upsertSpecExecution(B(C,r),Q(C),h[B(C,r)].map(R=>R.testCase),this.printer).createTestExecution(D(C),C,this.printer)})}),this.printer.chainRunCreation()}async createRun(e){return Un("discovery",{},this._createRun.bind(this))(e)}async _createRun(e){let r=await ci(this.config,this.suite);return ri({...e.createRunParams,fullTestSuite:r,projectTags:e.project?.metadata?.pwc?.tags??[]}).then(n=>n?(n?.cancellation&&(rt(n.cancellation),nt()),n):(d("Could not start recording for project: %s",e.projectId),null))}onTestBegin(e){le("Test begin: %s",A(e));let r=(0,J.last)(e.results)??null,n=Q(e),s=B(e,this.config),i=this.startCreatingInstance(e);this.testResultsContainer.create(e,{specName:s,projectId:n}).onTestBegin({testCase:e,testResult:r,runCreation:this.executionState.getProjectExecution(n).run,instanceCreation:i}),this.printer.onTestBegin(e)}onTestEnd(e,r){le("Test end: %s, %o",A(e),{attempt:r.retry,status:r.status,duration:r.duration}),this.testResultsContainer.get(ce.getId(e)).onTestEnd(e,r);let n=this.executionState.getTestExecution(e)?.setTestCase(e);this.printer.onTestEnd(e,r).then(()=>{n?.specExecution.finish(this.config)})}onStepBegin(e,r){this.testResultsContainer.get(ce.getId(e)).onStepBegin(e,r)}onStepEnd(e,r){this.testResultsContainer.get(ce.getId(e)).onStepEnd(e,r)}async onEnd(e){le("All tests have finished, %o",e),await this.printer.onEnd(e)}async startCreatingInstance(e){let r=this.executionState.getSpecExecution(e),n=(0,J.first)((0,J.orderBy)(e.results,"startTime","asc"));return r.startInstanceCreation({run:this.executionState.getProjectExecution(r.projectId).run,startTime:n?.startTime??new Date,worker:bs(e)})}async awaitAllResults(){le("Awaiting for completion of reporting tasks...");let e=[...this.testResultsContainer.getAllExecutions(),...this.executionState.getAllPendingPromises()];await Promise.allSettled(e),await Promise.allSettled(b.getAllUploads())}reportUnfinishedSpecExecutions(){this.executionState.getUnfinishedSpecExecutions().forEach(e=>{le("Spec execution with no results: %s",e.specName);let r=e.getAllTestExecutions().filter(s=>!s.isFinished()).map(s=>s.getFakeTestCase());if(!r.length)return;le("Non-finished tests: %o",r.map(s=>s.titlePath()));let n=`Playwright did not finish running ${(0,Yr.default)("test",r.length,!0)}, reporting missing attempts as ${De("skipped")}:
`;r.forEach(s=>{let i=s.results.filter(a=>a.__currents_isFake).length;n+=m(`- ${ht(s)} (${i} ${(0,Yr.default)("attempt",i)})
`),this.onTestBegin(s),this.onTestEnd(s,(0,J.last)(s.results)??Se.getFakeTestResult(0))}),de(n)})}};var Ja=l.extend("reporter"),gi=l.extend("step"),Ve=class{constructor(e){this.errors=[];this._testActor=null;this.startTime=new Date;this.fullConfig=null;this.remoteDebug=lt.factory("core"),this.configLoader=new Re(e,this.onC12ConfigLoaded).start();try{this.startTime=new Date}catch(r){(0,Bt.match)(r).with(Bt.P.instanceOf(pe),()=>{process.exit(1)}).otherwise(n=>{throw y("Unexpected error",n),new Error("Unexpected error")})}}printsToStdio(){return!0}onStdOut(e,r,n){this.testActor.printer.onStdOut(e,r,n)}onStdErr(e,r,n){this.testActor.printer.onStdErr(e,r,n)}onBegin(e,r){this.configLoader.waitSync(),this.fullConfig=e,Ja("Beginning tests execution: %o",r.allTests().map(n=>n.titlePath())),Y()||fn(e),ns(e.version),bn(),this._testActor=new Mt(r,e)}onError(e){y(`Global error reported by test runner:
%s`,Mr(this.fullConfig,e,!0).message),this.errors.push(e)}onStepBegin(e,r,n){gi("> %s %s",n.category,n.title),this.testActor.onStepBegin(e,r)}onStepEnd(e,r,n){gi("< %s %s",n.category,n.title),this.testActor.onStepEnd(e,r)}onTestBegin(e){this.testActor.onTestBegin(e)}onTestEnd(e,r){this.testActor.onTestEnd(e,r)}async onEnd(e){try{await this.testActor.onEnd(e),this.testActor.reportUnfinishedSpecExecutions(),await this.testActor.printer.farewell(this.startTime,b.getAllUploads().length),m("  Finalizing uploading artifacts to Currents..."),await this.testActor.awaitAllResults();let r=await this.testActor.executionState.getRunUrl();r&&process.env.CURRENTS_RUN_URL_FILE&&(console.log("Writing run url to file",process.env.CURRENTS_RUN_URL_FILE),di.default.writeFileSync(process.env.CURRENTS_RUN_URL_FILE,r));let n=this.testActor.executionState.getAllSpecExecutions();if(!n.length)return me(),d("No tests detected, stopping execution"),me(),e;this.errors.length>0&&(de(`Execution errors:
`),this.errors.forEach(a=>console.error(a.message))),ve.length>0&&(Zr(`Execution errors:
`),ve.forEach(a=>w(a))),ee.length&&(de(`Execution warnings:
`),ee.forEach(a=>w(a))),b.uploadWarnings.size>0&&(de(`Upload warnings:
`),b.uploadWarnings.forEach(a=>w(a)));let s=await this.testActor.executionState.getRunId();if(process.env._CURRENTS_E2E_TESTS&&await new Promise(a=>setTimeout(a,1e3)),Y()&&await $o({executionState:this.testActor.executionState}),!Y()){let a=P()?.outputFile;a&&await jo({outputFile:a,summary:await this.testActor.executionState.getSummary()}),me(),w("\u{1F3C1} Done!")}let i=n.some(a=>a.isFailed())?"failed":"passed";return await this.remoteDebug.finalize({runId:s}),{status:i}}catch(r){return console.error(r),{status:"failed"}}finally{vn()}}onC12ConfigLoaded(e){Object.keys(e.config).length>0&&m("Using config file: %s",e.configFile)}get testActor(){if(!this._testActor)throw new Error("@currents/playwright panic: Test actor not initialized");return this._testActor}};o();var Ka=(t,e=null)=>async function({launchOptions:r},n,s){await Promise.all([Sr(null,s),vr({config:t,use:n,workerInfo:s,chainedFixture:e??r})])},Ya=(t=null)=>async function({contextOptions:e},r,n){let s=await $.getState("fixtureGitInfo");await xr(r,n,s,t??e)},mi=(t={})=>t.currentsFixturesEnabled===!1?t:{...t,launchOptions:Ka(t.currentsConfigOptions||{},t.launchOptions),contextOptions:Ya(t.contextOptions)};var za=t=>["@currents/playwright",t],Qa={baseFixtures:Io,coverageFixtures:To,actionFixtures:Ro},Xa={includeCurrentsWrappers:mi},Za=Ve;0&&(module.exports={configHelpers,currentsReporter,fixtures});
/*! For license information please see index.js.LEGAL.txt */
//# sourceMappingURL=index.js.map