"use strict";var Xr=Object.create;var F=Object.defineProperty;var Zr=Object.getOwnPropertyDescriptor;var eo=Object.getOwnPropertyNames;var to=Object.getPrototypeOf,ro=Object.prototype.hasOwnProperty;var l=(e,t)=>()=>(e&&(t=e(e=0)),t);var ae=(e,t)=>{for(var r in t)F(e,r,{get:t[r],enumerable:!0})},Ve=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of eo(t))!ro.call(e,s)&&s!==r&&F(e,s,{get:()=>t[s],enumerable:!(n=Zr(t,s))||n.enumerable});return e};var c=(e,t,r)=>(r=e!=null?Xr(to(e)):{},Ve(t||!e||!e.__esModule?F(r,"default",{value:e,enumerable:!0}):r,e)),oo=e=>Ve(F({},"__esModule",{value:!0}),e);var o=l(()=>{"use strict"});var Ke,We=l(()=>{Ke={name:"@currents/playwright",version:"1.12.1",main:"./dist/index.js",author:{name:"Currents Software Inc",email:"hello@currents.dev",url:"https://currents.dev"},license:"MIT",homepage:"https://currents.dev",repository:{type:"git",url:"https://github.com/currents-dev/currents-playwright-changelog.git"},scripts:{test:"vitest",rm:"rimraf dist",lint:'TIMING=1 eslint "**/*.ts*"',build:"tsup-node --minify --dts",dev:"tsup-node --watch --dts",release:"release-it --verbose","publish:npm":"npm run rm  && npm run build && ./publish.js","release-ci":"npm run rm && npm run build && ./publish.js -t latest"},bin:{pwc:"./dist/bin/pwc.js","pwc-p":"./dist/bin/pwc-p.js"},devDependencies:{"@playwright/test":"^1.44.0","@release-it/conventional-changelog":"^7.0.2","@types/async-retry":"^1.4.5","@types/babel__code-frame":"^7.0.3","@types/debug":"^4.1.12","@types/getos":"^3.0.4","@types/json-stringify-safe":"^5.0.3","@types/lodash":"^4.17.15","@types/pluralize":"^0.0.33","@types/proxy-from-env":"^1.0.4","@types/randomstring":"^1.3.0","@types/shelljs":"^0.8.15","@types/stack-utils":"^2.0.3","@types/tmp":"^0.2.6","@types/ws":"^8.18.0",eslint:"^9.23.0","eslint-config-custom":"*",msw:"^2.7.1","release-it":"^18.1.2",rimraf:"^6.0.1",tsconfig:"*",tsup:"^8.3.5",typescript:"^5.8.2",vitest:"^3.0.9",wtfnode:"^0.10.0"},dependencies:{"@babel/code-frame":"^7.18.6","@commander-js/extra-typings":"^12.1.0","@currents/commit-info":"1.0.1-beta.0","async-retry":"^1.3.3",axios:"^1.8.3","axios-retry":"^4.5.0",c12:"^1.11.2",chalk:"^4.1.2",commander:"^12.1.0","date-fns":"^4.1.0",debug:"^4.3.7",dotenv:"^16.0.3",execa:"^9.5.2",getos:"^3.2.1","https-proxy-agent":"^7.0.5","istanbul-lib-coverage":"^3.2.2","json-stringify-safe":"^5.0.1","lil-http-terminator":"^1.2.3",lodash:"^4.17.21",nanoid:"^3.3.8","object-sizeof":"^2.6.5","p-debounce":"^2.1.0","p-map":"^4.0.0","p-queue":"6.6.2",pino:"^9.6.0",pluralize:"^8.0.0","pretty-ms":"^7.0.1","proxy-from-env":"^1.1.0","source-map-support":"^0.5.21","stack-utils":"^2.0.6",tmp:"^0.2.3","tmp-promise":"^3.0.3","ts-pattern":"^5.7.0",ws:"^8.18.1"},files:["dist","!**/*.map","!**/*/*.map","**/*.LEGAL.txt","LICENSE.md","README.md","CHANGELOG.md"],keywords:["playwright","playwright dashboard","cloud dashboard","reporter","currents","tests reporter","sorry cypress","ci"],exports:{".":{import:"./dist/index.js",require:"./dist/index.js"},"./discovery":{import:"./dist/reporters/discovery.js",require:"./dist/reporters/discovery.js"},"./orchestration":{import:"./dist/orchestration/index.js",require:"./dist/orchestration/index.js"},"./package.json":"./package.json"},publishConfig:{access:"public",registry:"https://registry.npmjs.org"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"../../CHANGELOG.md"}},git:{commitMessage:"chore: release v${version}",tagName:"v${version}"},hooks:{"before:github:release":"npm run --prefix ../../ update-public-changelog"}}}});var k,ue=l(()=>{"use strict";o();We();k=Ke.version});function G(e={}){let t=Ye.default.create(e);return t.interceptors.request.use(r=>{let n={...r},s=t.getUri(r),a=qe.default.getProxyForUrl(s);return a&&(so("Using HTTP proxy %s for %s ",a,s),n.proxy=!1,n.httpsAgent=io(a)),n}),t}function io(e){return H||(H=new Je.HttpsProxyAgent(e),H)}var Ye,Je,qe,so,H,le=l(()=>{"use strict";o();Ye=c(require("axios")),Je=require("https-proxy-agent"),qe=c(require("proxy-from-env"));E();so=p.extend("axios");H=null});var ce,Qe,ze=l(()=>{"use strict";o();ce=()=>process.env.CURRENTS_API_URL??"https://cy.currents.dev",Qe=()=>3e4});function Xe(e){ao.push(e)}var ao,pe=l(()=>{"use strict";o();ao=[]});var Ze,et,tt=l(()=>{"use strict";o();Ze=[],et=[]});var I,j,de,O,d,C,me,uo,B,fe,Pn,Nn,xn,Bn,wn,vn,Mn,Fn,f,kn,rt=l(()=>{"use strict";o();I=c(require("chalk")),j=c(require("util"));E();pe();tt();de=(...e)=>{let t=j.default.format(...e);Xe(t),console.log(t)},O=de,d=(...e)=>{let t=j.default.format(...e);return et.push(t),p("WARNING: ",t),de(I.default.bgYellow.black(" WARNING "),t)},C=(...e)=>{let t=j.default.format(...e);return Ze.push(t),p("ERROR: ",t),de(I.default.bgRed.white(" ERROR "),t)},me=()=>console.log(`
`+uo()+`
`),uo=()=>I.default.dim(Array(64).fill("=").join("")),B=(e=2)=>console.log(Array(e).fill("").join(`
`)),fe=I.default.cyan,Pn=I.default.blueBright,Nn=I.default.red,xn=I.default.yellow,Bn=I.default.green,wn=I.default.gray,vn=I.default.white,Mn=I.default.black,Fn=I.default.magenta,f=I.default.dim,kn=I.default.bold});var S=l(()=>{"use strict";o();pe();rt()});var ot,nt,st=l(()=>{"use strict";o();ot=c(require("events"));E();ge();nt=new ot.default});var Ee,at,it,ut,lt=l(()=>{"use strict";o();S();st();Ee={cancellationReason:null},at=e=>{Ee.cancellationReason||(Ee.cancellationReason=e)},it=()=>Ee.cancellationReason,ut=({showWarning:e=!0}={})=>{let t=it();t&&(e&&d("%s",t),nt.emit("runCancelled",t))}});var ge=l(()=>{"use strict";o();lt()});var ct,os,co,pt,dt=l(()=>{"use strict";o();ct=require("async_hooks"),os=new ct.AsyncLocalStorage,co=new Map,pt=e=>{let t=co.get(e);return t?t.getStore():null}});var mt,L,$=l(()=>{"use strict";o();mt=require("nanoid"),L=(0,mt.customAlphabet)("abcdefghijklmnopqrstuvwxyz",10)});function Rt(e){(0,R.match)(e).when(gt.isAxiosError,po).otherwise(()=>{d("Unexpected error while sending network request: %s",e)})}function po(e){return(0,R.match)(e).with({code:"ECONNABORTED"},()=>{d("Network connection aborted")}).with({code:"ECONNREFUSED"},()=>{d("Network connection aborted")}).with({code:"ECONNRESET"},()=>{d("Network connection reset")}).with({code:"ETIMEDOUT"},()=>{d("Network connection timeout")}).with({response:R.P.not(R.P.nullish)},t=>{mo(t,{status:t.response.status,data:t.response.data})}).otherwise(t=>{d(`[currents] Unexpected network error: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,payload:e.response?.config.data,requestId:w(e)})})}function mo(e,{status:t,data:r}){(0,R.match)(t).with(401,()=>{d(`[currents] ${e.response?.config.method} ${e.response?.config.url}} - 401 Unauthorized Request from cloud service`)}).with(400,()=>{d(`[currents] ${e.response?.config.method} ${e.response?.config.url} - 400 Bad Request from cloud service:
%o`,r)}).with(429,()=>{d(`[currents] ${e.response?.config.method} ${e.response?.config.url} - 429 Too Many Requests from cloud service`)}).with(422,()=>{fo(e,r)}).otherwise(()=>{d(`[currents] Unexpected network response: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,requestId:w(e)})})}function fo(e,t){(0,R.match)(t).with({code:_e.MISSING_SUITE,message:R.P.string,errors:R.P.array(R.P.string)},async r=>{let{message:n,errors:s}=r,a=pt("discovery");B(1),C(...ft(n,s)),V({id:L(),text:(0,Et.default)(a,null,2)}).then(u=>{C(`Please share this URL with Currents support for further investigation:
${u}`)}).catch(u=>{d("Failed to upload debug artifact: %s",u)}),B(1)}).with({code:_e.RUN_CANCELLED,message:R.P.string},r=>{at(r.message),ut()}).with({code:_e.RUN_EXPIRED,message:R.P.string},r=>{d(r.message)}).with({message:R.P.string,errors:R.P.array(R.P.string)},r=>{let{message:n,errors:s}=r;B(1),d(...ft(n,s)),B(1)}).otherwise(()=>{d(`[currents] Unexpected network response: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,requestId:w(e)})})}function ft(e,t){return _t.default.isString(e)?t?.length===0?[e]:[e,`
${(t??[]).map(r=>`  - ${r}`).join(`
`)}
`]:["Unexpected network error"]}function w(e){return e?.response?.headers["apigw-requestid"]}var gt,Et,_t,R,_e,Re=l(()=>{"use strict";o();gt=require("axios"),Et=c(require("json-stringify-safe")),_t=c(require("lodash")),R=require("ts-pattern");ge();dt();$();S();Ie();_e={RUN_CANCELLED:"RUN_CANCELLED",RUN_EXPIRED:"RUN_EXPIRED",MISSING_SUITE:"MISSING_SUITE"}});function Tt(e,t,r){let n=r.method?.toUpperCase(),s=r.url,a=w(t),u=(0,It.default)(he(e)),_=`Network request '${n} ${s}' failed: '${t.message}'.${a?` Request ID: ${a}.`:""} Next attempt is in ${u} (${e}/${r["axios-retry"]?.retries||Te()}).`;Ct(_),d(_)}var Ce,It,Ct,he,ht,Te,St=l(()=>{"use strict";o();Ce=require("axios"),It=c(require("pretty-ms"));E();S();Re();Ct=p.extend("http"),he=e=>[3*1e3,15*1e3,30*1e3][e-1],ht=e=>(Ct("isRetriableError: %o",{message:e.message,code:"code"in e?e.code:void 0,status:"response"in e?e.response?.status:void 0,headers:"response"in e?e.response?.headers:void 0,data:"response"in e?e.response?.data:void 0,isAxiosError:(0,Ce.isAxiosError)(e)}),"code"in e&&e.code&&["ECONNABORTED","ECONNREFUSED","ECONNRESET","ETIMEDOUT","ENETRESET","ENOTFOUND","EAI_AGAIN"].includes(e.code)?!0:(0,Ce.isAxiosError)(e)?[429,500,502,503,504].includes(e.response?.status??0):!1),Te=()=>3});function Bt(e){xt["x-pw-version"]=e??"0.0.0"}function Ro(){let e=G({baseURL:ce(),timeout:Qe(),transitional:{clarifyTimeoutError:!0}});return e.interceptors.request.use(async t=>{let{currentsOptions:r}=t,n={..._o,...r};return n.enableCompression&&(0,Dt.default)(t.data)>n.compressThresholdBytes?(t.headers["Content-Encoding"]="gzip",{...t,data:await Eo((0,At.default)(t.data))}):t}),e.interceptors.request.use(t=>{let r=t["axios-retry"]?.retryCount??0,n=b();t.headers.set({...xt,"Accept-Encoding":"gzip, deflate, br","x-currents-idempotency-key":t.headers["x-currents-idempotency-key"]??(0,yt.nanoid)(),"x-pwc-request-attempt":r,"x-currents-key":n?.recordKey??null}),n?.orchestrationId&&t.headers.set("x-currents-orchestration-id",n.orchestrationId),n?.machineId&&t.headers.set("x-currents-machine-id",n.machineId),t.headers.get("Content-Type")||t.headers.set("Content-Type","application/json");let s={...bt.default.pick(t,"method","url","headers"),data:Buffer.isBuffer(t.data)?"buffer":t.data};return r?Ot("network request retry: %o",Ut({...s,isRetry:!0})):Ot("network request: %o",Ut(s)),t}),(0,Lt.default)(e,{retries:Te(),retryCondition:ht,retryDelay:he,shouldResetTimeout:!0,onRetry:Tt}),e}function wt(){return W||(W=Ro(),W)}function Ut(e){return{method:e.method,baseUrl:ce(),url:e.url,data:e.isRetry?"<retry>":Io(e.data),headers:{...e.headers,"x-currents-key":"***"}}}function Io(e){return e?.results?.raw?{...e,results:{...e.results,raw:"***"}}:e}var Lt,At,bt,yt,Dt,Pt,Nt,Ot,go,xt,Eo,W,_o,Se=l(()=>{"use strict";o();Lt=c(require("axios-retry")),At=c(require("json-stringify-safe")),bt=c(require("lodash")),yt=require("nanoid"),Dt=c(require("object-sizeof")),Pt=require("util"),Nt=c(require("zlib"));y();E();ue();le();ze();St();Ot=p.extend("http"),go=1024*1024*1,xt={"x-pw-version":"0.0.0","x-pwc-version":k},Eo=(0,Pt.promisify)(Nt.default.gzip);W=null,_o={enableCompression:!1,compressThresholdBytes:go}});async function D(e,t=wt){try{let r=await t().request(e);return vt("network response: %o",{...Mt.default.omit(r,"request","config"),url:r.config.url,method:r.config.method}),r}catch(r){let n=r;throw vt("network error: %o",{code:n.code,message:n.message,url:n.config?.url,method:n.config?.method,status:n.response?.status,headers:n.response?.headers,data:n.response?.data}),Rt(n),n}}var Mt,vt,Ft=l(()=>{"use strict";o();Mt=c(require("lodash"));E();Se();Re();vt=p.extend("http")});var Oe=l(()=>{"use strict";o();Ft()});var kt={};ae(kt,{getDebugUrl:()=>Co});var Co,Ht=l(()=>{"use strict";o();Oe();Co=({runId:e,type:t})=>D({method:"POST",url:"runs/debug-logs",data:{type:t,runId:e}}).then(r=>r.data)});function ho(e,t){return Vt({path:e,name:null,uploadUrl:t,contentType:"text/plain"},"text/plain",void 0)}async function Vt(e,t,r){let n=await jt.default.readFile(e.path);return Ue("Uploading file %s",e.uploadUrl,{buffer:Buffer.byteLength(n)}),Wt(n,e.uploadUrl,t,r)}async function To(e,t,r){return Ue("Uploading buffer %s",e.name,{buffer:Buffer.byteLength(e.buffer)}),Wt(e.buffer,e.uploadUrl,t,r)}async function So(e,t,r,n){return G().request({method:"put",url:t,data:e,onUploadProgress:n,headers:{"Content-Disposition":"inline","Content-Type":r}})}async function Wt(...e){await(0,Gt.default)(async()=>{await So(...e)},{retries:5,onRetry:(t,r)=>{if(Ue("Upload failed %d out of 5 attempts: %s",r,t.message),r===5){C(`Cannot upload after ${r} times: ${t.message}`);return}d(`Upload failed ${r} out of 5 attempts: ${t.message}`)}})}var Gt,jt,Ue,$t,Kt=l(()=>{"use strict";o();Gt=c(require("async-retry")),jt=c(require("fs/promises"));E();le();S();Ue=p.extend("upload"),$t=(s=>(s.PNG="image/png",s.WEBM="video/webm",s.TEXT="text/plain",s.ZIP="application/zip",s))($t||{})});var Yt={};ae(Yt,{ContentType:()=>$t,sendBuffer:()=>To,sendPath:()=>Vt,uploadText:()=>ho});var Jt=l(()=>{"use strict";o();Kt()});async function V(e){let{getDebugUrl:t}=await Promise.resolve().then(()=>(Ht(),kt));try{let{readUrl:r,uploadUrl:n}=await t({runId:e.id,type:"pw-debug"}),{uploadText:s,sendBuffer:a}=await Promise.resolve().then(()=>(Jt(),Yt));return"text"in e&&await a({name:`${e.id}-discovery-debug.log`,buffer:Buffer.from(e.text,"utf-8"),contentType:"text/plain",uploadUrl:n},"text/plain",void 0),"path"in e&&await s(e.path,n),r}catch{return null}}var Le,Ae=l(()=>{"use strict";o();Le=c(require("debug"))});function Oo(e){return e==="false"?!1:e==="remote"?"remote":e==="full"?"full":!!e}var qt,Qt,zt=l(()=>{"use strict";o();qt=require("@commander-js/extra-typings"),Qt=new qt.Option("--pwc-debug [boolean | 'remote' | 'full']","enable debug logs for the reporter. Specify 'remote' to upload logs to Currents. Specify 'full' to dump the debug logs to stdout and upload to Currents.").argParser(Oo).env("CURRENTS_DEBUG")});var Xt,Zt,er=l(()=>{"use strict";o();Xt=require("@commander-js/extra-typings");zt();Zt=()=>new Xt.Command().allowUnknownOption().addOption(Qt).helpOption(!1)});var U,tr,ye,rr,or,be,K,De=l(()=>{"use strict";o();U=c(require("debug")),tr=c(require("fs")),ye=c(require("path")),rr=c(require("util")),or=require("fs/promises");$();S();er();Ae();U.default.useColors=function(){return!1};be=U.default.log,K=class e{constructor(t="core"){this.source=t;this.pipelines={};if(this.mode=Zt().parse().opts().pwcDebug??!1,this.debug=(0,U.default)(`currents:remote-debug:${this.source}`),!this.mode)return this;if(!this.shouldEnableDebug())return this;let r=process.env.DEBUG?`${process.env.DEBUG},currents*`:"currents*";if(U.default.enable(r),!this.shouldUploadRemoteDebug())return this;let n=L(),s=ye.default.resolve(".currents-debug"),a=ye.default.resolve(s,`${n}.log`);(0,or.mkdir)(s,{recursive:!0}),O(f(`\u{1F47E} Initiated remote ${this.source} debug log collection:`),f(a));let u=tr.default.createWriteStream(a,{flags:"a"});return U.default.log=(..._)=>{this.mode&&(u.write(`${rr.default.formatWithOptions({colors:!1},..._)}
`),this.shouldMuteLocalStdout()||be(..._))},this.pipelines[n]={id:n,writeStream:u,type:this.source,tempFilePath:a},this}static factory(t="core"){return this.instance||(this.instance=new e(t)),this.instance}getDebugMode(){return this.mode}async finalize({runId:t}={runId:void 0}){try{let r=Object.keys(this.pipelines);r.length===0&&(this.debug("No debug pipelines found"),U.default.log=be);for(let n of r)await this.uploadDebug(n,t??L())}catch{}finally{U.default.log=be}}async uploadDebug(t,r){let n=this.pipelines[t];if(!n){this.debug("No debug pipeline found for id %s",t);return}O(f(`\u{1F47E} ${n.type} debug log written:`),f(n?.tempFilePath));try{let s=await V({id:r,path:n.tempFilePath});n?.writeStream.end(),O(f(`\u{1F47E} ${n.type} debug log uploaded:`),f(s))}catch(s){d(`Failed to upload ${n.type}} debug log ${f(n.tempFilePath)}: ${s.message}`)}}shouldEnableDebug(){return this.mode==="full"||this.mode==="remote"||this.mode===!0}shouldUploadRemoteDebug(){return this.mode==="full"||this.mode==="remote"}shouldMuteLocalStdout(){return this.mode==="remote"}}});var Ie=l(()=>{"use strict";o();Ae();De()});var p,E=l(()=>{"use strict";o();Ie();p=(0,Le.default)("currents")});var Y,nr=l(()=>{"use strict";o();Y=class extends Error{}});var v,Pe=l(()=>{"use strict";o();v={guide:{ciBuildId:"https://docs.currents.dev/guides/ci-build-id",integration:"https://docs.currents.dev/integration-with-playwright/currents-playwright"}}});function ir(e){if(!e)return;if(e==="false")return!1;let t=parseInt(e,10);if(isNaN(t)||t<1)throw new sr.CommanderError(255,"Invalid argument provided.","--pwc-cancel-after-failures must be a positive integer or 'false', provided: "+e);return t}var sr,ar=l(()=>{"use strict";o();sr=require("commander")});function J(e){return h[e]?.env}function q(e){return h[e].cli}function ur(e){return h[e].name}function lr(){return{projectId:process.env[h.projectId.env],recordKey:process.env[h.recordKey.env],ciBuildId:process.env[h.ciBuildId.env],tag:process.env[h.tag.env]?process.env[h.tag.env]?.split(",").map(e=>e.trim()):void 0,cancelAfterFailures:ir(process.env[h.cancelAfterFailures.env]),disableTitleTags:process.env[h.disableTitleTags.env],testSuiteFile:process.env[h.testSuiteFile.env],machineId:process.env[h.machineId.env],orchestrationId:process.env[h.orchestrationId.env]}}var h,Ne=l(()=>{"use strict";o();ar();h={currentsConfigFile:{name:"Currents Config File Path",env:"CURRENTS_CONFIG_FILE_PATH",cli:"--pwc-config"},ciBuildId:{name:"CI Build ID",env:"CURRENTS_CI_BUILD_ID",cli:"--ci-build-id"},recordKey:{name:"Record Key",env:"CURRENTS_RECORD_KEY",cli:"--key"},projectId:{name:"Project ID",env:"CURRENTS_PROJECT_ID",cli:"--project-id"},tag:{name:"Currents Tag",env:"CURRENTS_TAG",cli:"--tag"},cancelAfterFailures:{name:"Currents Cancel After Failures",env:"CURRENTS_CANCEL_AFTER_FAILURES",cli:"--pwc-cancel-after-failures"},disableTitleTags:{name:"Disable Title Tags",env:"CURRENTS_DISABLE_TITLE_TAGS",cli:"--pwc-disable-title-tags"},testSuiteFile:{name:"Test Suite File",env:"CURRENTS_TEST_SUITE_FILE",cli:"--pwc-test-suite-file"},machineId:{name:"Machine ID",env:"CURRENTS_MACHINE_ID",cli:"--pwc-machine-id"},orchestrationId:{name:"Orchestration ID",env:"CURRENTS_ORCHESTRATION_ID",cli:"--pwc-orchestration-id"},outputFile:{name:"Output File",env:"CURRENTS_OUTPUT_FILE",cli:"--pwc-output-file"}}});function P(){if(xe)return xe;if(process.env.CURRENTS_PWC_CLI_CONFIG_PATH)try{let e=JSON.parse(pr.default.readFileSync(process.env.CURRENTS_PWC_CLI_CONFIG_PATH).toString());return cr("Options from serialized CLI config file: %o",e),xe=e,e}catch(e){return cr("Could not read CLI config file: %o",e),{}}return{}}var pr,cr,xe,Be=l(()=>{"use strict";o();pr=c(require("fs"));E();cr=p.extend("cli-options-serializer"),xe=null});function dr(e,t,r={validationFn:Fe}){we("reporter options: %o",e),we("config file options: %o",t);let n={...T(ve),...T(t),...T(e),...T(P()),...T(lr()),orchestration:{...T(ve.orchestration),...T(t?.orchestration),...T(e?.orchestration),...T(P().orchestration)},coverage:{...T(ve.coverage),...T(t?.coverage),...T(e?.coverage),...T(P().coverage)}};r.validationFn(n),Me=n,we("resolved currents config: %o",Me)}function Fe(e){Uo.forEach(t=>{if(!e[t])throw C(`${ur(t)} is required for Currents Reporter. Use the following methods:
  - as environment variable: ${f(J(t))}
  - as CLI flag of pwc command: ${f(q(t))}
  - as reporter configuration option ${f(t)} in ${f("playwright.config.ts")}
  
  \u{1F4D6} ${v.guide.integration}`),new Y("Missing required config variable")})}function T(e){return Object.entries(e??{}).reduce((t,[r,n])=>n===void 0?t:{...t,[r]:n},{})}function b(){return Me}function mr(e){e.preserveOutput!=="always"&&d(`The "preserveOutput" property in your Playwright config is set to ${e.preserveOutput}. This may cause artifacts to be removed before they are uploaded to Currents. We recommend setting it to "always".`)}var we,Uo,ve,Me,fr=l(()=>{"use strict";o();E();nr();Pe();S();Ne();Be();we=p.extend("config"),Uo=["projectId","recordKey"],ve={removeTitleTags:!1,disableTitleTags:!1,orchestration:{skipReporterInjection:!1},coverage:{projects:!1}},Me=null});function Er(e){let t=new WeakMap;function r(n){if(typeof n=="object"&&n!==null){if(t.has(n))return"[Circular]";t.set(n,!0)}}return(0,gr.cloneDeepWith)(e,r)}function Q(e){let r=Object.getOwnPropertySymbols(e).find(s=>s.toString().match(/configInternalSymbol/))??Object.getOwnPropertyNames(e).find(s=>s.match(/_internal/));return r?e[r]:(d("Could not extract internal playwright configuration"),null)}var gr,_r=l(()=>{"use strict";o();gr=require("lodash");S()});var y=l(()=>{"use strict";o();fr();Ne();Be();_r()});var pn={};ae(pn,{default:()=>cn});module.exports=oo(pn);o();o();var Qr=require("nanoid");y();o();y();E();S();o();var Rr=require("c12");function Ir(e){return(0,Rr.loadConfig)({name:"currents",configFile:e})}o();S();function Cr(e=()=>!1){let t=Date.now(),r=Lo();for(;!e();)if(Date.now()-t>r)throw C(`Could not load Currents config after ${r}ms, exiting...`),new Error("Could not load Currents config")}function Lo(e=5e3){let t=Number(process.env.CURRENTS_CONFIG_LOAD_TIMEOUT_MS);return isNaN(t)||t<1?e:t}var hr=p.extend("config-loader"),z=class{constructor(t,r=a=>{},n=()=>{process.exit(1)},s={validationFn:Fe}){this.reporterOptions=t;this.onSuccess=r;this.onFailure=n;this.options=s;this._configLoaded=!1;this._promise=null}start(){return this._promise=Ir(P().pwcConfigPath).then(async t=>{this.onSuccess(t),dr(this.reporterOptions,t.config,{validationFn:this.options.validationFn})}).catch(t=>{C("Could not load currents configuration: %O",t),this.onFailure()}).finally(()=>{this._configLoaded=!0}),this}waitSync(){return hr("Waiting to load config..."),Cr(()=>this._configLoaded),this}load(){return this._promise||(hr("Starting config loader"),this.start()),this._promise}};E();o();var g=require("lodash");E();$();var X=p.extend("ci"),Ao=(e,...t)=>(0,g.chain)(t).compact().join(e).value(),bo=(e,t)=>(0,g.set)(e,(0,g.camelCase)(t),process.env[t]),m=e=>(0,g.transform)(e,bo,{}),yo=()=>process.env.TF_BUILD&&process.env.TF_BUILD_BUILDNUMBER,Do=()=>process.env.TF_BUILD&&process.env.AZURE_HTTP_USER_AGENT,Po=()=>(0,g.some)(process.env,(e,t)=>/^CODEBUILD_/.test(t)),No=()=>process.env.bamboo_buildNumber,xo=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&process.env.CODESHIP,Bo=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&!process.env.CODESHIP,wo=()=>(0,g.some)(process.env,(e,t)=>/^CONCOURSE_/.test(t)),vo=()=>process.env.GITLAB_CI||process.env.CI_SERVER_NAME&&/^GitLab/.test(process.env.CI_SERVER_NAME),Mo=()=>process.env.GCP_PROJECT||process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT,Fo=()=>process.env.JENKINS_URL||process.env.JENKINS_HOME||process.env.JENKINS_VERSION||process.env.HUDSON_URL||process.env.HUDSON_HOME,ko=()=>process.env.WERCKER||process.env.WERCKER_MAIN_PIPELINE_STARTED,Ho={appveyor:"APPVEYOR",azure:Do,awsCodeBuild:Po,bamboo:No,bitbucket:"BITBUCKET_BUILD_NUMBER",buildkite:"BUILDKITE",circle:"CIRCLECI",codeshipBasic:xo,codeshipPro:Bo,concourse:wo,codeFresh:"CF_BUILD_ID",drone:"DRONE",githubActions:"GITHUB_ACTIONS",gitlab:vo,goCD:"GO_JOB_NAME",googleCloud:Mo,jenkins:Fo,semaphore:"SEMAPHORE",shippable:"SHIPPABLE",teamcity:"TEAMCITY_VERSION",teamfoundation:yo,travis:"TRAVIS",wercker:ko,netlify:"NETLIFY",layerci:"LAYERCI"};function Go(){let{env:e}=process;return(0,g.findKey)(Ho,t=>{if((0,g.isString)(t))return e[t];if((0,g.isFunction)(t))return t()})}var Tr=()=>({appveyor:m(["APPVEYOR_JOB_ID","APPVEYOR_ACCOUNT_NAME","APPVEYOR_PROJECT_SLUG","APPVEYOR_BUILD_NUMBER","APPVEYOR_BUILD_VERSION","APPVEYOR_PULL_REQUEST_NUMBER","APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH"]),azure:m(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID","BUILD_REPOSITORY_URI","SYSTEM_TEAMPROJECT","SYSTEM_COLLECTIONURI"]),awsCodeBuild:m(["CODEBUILD_BUILD_ID","CODEBUILD_BUILD_NUMBER","CODEBUILD_RESOLVED_SOURCE_VERSION","CODEBUILD_SOURCE_REPO_URL","CODEBUILD_SOURCE_VERSION"]),bamboo:m(["bamboo_buildNumber","bamboo_buildResultsUrl","bamboo_planRepository_repositoryUrl","bamboo_buildKey"]),bitbucket:m(["BITBUCKET_REPO_SLUG","BITBUCKET_REPO_OWNER","BITBUCKET_BUILD_NUMBER","BITBUCKET_PARALLEL_STEP","BITBUCKET_STEP_RUN_NUMBER","BITBUCKET_PR_ID","BITBUCKET_PR_DESTINATION_BRANCH","BITBUCKET_PR_DESTINATION_COMMIT"]),buildkite:m(["BUILDKITE_REPO","BUILDKITE_SOURCE","BUILDKITE_JOB_ID","BUILDKITE_BUILD_ID","BUILDKITE_BUILD_URL","BUILDKITE_BUILD_NUMBER","BUILDKITE_PULL_REQUEST","BUILDKITE_PULL_REQUEST_REPO","BUILDKITE_PULL_REQUEST_BASE_BRANCH"]),circle:m(["CIRCLE_JOB","CIRCLE_BUILD_NUM","CIRCLE_BUILD_URL","CIRCLE_PR_NUMBER","CIRCLE_PR_REPONAME","CIRCLE_PR_USERNAME","CIRCLE_COMPARE_URL","CIRCLE_WORKFLOW_ID","CIRCLE_PULL_REQUEST","CIRCLE_REPOSITORY_URL","CI_PULL_REQUEST"]),codeshipBasic:m(["CI_BUILD_ID","CI_REPO_NAME","CI_BUILD_URL","CI_PROJECT_ID","CI_BUILD_NUMBER","CI_PULL_REQUEST"]),codeshipPro:m(["CI_BUILD_ID","CI_REPO_NAME","CI_PROJECT_ID"]),concourse:m(["BUILD_ID","BUILD_NAME","BUILD_JOB_NAME","BUILD_PIPELINE_NAME","BUILD_TEAM_NAME","ATC_EXTERNAL_URL"]),codeFresh:m(["CF_BUILD_ID","CF_BUILD_URL","CF_CURRENT_ATTEMPT","CF_STEP_NAME","CF_PIPELINE_NAME","CF_PIPELINE_TRIGGER_ID","CF_PULL_REQUEST_ID","CF_PULL_REQUEST_IS_FORK","CF_PULL_REQUEST_NUMBER","CF_PULL_REQUEST_TARGET"]),drone:m(["DRONE_JOB_NUMBER","DRONE_BUILD_LINK","DRONE_BUILD_NUMBER","DRONE_PULL_REQUEST"]),githubActions:m(["GITHUB_WORKFLOW","GITHUB_ACTION","GITHUB_EVENT_NAME","GITHUB_RUN_ID","GITHUB_RUN_ATTEMPT","GITHUB_REPOSITORY"]),gitlab:m(["CI_PIPELINE_ID","CI_PIPELINE_URL","CI_BUILD_ID","CI_JOB_ID","CI_JOB_URL","CI_JOB_NAME","GITLAB_HOST","CI_PROJECT_ID","CI_PROJECT_URL","CI_REPOSITORY_URL","CI_ENVIRONMENT_URL","CI_DEFAULT_BRANCH"]),goCD:m(["GO_SERVER_URL","GO_ENVIRONMENT_NAME","GO_PIPELINE_NAME","GO_PIPELINE_COUNTER","GO_PIPELINE_LABEL","GO_STAGE_NAME","GO_STAGE_COUNTER","GO_JOB_NAME","GO_TRIGGER_USER","GO_REVISION","GO_TO_REVISION","GO_FROM_REVISION","GO_MATERIAL_HAS_CHANGED"]),googleCloud:m(["BUILD_ID","PROJECT_ID","REPO_NAME","BRANCH_NAME","TAG_NAME","COMMIT_SHA","SHORT_SHA"]),jenkins:m(["BUILD_ID","BUILD_URL","BUILD_NUMBER","ghprbPullId"]),semaphore:m(["SEMAPHORE_BRANCH_ID","SEMAPHORE_BUILD_NUMBER","SEMAPHORE_CURRENT_JOB","SEMAPHORE_CURRENT_THREAD","SEMAPHORE_EXECUTABLE_UUID","SEMAPHORE_GIT_BRANCH","SEMAPHORE_GIT_DIR","SEMAPHORE_GIT_REF","SEMAPHORE_GIT_REF_TYPE","SEMAPHORE_GIT_REPO_SLUG","SEMAPHORE_GIT_SHA","SEMAPHORE_GIT_URL","SEMAPHORE_JOB_COUNT","SEMAPHORE_JOB_ID","SEMAPHORE_JOB_NAME","SEMAPHORE_JOB_UUID","SEMAPHORE_PIPELINE_ID","SEMAPHORE_PLATFORM","SEMAPHORE_PROJECT_DIR","SEMAPHORE_PROJECT_HASH_ID","SEMAPHORE_PROJECT_ID","SEMAPHORE_PROJECT_NAME","SEMAPHORE_PROJECT_UUID","SEMAPHORE_REPO_SLUG","SEMAPHORE_TRIGGER_SOURCE","SEMAPHORE_WORKFLOW_ID","PULL_REQUEST_NUMBER"]),shippable:m(["SHIPPABLE_BUILD_ID","SHIPPABLE_BUILD_NUMBER","SHIPPABLE_COMMIT_RANGE","SHIPPABLE_CONTAINER_NAME","SHIPPABLE_JOB_ID","SHIPPABLE_JOB_NUMBER","SHIPPABLE_REPO_SLUG","IS_FORK","IS_GIT_TAG","IS_PRERELEASE","IS_RELEASE","REPOSITORY_URL","REPO_FULL_NAME","REPO_NAME","BUILD_URL","BASE_BRANCH","HEAD_BRANCH","IS_PULL_REQUEST","PULL_REQUEST","PULL_REQUEST_BASE_BRANCH","PULL_REQUEST_REPO_FULL_NAME"]),teamcity:null,teamfoundation:m(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID"]),travis:m(["TRAVIS_JOB_ID","TRAVIS_BUILD_ID","TRAVIS_BUILD_WEB_URL","TRAVIS_REPO_SLUG","TRAVIS_JOB_NUMBER","TRAVIS_EVENT_TYPE","TRAVIS_COMMIT_RANGE","TRAVIS_BUILD_NUMBER","TRAVIS_PULL_REQUEST","TRAVIS_PULL_REQUEST_BRANCH","TRAVIS_PULL_REQUEST_SHA"]),wercker:null,netlify:m(["BUILD_ID","CONTEXT","URL","DEPLOY_URL","DEPLOY_PRIME_URL","DEPLOY_ID"]),layerci:m(["LAYERCI_JOB_ID","LAYERCI_RUNNER_ID","RETRY_INDEX","LAYERCI_PULL_REQUEST","LAYERCI_REPO_NAME","LAYERCI_REPO_OWNER","LAYERCI_BRANCH","GIT_TAG"])}),jo=()=>{let{env:e}=process;return{appveyor:{sha:e.APPVEYOR_REPO_COMMIT,branch:e.APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH||e.APPVEYOR_REPO_BRANCH,message:Ao(`
`,e.APPVEYOR_REPO_COMMIT_MESSAGE,e.APPVEYOR_REPO_COMMIT_MESSAGE_EXTENDED),authorName:e.APPVEYOR_REPO_COMMIT_AUTHOR,authorEmail:e.APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL},awsCodeBuild:{sha:e.CODEBUILD_RESOLVED_SOURCE_VERSION,remoteOrigin:e.CODEBUILD_SOURCE_REPO_URL},azure:{sha:e.BUILD_SOURCEVERSION,branch:e.BUILD_SOURCEBRANCHNAME,message:e.BUILD_SOURCEVERSIONMESSAGE,authorName:e.BUILD_SOURCEVERSIONAUTHOR,authorEmail:e.BUILD_REQUESTEDFOREMAIL},bamboo:{sha:e.bamboo_planRepository_revision,branch:e.bamboo_planRepository_branch,authorName:e.bamboo_planRepository_username,remoteOrigin:e.bamboo_planRepository_repositoryURL},bitbucket:{sha:e.BITBUCKET_COMMIT,branch:e.BITBUCKET_BRANCH},buildkite:{sha:e.BUILDKITE_COMMIT,branch:e.BUILDKITE_BRANCH,message:e.BUILDKITE_MESSAGE,authorName:e.BUILDKITE_BUILD_CREATOR,authorEmail:e.BUILDKITE_BUILD_CREATOR_EMAIL,remoteOrigin:e.BUILDKITE_REPO,defaultBranch:e.BUILDKITE_PIPELINE_DEFAULT_BRANCH},circle:{sha:e.CIRCLE_SHA1,branch:e.CIRCLE_BRANCH,authorName:e.CIRCLE_USERNAME,remoteOrigin:e.CIRCLE_REPOSITORY_URL},codeshipBasic:{sha:e.CI_COMMIT_ID,branch:e.CI_BRANCH,message:e.CI_COMMIT_MESSAGE,authorName:e.CI_COMMITTER_NAME,authorEmail:e.CI_COMMITTER_EMAIL},codeshipPro:{sha:e.CI_COMMIT_ID,branch:e.CI_BRANCH,message:e.CI_COMMIT_MESSAGE,authorName:e.CI_COMMITTER_NAME,authorEmail:e.CI_COMMITTER_EMAIL},codeFresh:{sha:e.CF_REVISION,branch:e.CF_BRANCH,message:e.CF_COMMIT_MESSAGE,authorName:e.CF_COMMIT_AUTHOR},drone:{sha:e.DRONE_COMMIT_SHA,branch:e.DRONE_SOURCE_BRANCH,message:e.DRONE_COMMIT_MESSAGE,authorName:e.DRONE_COMMIT_AUTHOR,authorEmail:e.DRONE_COMMIT_AUTHOR_EMAIL,remoteOrigin:e.DRONE_GIT_HTTP_URL,defaultBranch:e.DRONE_REPO_BRANCH},githubActions:{sha:e.GITHUB_SHA,branch:e.GH_BRANCH||e.GITHUB_REF,defaultBranch:e.GITHUB_BASE_REF,remoteBranch:e.GITHUB_HEAD_REF,runAttempt:e.GITHUB_RUN_ATTEMPT},gitlab:{sha:e.CI_COMMIT_SHA,branch:e.CI_COMMIT_REF_NAME,message:e.CI_COMMIT_MESSAGE,authorName:e.GITLAB_USER_NAME,authorEmail:e.GITLAB_USER_EMAIL,remoteOrigin:e.CI_REPOSITORY_URL,defaultBranch:e.CI_DEFAULT_BRANCH},googleCloud:{sha:e.COMMIT_SHA,branch:e.BRANCH_NAME},jenkins:{sha:e.GIT_COMMIT,branch:e.GIT_BRANCH},semaphore:{sha:e.SEMAPHORE_GIT_SHA,branch:e.SEMAPHORE_GIT_BRANCH,remoteOrigin:e.SEMAPHORE_GIT_REPO_SLUG},shippable:{sha:e.COMMIT,branch:e.BRANCH,message:e.COMMIT_MESSAGE,authorName:e.COMMITTER},snap:null,teamcity:null,teamfoundation:{sha:e.BUILD_SOURCEVERSION,branch:e.BUILD_SOURCEBRANCHNAME,message:e.BUILD_SOURCEVERSIONMESSAGE,authorName:e.BUILD_SOURCEVERSIONAUTHOR},travis:{sha:e.TRAVIS_PULL_REQUEST_SHA||e.TRAVIS_COMMIT,branch:e.TRAVIS_PULL_REQUEST_BRANCH||e.TRAVIS_BRANCH,message:e.TRAVIS_COMMIT_MESSAGE},wercker:null,netlify:{sha:e.COMMIT_REF,branch:e.BRANCH,remoteOrigin:e.REPOSITORY_URL},layerci:{sha:e.GIT_COMMIT,branch:e.LAYERCI_BRANCH,message:e.GIT_COMMIT_TITLE}}},Sr=e=>{let t=Or();return t?(0,g.chain)(e()).get(t).value():{}};function $o(){return(0,g.chain)(Tr()).omitBy(g.isNull).keys().value()}function Or(){let e=Go();return X("detected CI provider name: %s",e),e||null}function Vo(){return Sr(Tr)}function Ur(){return Sr(jo)}function Wo(e){return e&&$o().includes(e)}function Lr(e){let t=Vo(),r=Or(),n=Ko(e,r);return X("detected CI provider: %s",r),X("detected CI params: %O",t),X("detected CI build ID: %o",n),{params:t,provider:r,ciBuildId:n}}function Ko(e,t){return e?{source:"user",value:e}:Wo(t)?{source:"server",value:null}:{source:"random",value:`auto:${L()}`}}o();var br=require("@currents/commit-info"),yr=require("lodash");o();var Z=require("lodash");E();var ke=p.extend("ci-git");function Ar(e){ke("git commit existing info: %O",e);let t=Ur();ke("commit info from provider environment variables: %O",t);let r=(0,Z.transform)(e,(n,s,a)=>{let u=s||(t?t[a]:null);return n[a]=(0,Z.defaultTo)(u,null)});return ke("combined git and environment variables from provider: %O",r),r}var Yo=async()=>{let e=await(0,br.commitInfo)();return Ar({branch:e.branch,remoteOrigin:e.remote,authorEmail:e.email,authorName:e.author,message:e.message,sha:e.sha,ghaEventData:e.ghaEventData})},Dr=(0,yr.memoize)(Yo);o();var Pr=require("@babel/code-frame"),Nr=c(require("chalk")),He=c(require("fs")),N=c(require("path")),xr=c(require("stack-utils")),Br=c(require("url"));function Jo(e){let t=e.split(`
`),r=t.findIndex(u=>u.startsWith("    at "));r===-1&&(r=t.length);let n=t.slice(0,r).join(`
`),s=t.slice(r),a;for(let u of s){let{frame:_,fileName:A}=Xo(u);if(!(!_||!A)&&!qo(A)){a={file:A,column:_.column||0,line:_.line||0};break}}return{message:n,stackLines:s,location:a}}function qo(e){return e.includes(`${N.default.sep}node_modules${N.default.sep}`)}function Qo(e,t){return N.default.relative(e.rootDir,t)||N.default.basename(t)}function wr(e,t,r,n){let s=t.stack,a=[],u;if(s){let _=Jo(s);if(a.push(_.message),u=_.location,u)if(!t.snippet&&(!n||He.default.realpathSync(n)!==u.file)&&(a.push(""),a.push(Nr.default.gray("   at ")+`${Qo(e,u.file)}:${u.line}`)),a.push(""),t.snippet)a.push(t.snippet);else try{let A=He.default.readFileSync(u.file,"utf8"),zr=(0,Pr.codeFrameColumns)(A,{start:u},{highlightCode:r});a.push(zr)}catch{}a.push(""),a.push(_.stackLines.join(`
`))}else t.message?a.push(t.message):t.value&&a.push(t.value);return{location:u,message:a.join(`
`)}}var zo=new xr.default;function Xo(e){let t=zo.parseLine(e);if(!t)return{frame:null,fileName:null};let r=null;return t.file&&(r=t.file.startsWith("file://")?Br.default.fileURLToPath(t.file):N.default.resolve(process.cwd(),t.file)),{frame:t,fileName:r}}Se();o();var en=c(require("fs")),Mr=require("path");y();E();o();var ee=c(require("fs")),Zo=require("tmp-promise");function vr(e){try{let t=ee.readFileSync(e,"utf-8");return JSON.parse(t)}catch{return null}}var te=p.extend("last-failed"),tn=".last-run.json";function Fr(e){let t=Q(e);if(!t?.cliLastFailed&&!t?.testIdMatcher)return te("CLI last failed option is not enabled. Skipping retrieval of last run data."),null;let r=(t.projects??[]).reduce((s,{project:a})=>(a.name&&a.outputDir&&(s[a.name]=a.outputDir),s),{});if(Object.keys(r).length===0)return te("No projects with outputDir found. Skipping retrieval."),null;let n=Object.entries(r).map(([s,a])=>{let u=(0,Mr.join)(a,tn),_=vr(u);return _||te("No last run data found for project %s",s),{project:s,path:u,data:_}});return te("Last run data retrieved: %O",n),n}Pe();o();o();var on=require("lodash");o();var re=c(require("path"));function kr(e,t){return rn(re.default.relative(t,e.file))}function rn(e){return e.split(re.default.sep).join(re.default.posix.sep)}function Ge(e){let t=e.titlePath(),r=Hr(e).title;return t.slice(t.indexOf(r)+1,t.length)}function Hr(e){let t=e.parent;for(;t.parent?.location;)t=t.parent;return t}function Gr(e,t){let r=Hr(e).location;return kr(r,t.rootDir)}function jr(e){return e.id??e._id}function $r(e){if(e._only)return!0;let t=e.parent;for(;t.parent;){if(t._only)return!0;t=t.parent}return!1}function oe(e){if(!e)return"__currents_no_project__";let r=("__projectId"in e?e.__projectId:"").trim(),n=e.name.trim()?r:`project${r?`-0${r}`:""}`;if(n.length>256)throw new Error(`Project name is too long for ${n}`);return n}function Vr(e,t){return e.suites.map(r=>{let n=t.projects.find(s=>s.name===r.title);return{name:oe(r.project()),tags:(n?.metadata?.pwc?.tags??[]).map(s=>s.trim()),tests:nn(r,t)}})}function nn(e,t){let r=e.allTests().map(n=>({isOnly:$r(n),title:Ge(n),spec:Gr(n,t),tags:sn(n),testId:jr(n)}));return r.some(n=>n.isOnly)?r.filter(n=>n.isOnly):r}function sn(e){let t=(Ge(e).join(" ").match(/@(\S+)/g)??[]).filter(Boolean).map(r=>r);return Array.from(new Set([...t,...e.tags??[]].map(r=>r.trim()).map(r=>r.replace("@",""))))}S();De();o();o();var Kr=c(require("ws"));E();var Wr=p.extend("ws"),x=null;function je(e){x&&x.send(JSON.stringify(e))}function Yr(){x&&x.close()}async function Jr(e){Wr("setting port to %s",e),await new Promise(t=>{x=new Kr.default(`ws://localhost:${e}`),x.on("open",()=>{Wr("ws opened"),t(null)})})}o();var an=c(require("http"));E();var un=c(require("lil-http-terminator")),qr=require("ts-pattern"),ln=c(require("ws")),ka=p.extend("wss");o();Oe();var ne=class{async create(t){return D({url:"/orchestration",method:"POST",data:JSON.stringify(t)})}async createTask(t){return D({url:`/orchestration/${t.id}/task`,method:"POST",data:JSON.stringify({machineId:t.machineId,runId:t.runId})})}async resetRun(t){return D({url:`/runs/v1/${t.runId}/reset`,method:"PUT",data:JSON.stringify(t)})}};o();var $e=c(require("pluralize"));y();ue();S();var se=class{constructor(t,r,n=b()){this.pwConfig=t;this.suite=r;this.currentsConfig=n}getIntro(t){return[`\u{1F4E6} Currents reporter: ${f([`${fe(k)}`,t.ciBuildId?`  - ci build id: ${t.ciBuildId}`:null,`  - project id: ${this.currentsConfig?.projectId}`,`  - orchestration id: ${t.sessionId}`,t.machineId?`  - machine id: ${t.machineId}`:null].filter(Boolean).join(`
`))}`,[`\u{1F3AD} Playwright: ${f([`${fe(this.pwConfig.version)}`,`${this.suite.allTests().length} ${(0,$e.default)("test",this.suite.allTests().length)} in ${this.suite.suites.length} ${(0,$e.default)("project",this.suite.suites.length)} [${this.suite.suites.map(r=>oe(r.project())).join(", ")}]`,this.pwConfig.shard?["shard",`${this.pwConfig.shard.current}/${this.pwConfig.shard.total}`].join(" "):null].filter(r=>r).join(" "))} `].filter(r=>r).join(" | ")].join(`
`)}};var M=p.extend("orchestration-reporter"),ie=class{constructor(t){this.pwConfig=null;this.pwSuite=null;this.lastRunData=null;this.fullSuite=null;this.printer=null;this.remoteDebug=K.factory("or8n"),this.configLoader=new z(t).start()}printsToStdio(){return!0}onBegin(t,r){Bt(t.version),this.configLoader.waitSync(),M("Starting orchestration discovery"),this.pwConfig=t,this.pwSuite=r,mr(t),M("Discovering test suite config: %O",t),this.fullSuite=Vr(this.pwSuite,t),M("Full suite response %O",this.fullSuite),this.printer=new se(t,r),this.lastRunData=Fr(t)}onError(t){C(`Global error reported by test runner:
%s`,wr(this.pwConfig,t,!0).message)}async onEnd(){if(this.pwConfig?.projects.forEach(u=>{if(!u.name)throw new Error("currents panic: playwright projects must have a name for orchestration")}),!this.fullSuite)throw new Error("currents panic: cannot detect full test suite");let t=b();if(!process.env.CURRENTS_PWCP_DRY_RUN){let u=parseInt(process.env.CURRENTS_PWCP_WSS_PORT);await Jr(u)}let r=await Dr(),n=Lr(t?.ciBuildId);if(n.ciBuildId.source==="random")throw C(`Currents failed to detect CI build ID for this environment. Please use one of the following to set CI build ID:
  
- use environment variable: ${f(J("ciBuildId"))}
- as CLI flag of pwc command: ${f(q("ciBuildId"))}
- as reporter configuration option ${f("ciBuildId")} in ${f("playwright.config.ts")}

\u{1F4D6} ${v.guide.ciBuildId}
\u{1F4D6} ${v.guide.integration}
    `),new Error("We could not determine a unique CI Build ID");this.fullSuite.flatMap(u=>u.tests).length===0&&(me(),d("No tests detected"),me());let s={ci:n,suite:this.fullSuite,commit:r,clientId:(0,Qr.nanoid)(),config:Er(this.pwConfig),projectId:t?.projectId,ciBuildId:n.ciBuildId.value,recordKey:t?.recordKey,machineId:t?.machineId},a=new ne;if(O("\u{1F680} Starting orchestration session..."),process.env.CURRENTS_PWCP_DRY_RUN){console.log("Dry run enabled, skipping orchestration creation");return}try{let{data:u}=await a.create(s);O(this.printer.getIntro({sessionId:u.id,ciBuildId:n.ciBuildId.value,machineId:u.machineId})),process.env.CURRENTS_PWCP_DRY_RUN||await je({type:"discovery:creation-success",payload:{...u,cliArgs:this.pwConfig?Q(this.pwConfig)?.cliArgs:null,suite:this.fullSuite,lastRunData:this.lastRunData}})}catch(u){O(this.printer.getIntro({sessionId:void 0,machineId:null,ciBuildId:n.ciBuildId.value})),C("Could not create new orchestration session"),await je({type:"discovery:creation-failure",payload:u})}finally{M("Discovery done"),await Yr(),M("WS closed"),await this.remoteDebug.finalize()}}};var cn=ie;
/*! For license information please see index.js.LEGAL.txt */
//# sourceMappingURL=index.js.map